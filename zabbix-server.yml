---
- hosts: all
  become: yes
  remote_user: centos
  vars:
    aurora_ep: rewse-aurora-cluster.cluster-c8xun5aepybs.ap-northeast-1.rds.amazonaws.com
    zabbix_version: 3.2.2
  tasks:
    - name: install additional packages
      yum:
        name: "{{item}}"
        state: installed
      with_items:
        - mod_ssl
        - zabbix-server-mysql
        - zabbix-web-mysql
      notify: restart httpd

    - name: enable zabbix-server
      service:
        name: zabbix-server
        enabled: yes
      notify: restart zabbix-server

    - name: enable httpd
      service:
        name: httpd
        enabled: yes
      notify: restart httpd

    - name: check databases
      shell: echo "show databases;" | mysql -u{{admin_username}} -p{{aurora_password}} -h{{aurora_ep}}
      register: check_databases_res
      changed_when: False

    - name: create database
      shell: echo "create database zabbix character set utf8 collate utf8_bin; grant all privileges on zabbix.* to zabbix identified by '{{aurora_zabbix_password}}';" | mysql -u{{admin_username}} -p{{aurora_password}} -h{{aurora_ep}}
      when: check_databases_res.stdout.find('zabbix') == -1

    - name: check tables
      shell: echo "show tables;" | mysql -u{{admin_username}} -p{{aurora_password}} -h{{aurora_ep}} zabbix
      register: check_tables_res
      changed_when: False

    - name: init database
      shell: zcat /usr/share/doc/zabbix-server-mysql-{{zabbix_version}}/create.sql.gz | mysql -uzabbix -p{{aurora_zabbix_password}} -h{{aurora_ep}} zabbix
      when: check_tables_res.stdout.find('Tables_in_zabbix') == -1

    - name: set DBHost
      lineinfile:
        dest: /etc/zabbix/zabbix_server.conf
        insertafter: '^# DBHost='
        regexp: '^DBHost='
        line: 'DBHost={{aurora_ep}}'
      notify: restart zabbix-server

    - name: set DBPassword
      lineinfile:
        dest: /etc/zabbix/zabbix_server.conf
        insertafter: '^# DBPassword='
        regexp: '^DBPassword='
        line: 'DBPassword={{aurora_zabbix_password}}'
      notify: restart zabbix-server

    - name: set Timeout
      lineinfile:
        dest: /etc/zabbix/zabbix_server.conf
        insertafter: '^# Timeout='
        regexp: '^Timeout='
        line: 'Timeout=20'
      notify: restart zabbix-server

    - name: set php_value
      lineinfile:
        dest: /etc/httpd/conf.d/zabbix.conf
        insertafter: '# php_value date.timezone'
        regexp: '^ *php_value date.timezone'
        line: '        php_value date.timezone Asia/Tokyo'
      notify: restart httpd

    - name: create zaibbx-web conf
      blockinfile:
        dest: /etc/zabbix/web/zabbix.conf.php
        content: |
          <?php
          // Zabbix GUI configuration file.
          global $DB;

          $DB['TYPE']     = 'MYSQL';
          $DB['SERVER']   = '{{aurora_ep}}';
          $DB['PORT']     = '0';
          $DB['DATABASE'] = 'zabbix';
          $DB['USER']     = 'zabbix';
          $DB['PASSWORD'] = '{{aurora_zabbix_password}}';

          $ZBX_SERVER      = 'zabbix.rewse.jp';
          $ZBX_SERVER_PORT = '10051';
          $ZBX_SERVER_NAME = '';

          $IMAGE_FORMAT_DEFAULT = IMAGE_FORMAT_PNG;
        create: yes
        owner: apache
        group: apache
        mode: 0640

  handlers:
    - name: restart httpd
      service:
        name: httpd
        state: restarted

    - name: reload httpd
      service:
        name: httpd
        state: reloaded

    - name: restart zabbix-server
      service:
        name: zabbix-server
        state: restarted
