---
- hosts: centos
  become: yes
  remote_user: centos
  vars:
    mysql_release_filename: mysql57-community-release-el7-9.noarch.rpm
    mysql_community_ini_section: mysql57_community
    oracle_instantcelint_basic: oracle-instantclient12.1-basic-12.1.0.2.0-1.x86_64.rpm
    oracle_instantclient_sqlplus: oracle-instantclient12.1-sqlplus-12.1.0.2.0-1.x86_64.rpm
    postgersql_jdbc_filename: postgresql-9.4.1212.jar
    redshift_jdbc_filename: RedshiftJDBC42-1.2.1.1001.jar
  vars_files:
    - gitignored_vars.yml
  tasks:
    - name: install mysql57-community-release
      yum:
        name: http://repo.mysql.com/{{mysql_release_filename}}
        state: installed
      tags: [mysql, package]

    - name: add priority into /etc/yum.repos.d/mysql-community.repo
      ini_file:
        dest: /etc/yum.repos.d/mysql-community.repo
        section: "{{item}}"
        option: priority
        value: 30
        no_extra_spaces: True
      with_items:
        - mysql-connectors-community
        - mysql-tools-community
        - "{{mysql_community_ini_section}}"
      tags: [mysql, package]

    - name: install mysql client
      yum:
        name: "{{item}}"
        state: installed
      with_items:
        - mysql-community-client
        - mysql-connector-java
      tags: [client, mysql]

      # Download the files before the following task
      # from <http://www.oracle.com/technetwork/topics/linuxx86-64soft-092277.html>
    - name: copy oracle-instantcelint
      copy:
        src: ~/Downloads/{{item}}
        dest: /usr/local/src
      with_items:
        - "{{oracle_instantcelint_basic}}"
        - "{{oracle_instantclient_sqlplus}}"
      tags: [client, oracle]

    - name: install oracle-instantcelint
      yum:
        name: "{{item}}"
        state: installed
      with_items:
        - rlwrap
        - /usr/local/src/{{oracle_instantcelint_basic}}
        - /usr/local/src/{{oracle_instantclient_sqlplus}}
      tags: [client, oracle]

    - name: create symlink for ojdbc.jar
      file:
        src: /usr/lib/oracle/12.1/client64/lib/{{item}}
        dest: /usr/share/java/{{item}}
        state: link
      with_items:
        - ojdbc6.jar
        - ojdbc7.jar
      tags: [client, oracle]

    - name: clone orascript.git
      git:
        repo: git@github.com:rewse/orascript.git
        dest: /srv/git/orascript
        accept_hostkey: yes
        key_file: /home/{{admin_username}}/.ssh/id_rsa
      tags: [client, oracle]

    - name: change mode of git/orascript
      file:
        path: /srv/git/orascript
        owner: "{{admin_username}}"
        group: "{{admin_username}}"
        recurse: yes
      tags: [client, oracle]

    - name: copy orarc
      copy:
        src: /srv/git/orascript/orarc
        dest: /home/{{admin_username}}/.orarc
        remote_src: True
      tags: [client, oracle]

    - name: create symlink for orascript/common
      file:
        src: /srv/git/orascript/common
        dest: /home/{{admin_username}}/oracle
        state: link
      tags: [client, oracle]

    - name: install postgresql client
      yum:
        name: "{{item}}"
        state: installed
      with_items:
        - postgresql
      tags: [client, postgresql]

    - name: install postgresql jdbc driver
      get_url:
        url: https://jdbc.postgresql.org/download/{{postgersql_jdbc_filename}}
        dest: /usr/share/java
      tags: [client, postgresql]

    - name: create symlinks postgresql.jar
      file:
        src: "{{postgersql_jdbc_filename}}"
        dest: /usr/share/java/postgresql.jar
        state: link
      tags: [client, postgresql]

    - name: create symlinks from postgresql.jar
      file:
        src: postgresql.jar
        dest: /usr/share/java/{{item}}
        state: link
      with_items:
        - postgresql.jre7.jar
        - postgresql.jre6.jar
      tags: [client, postgresql]

    - name: install redshift jdbc driver
      get_url:
        url: https://s3.amazonaws.com/redshift-downloads/drivers/{{redshift_jdbc_filename}}
        dest: /usr/share/java
      tags: [client, redshift]

    - name: create symlink RedShiftJDBC.jar
      file:
        src: "{{redshift_jdbc_filename}}"
        dest: /usr/share/java/RedshiftJDBC.jar
        state: link
      tags: [client, redshift]

    - name: create symlinks from RedshiftJDBC.jar
      file:
        src: RedshiftJDBC.jar
        dest: /usr/share/java/{{item}}
        state: link
      with_items:
        - RedshiftJDBC42.jar
        - RedshiftJDBC41.jar
        - RedshiftJDBC4.jar
      tags: [client, redshift]
