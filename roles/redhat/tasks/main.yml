---
- name: set timezone
  timezone:
    name: Asia/Tokyo
  tags: [redhat, time]

- name: check swap status
  command: cat /proc/swaps
  register: swaps_out
  changed_when: False
  tags: [redhat, storage, swap]

- name: make swap
  command: mkswap /dev/{{swap_device_name}}
  when: swap_device_name not in swaps_out.stdout
  tags: [redhat, storage, swap]

- name: enable swap
  command: swapon /dev/{{swap_device_name}}
  when: swap_device_name not in swaps_out.stdout
  tags: [redhat, storage, swap]

- name: add swap into fstab
  mount:
    name: swap
    src: /dev/{{swap_device_name}}
    fstype: swap
    opts: default
    state: present
  tags: [redhat, storage, swap]

- name: get enforce
  command: getenforce
  register: getenforce_out
  changed_when: False
  tags: [redhat, selinux]

- name: set enforce to 0
  command: setenforce 0
  when: "'Disabled' not in getenforce_out.stdout"
  tags: [redhat, selinux]

- name: disable selinux
  selinux:
    state: disabled
  tags: [redhat, selinux]

- name: enable yum channels
  command: yum-config-manager --enable rhui-REGION-rhel-server-extras rhui-REGION-rhel-server-optional rhui-REGION-rhel-server-supplementary
  tags: [redhat, package]

- name: install additional packages
  yum:
    name:
      - "@Development tools"
      - at
      - bash-completion
      - bc
      - bind-utils
      - dstat
      - "{{epel_release_url}}"
      - firewalld
      - git
      - logwatch
      - lsof
      - mlocate
      - net-tools
      - nfs-utils
      - patch
      - perl-libwww-perl
      - prelink
      - source-highlight
      - sysstat
      - telnet
      - tmux
      - tree
      - unzip
      - vim-enhanced
      - yum-cron
      - yum-plugin-priorities
    state: installed
  tags: [redhat, package]

- name: install additional packages from EPEL
  yum:
    name: etckeeper
    state: installed
  tags: [redhat, epel, package]

- name: download get-pip.py
  get_url:
    url: https://bootstrap.pypa.io/get-pip.py
    dest: /tmp
  tags: [redhat, package, pip]

- name: run get-pip.py
  command: python /tmp/get-pip.py
  tags: [redhat, package, pip]

- name: install packages with pip
  pip:
    name:
      - awscli
  tags: [redhat, package, pip]

- name: update all packages
  yum:
    name: '*'
    state: latest
  tags: [redhat, package]

- name: etckeeper; init /etc
  command: etckeeper init
  args:
      creates: /etc/.git
  tags: [redhat, etckeeper]

- name: etckeeper; Initial commit
  command: etckeeper commit "Initial commit"
  args:
    chdir: /etc
    creates: /etc/.git/logs
  tags: [redhat, etckeeper]

- name: add priority into /etc/yum.repos.d/redhat-rhui.repo
  ini_file:
    dest: /etc/yum.repos.d/redhat-rhui.repo
    section: "{{item}}"
    option: priority
    value: "10"
    no_extra_spaces: True
  with_items:
    - rhui-REGION-rhel-server-releases
    - rhui-REGION-rhel-server-extras
    - rhui-REGION-rhel-server-optional
    - rhui-REGION-rhel-server-rh-common
    - rhui-REGION-rhel-server-supplementary
  tags: [redhat, package]

- name: add priority into /etc/yum.repos.d/redhat-rhui-client-config.repo
  ini_file:
    dest: /etc/yum.repos.d/redhat-rhui-client-config.repo
    section: "{{item}}"
    option: priority
    value: "10"
    no_extra_spaces: True
  with_items:
    - rhui-REGION-client-config-server-7
  tags: [redhat, package]

- name: add priority into /etc/yum.repos.d/epel.repo
  ini_file:
    dest: /etc/yum.repos.d/epel.repo
    section: "{{item}}"
    option: priority
    value: "50"
    no_extra_spaces: True
  with_items:
    - epel
  tags: [redhat, package]

- name: set hostname
  command: hostnamectl set-hostname {{inventory_hostname}}
  tags: [redhat, hostname]

- name: disable the unnecessary services
  service:
    name: "{{item}}"
    enabled: no
    state: stopped
  with_items:
    - firewalld
    - kdump
    - sysstat
  tags: [redhat, package]

- name: postfix; change myorigin
  lineinfile:
    dest: /etc/postfix/main.cf
    insertafter: '^#myorigin '
    regexp: '^myorigin '
    line: 'myorigin = rewse.jp'
  notify: reload postfix
  tags: [redhat, postfix]

- name: postfix; change relayhost
  lineinfile:
    dest: /etc/postfix/main.cf
    insertafter: '^#relayhost '
    regexp: '^relayhost '
    line: 'relayhost = [{{relayhost.name}}]:{{relayhost.port}}'
  notify: reload postfix
  tags: [redhat, postfix]

- name: postfix; set smtp_sasl_auth_enable
  lineinfile:
    dest: /etc/postfix/main.cf
    regexp: '^smtp_sasl_auth_enable '
    line: 'smtp_sasl_auth_enable = yes'
  notify: reload postfix
  tags: [redhat, postfix]

- name: postfix; set smtp_sasl_password_maps
  lineinfile:
    dest: /etc/postfix/main.cf
    regexp: 'smtp_sasl_password_maps '
    line: 'smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd'
  notify: reload postfix
  tags: [redhat, postfix]

- name: postfix; set smtp_sasl_security_options
  lineinfile:
    dest: /etc/postfix/main.cf
    regexp: 'smtp_sasl_security_options '
    line: 'smtp_sasl_security_options = noplaintext, noanonymous'
  notify: reload postfix
  tags: [redhat, postfix]

- name: postfix; create sasl_passwd
  lineinfile:
    dest: /etc/postfix/sasl_passwd
    regexp: '^\[{{relayhost.name}}\]:{{relayhost.port}}'
    line: '[{{relayhost.name}}]:{{relayhost.port}} {{so_net.username}}:{{so_net.password}}'
    create: yes
    mode: 0600
  register: postfix_sasl_password_out
  tags: [redhat, postfix]

- name: postfix; create sasl_passwd.db
  file:
    path: /etc/postfix/sasl_passwd.db
    state: touch
    mode: 0600
  tags: [redhat, postfix]

- name: postfix; hash sasl_passwd
  command: postmap hash:/etc/postfix/sasl_passwd
  when: postfix_sasl_password_out is changed
  notify: reload postfix
  tags: [redhat, postfix]

- name: install sasl packages
  yum:
    name:
      - cyrus-sasl-md5
      - cyrus-sasl-plain
    state: installed
  notify: restart postfix
  tags: [redhat, postfix]

- name: write root mail alias
  lineinfile:
    dest: /etc/aliases
    insertbefore: '^# Basic '
    line: 'root: "|/usr/sbin/sendmail -oi -f {{vault_email.secondary_from}} {{vault_email.secondary}}"'
  tags: [redhat, postfix, aliases]

- name: enable mail alias
  command: newaliases
  tags: [redhat, postfix, aliases]

- name: anacron; change start_hours_range
  lineinfile:
    dest: /etc/anacrontab
    insertafter: '^#START_HOURS_RANGE'
    regexp: '^START_HOURS_RANGE'
    line: 'START_HOURS_RANGE=3-7'
  tags: [redhat, anacron]

- name: cloud-init; add preserve_hostname
  lineinfile:
    dest: /etc/cloud/cloud.cfg
    insertbefore: '^# vim:syntax'
    regexp: '^preserve_hostname'
    line: 'preserve_hostname: true'
  tags: [redhat, cloud-init]

- name: copy profile.d/pathmunge.sh
  copy:
    src: pathmunge.sh
    dest: /etc/profile.d
  tags: [redhat, bash]

- name: input; set editing-mode to vi
  lineinfile:
    dest: /etc/inputrc
    regexp: 'set editing-mode '
    line: 'set editing-mode vi'
  tags: [redhat, input]

- name: create journal dir
  file:
    path: /var/log/journal
    state: directory
    group: systemd-journal
    mode: 02755
  tags: [redhat, journal]

- name: logwatch; disable all services
  lineinfile:
    dest: /usr/share/logwatch/default.conf/logwatch.conf
    insertbefore: '^# You can also disable'
    regexp: '^#? ?Service = All'
    line: '# Service = All'
  tags: [redhat, logwatch]

- name: logwatch; enable yum
  lineinfile:
    dest: /usr/share/logwatch/default.conf/logwatch.conf
    insertafter: '^#Service = pam'
    regexp: '^Service = yum'
    line: 'Service = yum'
  tags: [redhat, logwatch]

- name: rsyslog; add a template
  copy:
    src: 00-template.conf
    dest: /etc/rsyslog.d
  notify: restart rsyslog
  tags: [redhat, rsyslog]

  # See also "Bug 1072368 - user manager message flood"
  # <https://bugzilla.redhat.com/show_bug.cgi?id=1072368>. Do not use
  # <https://access.redhat.com/solutions/1564823> because it's not enough.
- name: rsyslog; ignore systemd-logind
  copy:
    src: systemd-logind.conf
    dest: /etc/rsyslog.d
  notify: restart rsyslog
  tags: [redhat, rsyslog]

- name: rsyslog; move to /var/log/trash.log
  copy:
    src: trash.conf
    dest: /etc/rsyslog.d
  notify: restart rsyslog
  tags: [redhat, rsyslog]

- name: logrotate; config for /var/log/trash.log
  copy:
    src: trash
    dest: /etc/logrotate.d
  tags: [redhat, logrotate]

- name: ssh; change ClientAliveInterval
  lineinfile:
    dest: /etc/ssh/sshd_config
    insertafter: '^#ClientAliveInterval'
    regexp: '^ClientAliveInterval'
    line: 'ClientAliveInterval 59'
  notify: restart sshd
  tags: [redhat, ssh]

- name: ssh; change ServerAliveInterval
  lineinfile:
    dest: /etc/ssh/ssh_config
    regexp: '^.*ServerAliveInterval'
    line: '  ServerAliveInterval 59'
  tags: [redhat, ssh]

- name: add NTP servers
  lineinfile:
    dest: /etc/chrony.conf
    regexp: '^server 169.254.169.123 prefer iburst'
    line: 'server 169.254.169.123 prefer iburst'
  notify: restart chronyd
  tags: [redhat, time, chrony]

- name: yum-cron; enable auto-update
  ini_file:
    dest: /etc/yum/yum-cron.conf
    section: commands
    option: apply_updates
    value: "yes"
  notify: restart yum-cron
  tags: [redhat, yum-cron]

- name: yum-cron; enable yum-cron
  service:
    name: yum-cron
    enabled: yes
  notify: restart yum-cron
  tags: [redhat, yum-cron]

- name: add a group for admin user
  group:
    name: "{{admin}}"
    gid: 1001
  tags: [redhat, user]

- name: add admin user
  user:
    name: "{{admin}}"
    uid: 1001
    group: "{{admin}}"
    groups: 'adm,wheel,systemd-journal'
    skeleton: /etc/skel
  tags: [redhat, user]

- name: allow sudo to admin user
  lineinfile:
    dest: /etc/sudoers.d/00-{{admin}}
    regexp: '^{{admin}}'
    line: '{{admin}} ALL=(ALL) NOPASSWD: ALL'
    create: yes
    mode: 0440
    validate: 'visudo -cf %s'
  tags: [redhat, user]

- name: make .ssh dir for admin user
  file:
    path: /home/{{admin}}/.ssh
    owner: "{{admin}}"
    group: "{{admin}}"
    state: directory
    mode: 0700
  tags: [redhat, user]

- name: copy authorized_keys
  copy:
    src: /home/ec2-user/.ssh/authorized_keys
    dest: /home/{{admin}}/.ssh/authorized_keys
    remote_src: True
    owner: "{{admin}}"
    group: "{{admin}}"
    mode: 0600
  tags: [redhat, user]

- name: copy id_rsa
  become_user: "{{admin}}"
  copy:
    src: ~/.ssh/id_rsa
    dest: /home/{{admin}}/.ssh/id_rsa
    mode: 0600
    follow: yes
  tags: [redhat, user]

- name: copy id_rsa.pub
  become_user: "{{admin}}"
  copy:
    src: ~/.ssh/id_rsa.pub
    dest: /home/{{admin}}/.ssh/id_rsa.pub
    follow: yes
  tags: [redhat, user]

- name: clone dotfiles.git
  git:
    repo: git@github.com:rewse/dotfiles.git
    dest: /srv/git/dotfiles
    accept_hostkey: yes
    key_file: /home/{{admin}}/.ssh/id_rsa
  tags: [redhat, dotfiles]

- name: change mode of git/dotfiles
  file:
    path: /srv/git/dotfiles
    owner: "{{admin}}"
    group: "{{admin}}"
    recurse: yes
  tags: [redhat, dotfiles, bash, git, tmux, vim]

- name: copy bash_profile
  copy:
    src: /srv/git/dotfiles/bash_profile
    dest: /etc/profile.d/bash_profile.sh
    remote_src: True
  tags: [redhat, dotfiles, bash]

- name: copy bashrc
  copy:
    src: /srv/git/dotfiles/bashrc
    dest: /etc/profile.d/bashrc.sh
    remote_src: True
  tags: [redhat, dotfiles, bash]

- name: copy gitconfig
  become_user: "{{admin}}"
  copy:
    src: /srv/git/dotfiles/gitconfig
    dest: /home/{{admin}}/.gitconfig
    remote_src: True
  tags: [redhat, dotfiles, git]

- name: git; set user email
  become_user: "{{admin}}"
  ini_file:
    dest: /home/{{admin}}/.gitconfig
    section: user
    option: email
    value: "{{email.primary}}"
  tags: [redhat, dotfiles, git]

- name: tmux; copy tmux.conf
  copy:
    src: /srv/git/dotfiles/tmux.conf
    dest: /etc/tmux.conf
    remote_src: True
  tags: [redhat, dotfiles, tmux]

- name: vim; copy vimfiles
  copy:
    src: /srv/git/dotfiles/vim/{{item}}
    dest: /usr/share/vim/vimfiles/{{item}}
    remote_src: True
  with_items:
    - vimrc
  tags: [redhat, dotfiles, vim]

- name: vim; add to import vimrc
  lineinfile:
    dest: /etc/vimrc
    line: 'source /usr/share/vim/vimfiles/vimrc'
  tags: [redhat, dotfiles, vim]