---
- name: Install zabbix-release
  apt:
    deb: https://repo.zabbix.com/zabbix/5.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_5.0-1+focal_all.deb
  when: "ansible_lsb.id == 'Ubuntu'"
  tags: [zabbix-agent-debian, package]

- name: Install zabbix-release
  apt:
    deb: https://repo.zabbix.com/zabbix/5.0/raspbian/pool/main/z/zabbix-release/zabbix-release_5.0-1+buster_all.deb
  when: "ansible_lsb.id == 'Raspbian'"
  tags: [zabbix-agent-debian, package]

- name: Install zabbix agent
  apt:
    name:
      - zabbix-agent
      - zabbix-sender
    update_cache: yes
  tags: [zabbix-agent-debian, package]

- name: Set zabbix server
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.conf
    regexp: "Server="
    line: "Server={{ zabbix_server_name }}"
  notify: Restart zabbix-agent
  tags: [zabbix-agent-debian]

- name: Set zabbix server active
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.conf
    regexp: "ServerActive="
    line: "ServerActive={{ zabbix_server_name }}"
  notify: Restart zabbix-agent
  tags: [zabbix-agent-debian]

- name: Set hostname
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.conf
    regexp: "Hostname="
    line: "Hostname={{ ansible_nodename }}"
  notify: Restart zabbix-agent
  tags: [zabbix-agent-debian]

- name: Set Timeout
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.conf
    insertafter: "^# Timeout="
    regexp: "^Timeout="
    line: "Timeout=30"
  notify: Restart zabbix-agent
  tags: [zabbix-agent-debian]

- name: Copy debian.conf
  copy:
    src: debian.conf
    dest: /etc/zabbix/zabbix_agentd.d
  notify: Restart zabbix-agent
  tags: [zabbix-agent-debian]

- name: Remove userparameter_mysql.conf
  file:
    path: /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf
    state: absent
  notify: Restart zabbix-agent
  tags: [zabbix-agent-debian]

- name: Add zabbix to adm group
  user:
    name: zabbix
    groups: 'zabbix,adm'
  notify: Restart zabbix-agent
  tags: [zabbix-agent-debian]

- name: Make agentscripts dir
  file:
    path: /usr/lib/zabbix/agentscripts
    state: directory
  tags: [zabbix-agent-debian]