---
- name: Install additional packages
  apt:
    name:
      - python3-bs4
      - python3-selenium
  tags: [zabbix-smarthome-enecoq, package]

- name: Clone enecoq.git
  git:
    repo: git@github.com:rewse/enecoq.git
    dest: /srv/git/enecoq
    accept_hostkey: yes
    key_file: /home/{{ admin }}/.ssh/id_rsa
  tags: [zabbix-smarthome-enecoq]

- name: Copy enecoq
  copy:
    src: /srv/git/enecoq/enecoq
    dest: /usr/local/bin/
    mode: 0755
    remote_src: yes
  tags: [zabbix-smarthome-enecoq]

- name: Copy enecoq.sh
  template:
    src: enecoq.sh.j2
    dest: /usr/lib/zabbix/agentscripts/enecoq.sh
    group: zabbix
    mode: 0750
    variable_start_string: "[%"
    variable_end_string: "%]"
  tags: [zabbix-smarthome-enecoq]

- name: Copy enecoq.conf
  copy:
    src: enecoq.conf
    dest: /etc/zabbix/zabbix_agentd.d
  notify: Restart zabbix-agent
  tags: [zabbix-smarthome-enecoq]

# Due to "selenium.common.exceptions.WebDriverException: Message: Service
# chromedriver unexpectedly exited. Status code was: 1"
- name: Change zabbix home directory
  user:
    name: zabbix
    home: /home/zabbix
  notify: Restart zabbix-agent
  tags: [zabbix-smarthome-enecoq]