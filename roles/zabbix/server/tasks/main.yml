---
- name: Install zabbix-release
  apt:
    deb: https://repo.zabbix.com/zabbix/5.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_5.0-1+focal_all.deb
  tags: [zabbix-server, package, zabbix-frontend]

- name: Install packages
  apt:
    name:
      - zabbix-server-mysql
      - zabbix-frontend-php
      - zabbix-apache-conf
      - zabbix-get
      - fonts-noto-cjk
    update_cache: yes
  notify: Restart apache
  tags: [zabbix-server, package, zabbix-frontend]

- name: Change permission of zabbix_server.conf
  file:
    path: /etc/zabbix/zabbix_server.conf
    owner: root
    group: zabbix
    mode: 0640
  tags: [zabbix-server]

- name: Set DBHost
  lineinfile:
    dest: /etc/zabbix/zabbix_server.conf
    insertafter: "^# DBHost="
    regexp: "^DBHost="
    line: "DBHost={{ aurora.ep }}"
  notify: Restart zabbix-server
  tags: [zabbix-server]

- name: Set DBPassword
  lineinfile:
    dest: /etc/zabbix/zabbix_server.conf
    insertafter: "^# DBPassword="
    regexp: "^DBPassword="
    line: "DBPassword={{ aurora.zabbix_password }}"
  notify: Restart zabbix-server
  tags: [zabbix-server]

- name: Set Timeout
  lineinfile:
    dest: /etc/zabbix/zabbix_server.conf
    insertafter: "^# Timeout="
    regexp: "^Timeout="
    line: "Timeout=30"
  notify: Restart zabbix-server
  tags: [zabbix-server]

- name: Set php_value
  lineinfile:
    dest: /etc/zabbix/apache.conf
    insertafter: "# php_value date.timezone"
    regexp: "^ *php_value date.timezone"
    line: "        php_value date.timezone Asia/Tokyo"
  notify: Reload apache
  tags: [zabbix-server, zabbix-frontend]

- name: Copy zaibbx-frontend conf
  template:
    src: zabbix.conf.php.j2
    dest: /etc/zabbix/web/zabbix.conf.php
    owner: root
    group: www-data
    mode: 0660
  tags: [zabbix-server, zabbix-frontend]

- name: Change font for graphs
  file:
    src: /usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc
    dest: /etc/alternatives/zabbix-frontend-font
    state: link
  tags: [zabbix-server, zabbix-frontend]

- name: Install additional packages
  apt:
    name: 
      - python3-bs4
      - python3-requests
    update_cache: yes
  tags: [zabbix-server, zabbix-extra, package]

- name: Clone market-price-check.git
  git:
    repo: git@github.com:rewse/market-price-check.git
    dest: /srv/git/market-price-check
    accept_hostkey: yes
    key_file: /home/{{ admin }}/.ssh/id_rsa
  tags: [zabbix-server, zabbix-extra]

- name: Copy market-price-check
  copy:
    src: /srv/git/market-price-check/market-price-check
    dest: /usr/local/bin/
    mode: 0755
    remote_src: yes
  tags: [zabbix-server, zabbix-extra]

- name: Clone ssl-cert-check
  git:
    repo: https://github.com/Matty9191/ssl-cert-check.git
    dest: /srv/git/ssl-cert-check
  tags: [zabbix-server, zabbix-extra]

- name: Copy ssl-cert-check
  copy:
    src: /srv/git/ssl-cert-check/ssl-cert-check
    dest: /usr/local/bin
    mode: 0755
    remote_src: yes
  tags: [zabbix-server, zabbix-extra]

- name: Copy to externalscripts
  copy:
    src: "{{ item }}"
    dest: /usr/lib/zabbix/externalscripts
    mode: 0755
  with_items:
    - cloudwatch.sh
    - market-price-check.sh
    - ssl-cert-check.sh
  tags: [zabbix-server, zabbix-extra]