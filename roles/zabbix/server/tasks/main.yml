---
  # Do not install mysql-connector-odbc because Zabbix Server 3.4 is always
  # crashes.
- name: install packages
  yum:
    name:
      - mod_ssl
      - zabbix-server-mysql
      - zabbix-web-japanese
      - zabbix-web-mysql
    state: installed
  notify: restart httpd
  tags: [zabbix-server, zabbix-server-server, zabbix-web]

- name: enable zabbix-server
  service:
    name: zabbix-server
    enabled: yes
  notify: restart zabbix-server
  tags: [zabbix-server, zabbix-server-server]

- name: enable httpd
  service:
    name: httpd
    enabled: yes
  notify: restart httpd
  tags: [zabbix-server, zabbix-server-server]

- name: set DBHost
  lineinfile:
    dest: /etc/zabbix/zabbix_server.conf
    insertafter: '^# DBHost='
    regexp: '^DBHost='
    line: 'DBHost={{aurora.ep}}'
  notify: restart zabbix-server
  tags: [zabbix-server, zabbix-server-server]

- name: set DBPassword
  lineinfile:
    dest: /etc/zabbix/zabbix_server.conf
    insertafter: '^# DBPassword='
    regexp: '^DBPassword='
    line: 'DBPassword={{aurora.zabbix_password}}'
  notify: restart zabbix-server
  tags: [zabbix-server, zabbix-server-server]

- name: set Timeout
  lineinfile:
    dest: /etc/zabbix/zabbix_server.conf
    insertafter: '^# Timeout='
    regexp: '^Timeout='
    line: 'Timeout=30'
  notify: restart zabbix-server
  tags: [zabbix-server, zabbix-server-server]

- name: set php_value
  lineinfile:
    dest: /etc/httpd/conf.d/zabbix.conf
    insertafter: '# php_value date.timezone'
    regexp: '^ *php_value date.timezone'
    line: '        php_value date.timezone Asia/Tokyo'
  notify: reload httpd
  tags: [zabbix-server, zabbix-web]

- name: create zaibbx-web conf
  become_user: apache
  template:
    src: zabbix.conf.php.j2
    dest: /etc/zabbix/web/zabbix.conf.php
    mode: 0640
  tags: [zabbix-server, zabbix-web]

- name: clone market-price-check.git
  git:
    repo: git@github.com:rewse/market-price-check.git
    dest: /srv/git/market-price-check
    accept_hostkey: yes
    key_file: /home/{{admin}}/.ssh/id_rsa
  tags: [zabbix-server, zabbix-extra]

- name: change mode of git/dotfiles
  file:
    path: /srv/git/aws-ec2-smart-snapshot
    owner: "{{admin}}"
    group: "{{admin}}"
    recurse: yes
  tags: [zabbix-server, zabbix-extra]

- name: copy to /usr/local/bin
  copy:
    src: /srv/git/market-price-check/{{item}}
    dest: /usr/local/bin/
    mode: 0755
    remote_src: yes
  with_items:
    - market-price-check
    - us-market-price-check
  tags: [zabbix-server, zabbix-extra]

- name: clone ssl-cert-check
  git:
    repo: https://github.com/Matty9191/ssl-cert-check.git
    dest: /srv/git/ssl-cert-check
  tags: [zabbix-server, zabbix-extra]

- name: clone ssl-cert-check
  copy:
    src: /srv/git/ssl-cert-check/ssl-cert-check
    dest: /usr/local/bin
    mode: 0755
    remote_src: yes
  tags: [zabbix-server, zabbix-extra]

- name: copy to externalscripts
  copy:
    src: "{{item}}"
    dest: /usr/lib/zabbix/externalscripts
    mode: 0755
  with_items:
    - cloudwatch.sh
    - market-price-check.sh
    - us-market-price-check.sh
    - ssl-cert-check.sh
  tags: [zabbix-server, zabbix-extra]
