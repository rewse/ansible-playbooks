#!/usr/bin/env bash

trap 'my_exit 1' 1 2 3 15

readonly email=[% cyberhome.email %]
readonly password=[% cyberhome.password %]
readonly tmpfile=$(mktemp --tmpdir enecoq.XXXXXXXXXX)

# {{{ my_exit()

my_exit() {
    rm -f $tmpfile
    echo $1
    exit $1
}

# }}}
# {{{ send_enecoq()

send_enecoq() {
    csv=$(/usr/local/bin/enecoq -l $email $password)

    if [ "$(echo $csv | grep -v Insuff | grep -v None)" ]; then
        false > $tmpfile
        for line in $csv; do
            echo $line |
                awk -F, '{print "- enecoq.yen[low]", $1, $2}' >> $tmpfile
            echo $line |
                awk -F, '{print "- enecoq.yen[mid]", $1, $3}' >> $tmpfile
            echo $line |
                awk -F, '{print "- enecoq.yen[high]", $1, $4}' >> $tmpfile
        done

        zabbix_sender \
            -c /etc/zabbix/zabbix_agentd.conf \
            -T -i $tmpfile \
            > /dev/null 2>&1

        retval=$?
    else
        retval=-1
    fi
}

# }}}
# {{{ Main

send_enecoq

my_exit $retval

# }}}