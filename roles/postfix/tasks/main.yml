---
- name: install packages
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - amavisd-new
    - certbot
    - clamav
    - clamav-server-systemd
    - clamav-update
    - cyrus-sasl
    - dovecot
    - lz4
    - procmail
    - python-certbot-apache
    - spamassassin
  tags: [postfix, amavisd, certbot, dovecot, procmail, spamassassin, package]

- name: start saslauthd
  service:
    name: saslauthd
    enabled: yes
    state: started
  tags: [postfix, saslauthd]

- name: set inet_interfaces
  lineinfile:
    dest: /etc/postfix/main.cf
    insertafter: '^#inet_interfaces'
    regexp: '^inet_interfaces'
    line: 'inet_interfaces = all'
  notify: reload postfix
  tags: [postfix]

- name: set mydestination
  lineinfile:
    dest: /etc/postfix/main.cf
    insertbefore: '^#mydestination'
    regexp: '^mydestination'
    line: 'mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain'
  notify: reload postfix
  tags: [postfix]

- name: set home_mailbox
  lineinfile:
    dest: /etc/postfix/main.cf
    insertafter: '^#home_mailbox '
    regexp: '^home_mailbox '
    line: 'home_mailbox = Maildir/'
  notify: reload postfix
  tags: [postfix]

- name: copy certbot.cron
  copy:
    src: certbot.cron
    dest: /etc/cron.monthly
    mode: 0755
  tags: [postfix, certbot]

- name: amavisd; bypass spam checks
  lineinfile:
    dest: /etc/amavisd/amavisd.conf
    insertafter: '^# @bypass_spam_checks_maps '
    regexp: '^@bypass_spam_checks_maps '
    line: '@bypass_spam_checks_maps = (1);'
  notify: reload amavisd
  tags: [postfix, amavisd]

- name: amavisd; set mydomain
  lineinfile:
    dest: /etc/amavisd/amavisd.conf
    regexp: '^\$mydomain '
    line: "$mydomain = 'rewse.jp';"
  notify: reload amavisd
  tags: [postfix, amavisd]

- name: amavisd; set virus_admin
  lineinfile:
    dest: /etc/amavisd/amavisd.conf
    regexp: '^\$virus_admin '
    line: "$virus_admin = '{{vault_email.secondary}}';"
  notify: reload amavisd
  tags: [postfix, amavisd]

- name: amavisd; set mailfrom_notify_admin
  lineinfile:
    dest: /etc/amavisd/amavisd.conf
    regexp: '^\$mailfrom_notify_admin '
    line: "$mailfrom_notify_admin = 'amavisd@rewse.jp';"
  notify: reload amavisd
  tags: [postfix, amavisd]

- name: amavisd; enable always-clean
  lineinfile:
    dest: /etc/amavisd/amavisd.conf
    regexp: 'always-clean'
    line: "['always-clean', sub {0}],"
  notify: reload amavisd
  tags: [postfix, amavisd]

- name: enable freshclam.conf
  lineinfile:
    dest: /etc/freshclam.conf
    regexp: 'Example'
    line: '#Example'
  tags: [postfix, amavisd]

- name: refresh clamav db
  command: freshclam
  tags: [postfix, amavisd]

- name: start amavisd
  service:
    name: amavisd
    enabled: yes
    state: started
  tags: [postfix, amavisd]

- name: set posfix/main.cf
  blockinfile:
    dest: /etc/postfix/main.cf
    content: |
      smtpd_sasl_auth_enable = yes
      smtpd_sasl_security_options = noanonymous
      smtpd_recipient_restrictions =
        permit_sasl_authenticated,
        permit_mynetworks,
        reject_unauth_destination

      smtpd_use_tls = yes
      smtpd_tls_auth_only = yes
      smtpd_tls_cert_file = /etc/letsencrypt/live/rewse.jp/fullchain.pem
      smtpd_tls_key_file = /etc/letsencrypt/live/rewse.jp/privkey.pem
      smtpd_tls_loglevel = 1
      smtpd_tls_session_cache_database = hash:/etc/postfix/smtpd_scache
      smtpd_tls_received_header = yes
      tls_random_source = dev:/dev/urandom

      content_filter=amavisfeed:[127.0.0.1]:10024
  notify: reload postfix
  tags: [postfix, amavisd]

- name: set postfix/master.cf
  blockinfile:
    dest: /etc/postfix/master.cf
    insertbefore: '^#smtp '
    content: |
      submission inet n       -       n       -       -       smtpd
        -o syslog_name=postfix/submission
      smtps     inet  n       -       n       -       -       smtpd
        -o syslog_name=postfix/smtps

      amavisfeed unix -       -       n       -       2       smtp
        -o smtp_data_done_timeout=1200
        -o smtp_send_xforward_command=yes
        -o disable_dns_lookups=yes
        -o max_use=20

      127.0.0.1:10025 inet n  -       n       -       -       smtpd
        -o content_filter=
        -o smtpd_delay_reject=no
        -o smtpd_client_restrictions=permit_mynetworks,reject
        -o smtpd_helo_restrictions=
        -o smtpd_sender_restrictions=
        -o smtpd_recipient_restrictions=permit_mynetworks,reject
        -o smtpd_data_restrictions=reject_unauth_pipelining
        -o smtpd_end_of_data_restrictions=
        -o smtpd_restriction_classes=
        -o mynetworks=127.0.0.0/8
        -o smtpd_error_sleep_time=0
        -o smtpd_soft_error_limit=1001
        -o smtpd_hard_error_limit=1000
        -o smtpd_client_connection_count_limit=0
        -o smtpd_client_connection_rate_limit=0
        -o receive_override_options=no_header_body_checks,no_unknown_recipient_checks,no_milters
        -o local_header_rewrite_clients=
  notify: reload postfix
  tags: [postfix, amavisd]

- name: get spamassassin local.cf
  get_url:
    url: http://www.flcl.org/~yoh/user_prefs
    dest: /etc/mail/spamassassin/local.cf
  notify: reload spamassassin
  tags: [postfix, spamassassin]

- name: copy updatesaconf.cron
  copy:
    src: updatesaconf.cron
    dest: /etc/cron.monthly
    mode: 0755
  tags: [postfix, spamassassin]

- name: copy private_prefs
  copy:
    src: private_prefs
    dest: /etc/mail/spamassassin
  notify: reload spamassassin
  tags: [postfix, spamassassin]

- name: start spamassassin
  service:
    name: spamassassin
    enabled: yes
    state: started
  tags: [postfix, spamassassin]

- name: use procmail
  lineinfile:
    dest: /etc/postfix/main.cf
    insertafter: '^#mailbox_command '
    regexp: '^mailbox_command '
    line: 'mailbox_command = /bin/procmail'
  notify: reload postfix
  tags: [postfix, procmail]

- name: copy procmailrc
  copy:
    src: procmailrc
    dest: /etc
  tags: [postfix, procmail]

- name: dovecot; set mail_location
  lineinfile:
    dest: /etc/dovecot/conf.d/10-mail.conf
    insertafter: '^#mail_location '
    regexp: '^mail_location '
    line: 'mail_location = maildir:~/Maildir'
  notify: reload dovecot
  tags: [postfix, dovecot]

- name: dovecot; enable plaintext auth
  lineinfile:
    dest: /etc/dovecot/conf.d/10-auth.conf
    insertafter: '^#disable_plaintext_auth '
    regexp: '^disable_plaintext_auth '
    line: 'disable_plaintext_auth = no'
  notify: reload dovecot
  tags: [postfix, dovecot]

- name: dovecot; change ssl to yes
  lineinfile:
    dest: /etc/dovecot/conf.d/10-ssl.conf
    regexp: '^ssl '
    line: 'ssl = yes'
  notify: reload dovecot
  tags: [postfix, dovecot]

- name: start dovecot
  service:
    name: dovecot
    enabled: yes
    state: started
  tags: [postfix, dovecot]
