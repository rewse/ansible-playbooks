---
- name: install packages
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - mailman
  tags: [mailman, package]

  # Because lsyncd copies everything by mailman user
- name: change owner in /srv/mailman
  file:
    path: /srv/mailman
    owner: mailman
    group: mailman
    recurse: yes
  tags: [mailman]

- name: set DEFAULT_URL_HOST
  lineinfile:
    dest: /etc/mailman/mm_cfg.py
    regexp: '^DEFAULT_URL_HOST '
    line: 'DEFAULT_URL_HOST = "rewse.jp"'
  tags: [mailman]

- name: set DEFAULT_EMAIL_HOST
  lineinfile:
    dest: /etc/mailman/mm_cfg.py
    regexp: '^DEFAULT_EMAIL_HOST '
    line: 'DEFAULT_EMAIL_HOST = "rewse.jp"'
  tags: [mailman]

- name: set MTA
  lineinfile:
    dest: /etc/mailman/mm_cfg.py
    regexp: '^MTA '
    line: 'MTA = "Postfix"'
  tags: [mailman]

- name: set DEFAULT_URL_PATTERN
  lineinfile:
    dest: /etc/mailman/mm_cfg.py
    regexp: '^DEFAULT_URL_PATTERN '
    line: 'DEFAULT_URL_PATTERN = "https://%s/mailman/"'
  tags: [mailman]

- name: set DEFAULT_LIST_ADVERTISED
  lineinfile:
    dest: /etc/mailman/mm_cfg.py
    regexp: '^DEFAULT_LIST_ADVERTISED '
    line: 'DEFAULT_LIST_ADVERTISED = No'
  tags: [mailman]

- name: set site password
  command: /usr/lib/mailman/bin/mmsitepass {{mailman_password}}
  tags: [mailman]

- name: generate aliases
  command: /usr/lib/mailman/bin/genaliases
  tags: [mailman]

- name: change perm of aliases.db
  file:
    path: /etc/mailman/aliases.db
    mode: 0660
  tags: [mailman]

- name: set the alias to postfix/main.cf
  lineinfile:
    dest: /etc/postfix/main.cf
    regexp: '^alias_maps '
    line: 'alias_maps = hash:/etc/aliases, hash:/etc/mailman/aliases'
  notify: reload postfix
  tags: [mailman]

- name: set RemoteIPHeader
  lineinfile:
    dest: /etc/httpd/conf.d/mailman.conf
    insertbefore: '^ScriptAlias'
    regexp: '^RemoteIPHeader '
    line: 'RemoteIPHeader X-Forwarded-For'
  notify: reload httpd
  tags: [mailman]

- name: set Require
  replace:
    dest: /etc/httpd/conf.d/mailman.conf
    regexp: 'Require all granted'
    replace: 'Require ip {{global_ip.home}} {{global_ip.office}}'
  notify: reload httpd
  tags: [mailman]

- name: set RedirectMatch
  lineinfile:
    dest: /etc/httpd/conf.d/mailman.conf
    insertafter: '^# RedirectMatch'
    regexp: '^RedirectMatch '
    line: 'RedirectMatch ^/mailman[/]*$ https://rewse.jp/mailman/listinfo'
  notify: reload httpd
  tags: [mailman]
