---
- name: Install packages
  ansible.builtin.apt:
    name:
      - php-curl
      - php-imagick
      - php-zip
      - wordpress
  tags: [wordpress, package]

- name: Get stats of /srv/www/wordpress
  ansible.builtin.stat:
    path: /srv/www/wordpress
  register: wordpress_dir
  tags: [wordpress]

- name: Extract wordpress.zip
  ansible.builtin.unarchive:
    src: https://wordpress.org/latest.zip
    dest: /srv/www
    remote_src: yes
    owner: www-data
    group: www-data
  when: wordpress_dir.stat.isdir is not defined
  tags: [wordpress]

- name: Copy wp-confg.php
  ansible.builtin.template:
    src: wp-config.php.j2
    dest: /srv/www/wordpress/wp-config.php
    owner: www-data
    group: www-data
  tags: [wordpress]

- name: Copy htaccess
  ansible.builtin.copy:
    src: htaccess
    dest: /srv/www/wordpress/.htaccess
    owner: www-data
    group: www-data
  tags: [wordpress]

- name: Enable mod_expires
  ansible.builtin.command: a2enmod expires
  notify: Restart apache
  tags: [wordpress]

- name: Copy wordpress.conf
  ansible.builtin.copy:
    src: wordpress.conf
    dest: /etc/apache2/conf-available
  notify: Reload apache
  tags: [wordpress]

- name: Enable wordpress.conf
  ansible.builtin.command: a2enconf wordpress
  notify: Reload apache
  tags: [wordpress]

- name: Copy welcome.conf
  ansible.builtin.copy:
    src: welcome.conf
    dest: /etc/apache2/conf-available
  notify: Reload apache
  tags: [wordpress]

- name: Enable welcome.conf
  ansible.builtin.command: a2enconf welcome
  notify: Reload apache
  tags: [wordpress]

- name: Enable htaccess
  ansible.builtin.lineinfile:
    dest: /etc/apache2/apache2.conf
    regexp: "^	AllowOverride "
    line: "	AllowOverride All"
  notify: Reload apache
  tags: [wordpress]

- name: Copy 30-wordpress.ini
  ansible.builtin.copy:
    src: 30-wordpress.ini
    dest: /etc/php/7.4/apache2/conf.d
  notify: Reload apache
  tags: [wordpress]

- name: Add a filter for Yoast SEO
  ansible.builtin.blockinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/functions.php
    block: |

      /* ---------------------------------------------------------------------------------------------
      CUSTOMIZE BY OWNER
      --------------------------------------------------------------------------------------------- */

      if ( ! function_exists( 'rewse_override_og_locale' ) ) {

          function rewse_override_og_locale( $locale ) {
              return 'ja_JP';
          }
          add_filter( 'wpseo_locale', 'rewse_override_og_locale' );

      }

      if ( ! function_exists( 'rewse_override_inlanguage' ) ) {
        
        function rewse_override_inlanguage( $data ) {
          $data['inLanguage'] = 'ja_JP';
          return $data;
        }
        add_filter( 'wpseo_schema_article', 'rewse_override_inlanguage' );
        add_filter( 'wpseo_schema_imageobject', 'rewse_override_inlanguage' );
        add_filter( 'wpseo_schema_person', 'rewse_override_inlanguage' );
        add_filter( 'wpseo_schema_webpage', 'rewse_override_inlanguage' );
        add_filter( 'wpseo_schema_website', 'rewse_override_inlanguage' );

      }
  tags: [wordpress]

- name: Replace lang
  ansible.builtin.lineinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/header.php
    regexp: '<html class="no-js" '
    line: '<html class="no-js" lang="ja">'
  tags: [wordpress]

- name: Replace copyright
  ansible.builtin.lineinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/header.php
    regexp: '<p>&copy;'
    line: "                <p>&copy; <?php echo date( 'Y' ); ?> <a href=\"<?php echo esc_url( home_url( '/' ) ); ?>\">Tats Shibata</a>.</p>"
  tags: [wordpress]
