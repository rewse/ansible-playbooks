---
- name: Install packages
  ansible.builtin.apt:
    name:
      - gettext
      - php-curl
      - php-imagick
      - php-intl
      - php-zip
      - wordpress
  tags: [wordpress, package]

- name: Get stats of /srv/www/wordpress
  ansible.builtin.stat:
    path: /srv/www/wordpress
  register: wordpress_dir
  tags: [wordpress]

- name: Extract wordpress.zip
  ansible.builtin.unarchive:
    src: https://wordpress.org/latest.zip
    dest: /srv/www
    remote_src: yes
    owner: www-data
    group: www-data
  when: wordpress_dir.stat.isdir is not defined
  tags: [wordpress]

- name: Copy wp-confg.php
  ansible.builtin.template:
    src: wp-config.php.j2
    dest: /srv/www/wordpress/wp-config.php
    owner: www-data
    group: www-data
  tags: [wordpress]

- name: Copy htaccess
  ansible.builtin.copy:
    src: htaccess
    dest: /srv/www/wordpress/.htaccess
    owner: www-data
    group: www-data
  tags: [wordpress]

- name: Enable mod_expires
  ansible.builtin.command: a2enmod expires
  notify: Restart apache
  tags: [wordpress]

- name: Enable mod_expires
  ansible.builtin.command: a2enmod headers
  notify: Restart apache
  tags: [wordpress]

- name: Copy wordpress.conf
  ansible.builtin.copy:
    src: wordpress.conf
    dest: /etc/apache2/conf-available
  notify: Reload apache
  tags: [wordpress]

- name: Enable wordpress.conf
  ansible.builtin.command: a2enconf wordpress
  notify: Reload apache
  tags: [wordpress]

- name: Copy welcome.conf
  ansible.builtin.copy:
    src: welcome.conf
    dest: /etc/apache2/conf-available
  notify: Reload apache
  tags: [wordpress]

- name: Enable welcome.conf
  ansible.builtin.command: a2enconf welcome
  notify: Reload apache
  tags: [wordpress]

- name: Enable htaccess
  ansible.builtin.lineinfile:
    dest: /etc/apache2/apache2.conf
    regexp: "^	AllowOverride "
    line: "	AllowOverride All"
  notify: Reload apache
  tags: [wordpress]

- name: Copy 30-wordpress.ini
  ansible.builtin.copy:
    src: 30-wordpress.ini
    dest: /etc/php/7.4/apache2/conf.d
  notify: Reload apache
  tags: [wordpress]

- name: Copy fukawasa-ja to prevent updating
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /srv/www/wordpress/wp-content/languages/themes
    owner: www-data
    group: www-data
  with_items:
    - fukasawa-ja.mo
    - fukasawa-ja.po
  tags: [wordpress]

- name: Disable Lato font
  ansible.builtin.replace:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/functions.php
    regexp: '\$google_fonts = ..*'
    replace: "$google_fonts = 'off';"
  tags: [wordpress]

- name: Add some functions
  ansible.builtin.blockinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/functions.php
    block: |

      /* ---------------------------------------------------------------------------------------------
      CUSTOMIZE BY OWNER
      --------------------------------------------------------------------------------------------- */

      if ( ! function_exists( 'jetpackme_remove_rp' ) ) {
          function jetpackme_remove_rp() {
              $jprp = Jetpack_RelatedPosts::init();
              $callback = array( $jprp, 'filter_add_target_to_dom' );
              remove_filter( 'the_content', $callback, 40 );
          }
          add_filter( 'wp', 'jetpackme_remove_rp', 20 );
      }

      /* ref; https://github.com/Automattic/jetpack/pull/22269 */
      add_filter(
          'jetpack_stats_excluded_ips',
          function ( $excluded_ips ) {
              $excluded_ips[] = '{{ global_ip.home_ip }}';
              return $excluded_ips;
          }
      );

      /* Ref; https://blog.rizkipratama.com/change-jetpack-related-posts-category-primary-yoast-seo/ */
      if ( ! function_exists( 'jp_rp_context_cat_primary_yoast' ) ) {
        function jp_rp_context_cat_primary_yoast( $context, $post_id ) {
            $primary_cat_id = get_post_meta( $post_id , '_yoast_wpseo_primary_category', true );
            if ( $primary_cat_id ) {
                $post_cat_name = get_the_category_by_ID( $primary_cat_id );
                if ( isset( $post_cat_name ) ) {
                    $context = sprintf( 
                        _x( 'In "%s"', 'in {category/tag name}', 'jetpack' ),
                        $post_cat_name
                    );
                }
            }
            return $context;
        }
        add_filter( 'jetpack_relatedposts_filter_post_context', 'jp_rp_context_cat_primary_yoast', 10, 2 );
      }

  tags: [wordpress]

- name: Replace copyright
  ansible.builtin.lineinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/header.php
    regexp: '<p>&copy;'
    line: "                <p>&copy; <?php echo date( 'Y' ); ?> <a href=\"<?php echo esc_url( home_url( '/' ) ); ?>\">Tats Shibata</a>.</p>"
  tags: [wordpress]

- name: Add the date on top
  ansible.builtin.blockinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/singular.php
    marker: "<!-- {mark} ANSIBLE MANAGED BLOCK .post-date-top -->"
    insertafter: '</header><!-- .post-header -->'
    block: |2
                        <?php if ( is_single() ) : ?>
                                <p class="post-date-top"><?php the_date( get_option( 'date_format' ) ); ?></p>
                        <?php endif; ?>
  tags: [wordpress]

- name: Delete the date from bottom
  ansible.builtin.lineinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/singular.php
    regexp: '<li class="post-date">'
    line: ""
  tags: [wordpress]

- name: Add an author box
  ansible.builtin.blockinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/singular.php
    marker: "<!-- {mark} ANSIBLE MANAGED BLOCK wpsabox_author_box -->"
    insertbefore: '</div><!-- .post-inner -->'
    block: |2
                          <?php if ( function_exists( 'wpsabox_author_box' ) ) echo wpsabox_author_box(); ?>

                          <?php if ( ! is_page() ) : ?>
                              <p class="post-disclaimer">ここで示されている発言は個人の見解であり、所属する組織の公式見解ではありません。</p>
                          <?php endif; ?>
                          <?php
                              if ( class_exists( 'Jetpack_RelatedPosts' ) ) {
                                  echo do_shortcode( '[jetpack-related-posts]' );
                              }
                          ?>
  tags: [wordpress]
