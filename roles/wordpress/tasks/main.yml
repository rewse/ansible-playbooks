---
- name: Install packages
  ansible.builtin.apt:
    name:
      - php-curl
      - php-imagick
      - php-zip
      - wordpress
  tags: [wordpress, package]

- name: Get stats of /srv/www/wordpress
  ansible.builtin.stat:
    path: /srv/www/wordpress
  register: wordpress_dir
  tags: [wordpress]

- name: Extract wordpress.zip
  ansible.builtin.unarchive:
    src: https://wordpress.org/latest.zip
    dest: /srv/www
    remote_src: yes
    owner: www-data
    group: www-data
  when: wordpress_dir.stat.isdir is not defined
  tags: [wordpress]

- name: Copy wp-confg.php
  ansible.builtin.template:
    src: wp-config.php.j2
    dest: /srv/www/wordpress/wp-config.php
    owner: www-data
    group: www-data
  tags: [wordpress]

- name: Copy htaccess
  ansible.builtin.copy:
    src: htaccess
    dest: /srv/www/wordpress/.htaccess
    owner: www-data
    group: www-data
  tags: [wordpress]

- name: Enable mod_expires
  ansible.builtin.command: a2enmod expires
  notify: Restart apache
  tags: [wordpress]

- name: Copy wordpress.conf
  ansible.builtin.copy:
    src: wordpress.conf
    dest: /etc/apache2/conf-available
  notify: Reload apache
  tags: [wordpress]

- name: Enable wordpress.conf
  ansible.builtin.command: a2enconf wordpress
  notify: Reload apache
  tags: [wordpress]

- name: Copy welcome.conf
  ansible.builtin.copy:
    src: welcome.conf
    dest: /etc/apache2/conf-available
  notify: Reload apache
  tags: [wordpress]

- name: Enable welcome.conf
  ansible.builtin.command: a2enconf welcome
  notify: Reload apache
  tags: [wordpress]

- name: Enable htaccess
  ansible.builtin.lineinfile:
    dest: /etc/apache2/apache2.conf
    regexp: "^	AllowOverride "
    line: "	AllowOverride All"
  notify: Reload apache
  tags: [wordpress]

- name: Copy 30-wordpress.ini
  ansible.builtin.copy:
    src: 30-wordpress.ini
    dest: /etc/php/7.4/apache2/conf.d
  notify: Reload apache
  tags: [wordpress]

- name: Remvoe Japanese lang files for fukasawa
  ansible.builtin.file:
    path: /srv/www/wordpress/wp-content/languages/themes/{{ item }}
    state: absent
  with_items:
    - fukasawa-ja.mo
    - fukasawa-ja.po
  tags: [wordpress]

- name: Add display=fallback to Google Fonts
  ansible.builtin.lineinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/functions.php
    regexp: 'fukasawa_googleFonts'
    line: "                wp_register_style( 'fukasawa_googleFonts', '//fonts.googleapis.com/css?family=Lato:400,400italic,700,700italic&amp;display=fallback' );"
  tags: [wordpress]

- name: Add some functions
  ansible.builtin.blockinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/functions.php
    block: |

      /* ---------------------------------------------------------------------------------------------
      CUSTOMIZE BY OWNER
      --------------------------------------------------------------------------------------------- */

  tags: [wordpress]

- name: Add preconnect
  ansible.builtin.blockinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/header.php
    marker: "<!-- {mark} ANSIBLE MANAGED BLOCK -->"
    insertafter: '<head '
    block: |2
              <link rel="preconnect" href="https://fonts.gstatic.com/">
              <link rel="preconnect" href="https://fonts.googleapis.com/">
  tags: [wordpress]

- name: Replace copyright
  ansible.builtin.lineinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/header.php
    regexp: '<p>&copy;'
    line: "                <p>&copy; <?php echo date( 'Y' ); ?> <a href=\"<?php echo esc_url( home_url( '/' ) ); ?>\">Tats Shibata</a>.</p>"
  tags: [wordpress]

- name: Add an author box
  ansible.builtin.blockinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/singular.php
    marker: "<!-- {mark} ANSIBLE MANAGED BLOCK -->"
    insertbefore: '</div><!-- .post-inner -->'
    block: |2
                          <?php if ( function_exists( 'wpsabox_author_box' ) ) echo wpsabox_author_box(); ?>

                          <?php if ( ! is_page() ) : ?>
                              <p class="post-disclaimer">ここで示されている発言は個人の見解であり、所属する組織の公式見解ではありません。</p>
                          <?php endif; ?>
                          <?php
                              if ( class_exists( 'Jetpack_RelatedPosts' ) ) {
                                  echo do_shortcode( '[jetpack-related-posts]' );
                              }
                          ?>
  tags: [wordpress]

- name: Translate 404 title
  ansible.builtin.lineinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/404.php
    regexp: '<h1 class="post-title">'
    line: '           <h1 class="post-title">見つかりませんでした</h1>'
  tags: [wordpress]

- name: Translate 404 message
  ansible.builtin.lineinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/404.php
    insertafter: 'entry-content'
    regexp: '<p class="not-found-message-ja">'
    line: '            <p class="not-found-message-ja">存在していないページを開こうとしたようです。削除されたか、移動されたか、あるいはもともと存在しなかったのかもしれません。お探しのものを下記のフォームから検索してみてください。</p>'
  tags: [wordpress]

- name: Delete original 404 message
  ansible.builtin.lineinfile:
    path: /srv/www/wordpress/wp-content/themes/fukasawa/404.php
    regexp: "It seems like you have tried to open a page that doesn't exist"
    line: ""
  tags: [wordpress]
