---
- name: Install additional packages
  ansible.builtin.apt:
    name:
      - bluez
      - ifmetric
      - mosquitto-clients
      - nfs-common
      - pi-bluetooth
      - snmp
      - snmp-mibs-downloader
  tags: [raspberrypi, package]

- name: Configure swap factor to RAM size
  ansible.builtin.lineinfile:
    path: /etc/dphys-swapfile
    regexp: '^#?CONF_SWAPFACTOR='
    line: 'CONF_SWAPFACTOR=1'
    backup: true
  notify: Restart dphys-swapfile
  tags: [raspberrypi, swap]

- name: Configure swap max size to 16GB
  ansible.builtin.lineinfile:
    path: /etc/dphys-swapfile
    regexp: '^#?CONF_MAXSWAP='
    line: 'CONF_MAXSWAP=16384'
    backup: true
  notify: Restart dphys-swapfile
  tags: [raspberrypi, swap]

- name: Ensure CONF_SWAPSIZE is commented out for dynamic calculation
  ansible.builtin.lineinfile:
    path: /etc/dphys-swapfile
    regexp: '^CONF_SWAPSIZE='
    line: '#CONF_SWAPSIZE='
    backup: true
  notify: Restart dphys-swapfile
  tags: [raspberrypi, swap]

- name: Add NTP servers
  ansible.builtin.lineinfile:
    dest: /etc/systemd/timesyncd.conf
    insertafter: '^#NTP='
    regexp: '^NTP='
    line: 'NTP=ntp.nict.jp ntp.jst.mfeed.ad.jp'
  notify: Restart systemd-timesyncd
  tags: [raspberrypi, time, systemd-timesyncd]

- name: Enable bluetooth services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - bluetooth
  tags: [raspberrypi]

- name: Enable SNMP mibs
  ansible.builtin.lineinfile:
    dest: /etc/snmp/snmp.conf
    regexp: "mibs "
    line: "mibs all"
  tags: [raspberrypi]

- name: Download php-miio
  ansible.builtin.unarchive:
    src: https://github.com/skysilver-lab/php-miio/archive/refs/tags/v.{{ php_miio_version }}.zip
    dest: /srv
    remote_src: true
  tags: [raspberrypi]

- name: Copy environment
  ansible.builtin.copy:
    src: environment
    dest: /etc
  tags: [raspberrypi]

- name: Copy netplan/99-config.yaml
  ansible.builtin.template:
    src: 99-config.yaml.j2
    dest: /etc/netplan/99-config.yaml
    mode: '0600'
  tags: [raspberrypi]

- name: Delete 50-cloud-init.yaml
  ansible.builtin.file:
    path: /etc/netplan/50-cloud-init.yaml
    state: absent
  tags: [raspberrypi]

- name: Copy 99-disable-network-config.cfg
  ansible.builtin.copy:
    src: 99-disable-network-config.cfg
    dest: /etc/cloud/cloud.cfg.d
  tags: [raspberrypi]

- name: Copy ifmetric to cron.d
  ansible.builtin.copy:
    src: ifmetric
    dest: /etc/cron.d
  tags: [raspberrypi]

- name: Apply netplan
  ansible.builtin.command: netplan apply
  notify: Run ifmetric
  tags: [raspberrypi]

# ssh stuck at expecting SSH2_MSG_KEX_ECDH_REPLY - Unix & Linux Stack Exchange
# https://unix.stackexchange.com/questions/722954/ssh-stuck-at-expecting-ssh2-msg-kex-ecdh-reply
- name: Copy kex_algorithms.conf
  ansible.builtin.copy:
    src: kex_algorithms.conf
    dest: /etc/ssh/ssh_config.d
  tags: [raspberrypi]

- name: Create ssh.socket.d
  ansible.builtin.file:
    path: /etc/systemd/system/ssh.socket.d
    state: directory
  tags: [raspberrypi, ssh]

- name: Copy ssh.socket.d override.conf
  ansible.builtin.template:
    src: override.conf.j2
    dest: /etc/systemd/system/ssh.socket.d/override.conf
  notify: Restart ssh.socket
  tags: [raspberrypi, ssh]

- name: Create /mnt/bak
  ansible.builtin.file:
    path: /mnt/bak
    state: directory
  tags: [raspberrypi]

- name: Copy rsync-time-backup
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/laurent22/rsync-time-backup/master/rsync_tmbackup.sh
    dest: /usr/local/bin/tmbackup
    mode: '0755'
  tags: [raspberrypi]

- name: Add / for fn_df_t_src to tmpbackup
  ansible.builtin.replace:
    dest: /usr/local/bin/tmbackup
    regexp: 'fn_df_t_src "\${SRC_FOLDER}"'
    replace: 'fn_df_t_src "${SRC_FOLDER}/"'
  tags: [raspberrypi]

- name: Copy 000backup-daily
  ansible.builtin.template:
    src: 000backup-daily.j2
    dest: /etc/cron.daily/000backup-daily
    mode: '0755'
  tags: [raspberrypi]

- name: Copy tmbackup.exclude
  ansible.builtin.copy:
    src: tmbackup.exclude
    dest: /etc
  tags: [raspberrypi]
