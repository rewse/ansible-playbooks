---
- name: "package : Install packages"
  ansible.builtin.apt:
    name:
      - bluez
      - ifmetric
      - mosquitto-clients
      - nfs-common
      - pi-bluetooth
      - snmp
      - snmp-mibs-downloader
  tags:
    - raspberrypi
    - install
    - raspberrypi_package
    - raspberrypi_package_install

- name: "claude: Install Claude Code"
  ansible.builtin.shell: curl -fsSL https://claude.ai/install.sh | bash
  args:
    creates: ~/.local/bin/claude
  tags:
    - raspberrypi
    - install
    - claude
    - raspberrypi_claude
    - raspberrypi_claude_install

- name: "claude: Create symlink to /usr/local/bin"
  ansible.builtin.file:
    src: ~/.local/bin/claude
    dest: /usr/local/bin/claude
    state: link
  become: true
  tags:
    - raspberrypi
    - install
    - claude
    - raspberrypi_claude
    - raspberrypi_claude_install

- name: "swap : Set swap factor to RAM size"
  ansible.builtin.lineinfile:
    path: /etc/dphys-swapfile
    regexp: '^#?CONF_SWAPFACTOR='
    line: 'CONF_SWAPFACTOR=1'
    backup: true
  notify: "dphys-swapfile: Restart"
  tags:
    - raspberrypi
    - config
    - swap
    - raspberrypi_swap
    - raspberrypi_swap_config

- name: "swap : Set swap max size to 16GB"
  ansible.builtin.lineinfile:
    path: /etc/dphys-swapfile
    regexp: '^#?CONF_MAXSWAP='
    line: 'CONF_MAXSWAP=16384'
    backup: true
  notify: "dphys-swapfile: Restart"
  tags:
    - raspberrypi
    - config
    - swap
    - raspberrypi_swap
    - raspberrypi_swap_config

- name: "swap : Disable fixed swap size for dynamic calculation"
  ansible.builtin.lineinfile:
    path: /etc/dphys-swapfile
    regexp: '^CONF_SWAPSIZE='
    line: '#CONF_SWAPSIZE='
    backup: true
  notify: "dphys-swapfile: Restart"
  tags:
    - raspberrypi
    - config
    - swap
    - raspberrypi_swap
    - raspberrypi_swap_config

- name: "ntp : Configure NTP servers"
  ansible.builtin.lineinfile:
    dest: /etc/systemd/timesyncd.conf
    insertafter: '^#NTP='
    regexp: '^NTP='
    line: 'NTP=ntp.nict.jp ntp.jst.mfeed.ad.jp'
  notify: "systemd-timesyncd: Restart"
  tags:
    - raspberrypi
    - config
    - time
    - raspberrypi_ntp
    - raspberrypi_ntp_config

- name: "bluetooth : Enable service"
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - bluetooth
  tags:
    - raspberrypi
    - config
    - raspberrypi_bluetooth
    - raspberrypi_bluetooth_config

- name: "snmp : Enable MIBs"
  ansible.builtin.lineinfile:
    dest: /etc/snmp/snmp.conf
    regexp: "mibs "
    line: "mibs all"
  tags:
    - raspberrypi
    - config
    - raspberrypi_snmp
    - raspberrypi_snmp_config

- name: "php-miio : Install"
  ansible.builtin.unarchive:
    src: https://github.com/skysilver-lab/php-miio/archive/refs/tags/v.{{ php_miio_version }}.zip
    dest: /srv
    remote_src: true
  tags:
    - raspberrypi
    - install
    - raspberrypi_php-miio
    - raspberrypi_php-miio_install

- name: "environment : Copy file"
  ansible.builtin.copy:
    src: environment
    dest: /etc
  tags:
    - raspberrypi
    - config
    - raspberrypi_environment
    - raspberrypi_environment_config

- name: "boot : Configure NVMe power management workaround"
  ansible.builtin.lineinfile:
    path: /boot/firmware/cmdline.txt
    regexp: '^(.*)$'
    line: '\1 nvme_core.default_ps_max_latency_us=0 pcie_aspm=off pcie_port_pm=off'
    backrefs: true
    backup: true
  when: ansible_facts['devices']['nvme0n1'] is defined
  tags:
    - raspberrypi
    - config
    - boot
    - raspberrypi_boot
    - raspberrypi_boot_config

- name: "netplan : Configure network"
  ansible.builtin.template:
    src: 99-config.yaml.j2
    dest: /etc/netplan/99-config.yaml
    mode: '0600'
  tags:
    - raspberrypi
    - config
    - raspberrypi_netplan
    - raspberrypi_netplan_config

- name: "netplan : Remove cloud-init config"
  ansible.builtin.file:
    path: /etc/netplan/50-cloud-init.yaml
    state: absent
  tags:
    - raspberrypi
    - config
    - raspberrypi_netplan
    - raspberrypi_netplan_config

- name: "cloud-init : Disable network config"
  ansible.builtin.copy:
    src: 99-disable-network-config.cfg
    dest: /etc/cloud/cloud.cfg.d
  tags:
    - raspberrypi
    - config
    - raspberrypi_cloud-init
    - raspberrypi_cloud-init_config

- name: "sysctl : Configure for multi NIC"
  ansible.builtin.copy:
    src: 99-arp-multinic.conf
    dest: /etc/sysctl.d
  tags:
    - raspberrypi
    - config
    - raspberrypi_sysctl
    - raspberrypi_sysctl_config

- name: "network-failover : Copy script"
  ansible.builtin.copy:
    src: network-failover
    dest: /usr/local/sbin
    mode: '0755'
  tags:
    - raspberrypi
    - config
    - raspberrypi_network-failover
    - raspberrypi_network-failover_config

- name: "network-failover : Copy service"
  ansible.builtin.copy:
    src: network-failover.service
    dest: /etc/systemd/system
  notify: "Reload systemd"
  tags:
    - raspberrypi
    - config
    - raspberrypi_network-failover
    - raspberrypi_network-failover_config

- name: "network-failover : Copy timer"
  ansible.builtin.copy:
    src: network-failover.timer
    dest: /etc/systemd/system
  notify: "network-failover: Restart timer"
  tags:
    - raspberrypi
    - config
    - raspberrypi_network-failover
    - raspberrypi_network-failover_config

- name: "network-failover : Enable and start timer"
  ansible.builtin.systemd:
    name: network-failover.timer
    state: started
    enabled: true
    daemon_reload: true
  tags:
    - raspberrypi
    - config
    - raspberrypi_network-failover
    - raspberrypi_network-failover_config

- name: "netplan : Apply configuration"
  ansible.builtin.command: netplan apply
  tags:
    - raspberrypi
    - config
    - raspberrypi_netplan
    - raspberrypi_netplan_config

# ssh stuck at expecting SSH2_MSG_KEX_ECDH_REPLY - Unix & Linux Stack Exchange
# https://unix.stackexchange.com/questions/722954/ssh-stuck-at-expecting-ssh2-msg-kex-ecdh-reply
- name: "ssh : Configure KEX algorithms"
  ansible.builtin.copy:
    src: kex_algorithms.conf
    dest: /etc/ssh/ssh_config.d
  tags:
    - raspberrypi
    - config
    - ssh
    - raspberrypi_ssh
    - raspberrypi_ssh_config

- name: "ssh : Create socket override directory"
  ansible.builtin.file:
    path: /etc/systemd/system/ssh.socket.d
    state: directory
  tags:
    - raspberrypi
    - config
    - ssh
    - raspberrypi_ssh
    - raspberrypi_ssh_init

- name: "ssh : Configure socket override"
  ansible.builtin.template:
    src: override.conf.j2
    dest: /etc/systemd/system/ssh.socket.d/override.conf
  notify: "ssh: Restart socket"
  tags:
    - raspberrypi
    - config
    - ssh
    - raspberrypi_ssh
    - raspberrypi_ssh_config

- name: "qwen-code : Install"
  community.general.npm:
    name: "@qwen-code/qwen-code@latest"
    global: true
    state: present
  tags:
    - raspberrypi
    - install
    - qwen-code
    - raspberrypi_qwen-code
    - raspberrypi_qwen-code_install

- name: "backup : Create mount point"
  ansible.builtin.file:
    path: /mnt/bak
    state: directory
  tags:
    - raspberrypi
    - config
    - raspberrypi_backup
    - raspberrypi_backup_init

- name: "backup : Install rsync-time-backup script"
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/laurent22/rsync-time-backup/master/rsync_tmbackup.sh
    dest: /usr/local/bin/tmbackup
    mode: '0755'
  tags:
    - raspberrypi
    - install
    - raspberrypi_backup
    - raspberrypi_backup_install

- name: "backup : Fix rsync-time-backup source path"
  ansible.builtin.replace:
    dest: /usr/local/bin/tmbackup
    regexp: 'fn_df_t_src "\${SRC_FOLDER}"'
    replace: 'fn_df_t_src "${SRC_FOLDER}/"'
  tags:
    - raspberrypi
    - config
    - raspberrypi_backup
    - raspberrypi_backup_config

- name: "backup : Copy script"
  ansible.builtin.template:
    src: backup-daily.j2
    dest: /usr/local/sbin/backup-daily
    mode: '0755'
  tags:
    - raspberrypi
    - config
    - raspberrypi_backup
    - raspberrypi_backup_config

- name: "backup : Copy service"
  ansible.builtin.copy:
    src: backup-daily.service
    dest: /etc/systemd/system/backup-daily.service
  notify: "Reload systemd"
  tags:
    - raspberrypi
    - config
    - raspberrypi_backup
    - raspberrypi_backup_config

- name: "backup : Copy timer"
  ansible.builtin.copy:
    src: backup-daily.timer
    dest: /etc/systemd/system/backup-daily.timer
  notify: "raspberrypi : Restart backup-daily timer"
  tags:
    - raspberrypi
    - config
    - raspberrypi_backup
    - raspberrypi_backup_config

- name: "backup : Enable and start timer"
  ansible.builtin.systemd:
    name: backup-daily.timer
    enabled: true
    state: started
    daemon_reload: true
  tags:
    - raspberrypi
    - config
    - raspberrypi_backup
    - raspberrypi_backup_config

- name: "backup : Copy exclusion list"
  ansible.builtin.copy:
    src: tmbackup.exclude
    dest: /etc
  tags:
    - raspberrypi
    - config
    - raspberrypi_backup
    - raspberrypi_backup_config
