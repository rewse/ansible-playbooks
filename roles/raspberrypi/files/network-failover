#!/bin/bash

GW="192.168.0.1"
CHECK_INTERVAL=60

while true; do
    if ip link show eth0 2>/dev/null | grep -q "state UP" && \
       ping -c 1 -W 2 -I eth0 $GW &>/dev/null; then
        if ip link show wlan0 2>/dev/null | grep -q "state UP"; then
            logger "network-failover: eth0 is up, disabling wlan0"
            ip link set wlan0 down
            ip neigh flush dev wlan0
        fi
    else
        if ! ip link show wlan0 2>/dev/null | grep -q "state UP"; then
            logger "network-failover: eth0 is down, enabling wlan0"
            ip link set wlan0 up
            sleep 5
            ip neigh flush all
            conntrack -F 2>/dev/null || true
        fi
    fi
    sleep $CHECK_INTERVAL
done
