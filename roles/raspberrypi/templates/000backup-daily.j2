#!/usr/bin/bash
set -euo pipefail

# Configuration
readonly REMOTE="guppy:/volume1/Backup/{{ ansible_facts['hostname'] }}"
readonly SRC="/"
readonly DEST="/mnt/bak"
readonly EXCLUDE_FILE="/etc/tmbackup.exclude"
readonly BACKUP_STRATEGY="1:1 30:7 90:30"

# Cleanup function
cleanup() {
  local exit_code="${1:-0}"
  
  if mountpoint -q "${DEST}"; then
    umount "${DEST}" || {
      echo "Warning: Failed to unmount ${DEST}" >&2
      exit_code=1
    }
  fi
  
  exit "${exit_code}"
}

# Set trap for cleanup
trap 'cleanup 1' INT TERM EXIT

# Mount remote if not already mounted
if ! mountpoint -q "${DEST}"; then
  mount "${REMOTE}" "${DEST}" || {
    echo "Error: Failed to mount ${REMOTE} to ${DEST}" >&2
    exit 1
  }
fi

# Run backup
nice -n 10 tmbackup --strategy "${BACKUP_STRATEGY}" "${SRC}" "${DEST}" "${EXCLUDE_FILE}" > /dev/null

# Cleanup with success status
trap - INT TERM EXIT
cleanup 0
