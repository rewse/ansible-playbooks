---
- name: Set timezone
  timezone:
    name: Asia/Tokyo
  tags: [debian, time]

- name: Update all packages
  yum:
    name: '*'
    state: latest
    update_cache: yes
  tags: [debian, package]

- name: Install additional packages
  apt:
    name:
      - at
      - bc
      - dphys-swapfile
      - dnsutils
      - etckeeper
      - git
      - irqbalance
      - libsasl2-modules
      - logwatch
      - mailutils
      - postfix
      - python3-pip
      - sysstat
      - unattended-upgrades
      - unzip
      - vim
  tags: [debian, package]

- name: "etckeeper : Init /etc"
  command: etckeeper init
  args:
      creates: /etc/.git
  tags: [debian, etckeeper]

- name: "etckeeper : Initial commit"
  command: etckeeper commit "Initial commit"
  args:
    chdir: /etc
    creates: /etc/.git/logs
  tags: [debian, etckeeper]

- name: Set hostname
  hostname:
    name: "{{ inventory_hostname }}"
  tags: [debian, hostname]

- name: Add NTP servers
  lineinfile:
    dest: /etc/systemd/timesyncd.conf
    insertafter: '^#NTP='
    regexp: '^NTP='
    line: 'NTP=ntp.nict.jp ntp.jst.mfeed.ad.jp'
  notify: Restart systemd-timesyncd
  tags: [debian, time, systemd-timesyncd]

- name: "input : Set editing-mode to vi"
  lineinfile:
    dest: /etc/inputrc
    regexp: 'set editing-mode '
    line: 'set editing-mode vi'
  tags: [debian, input]

- name: Add a group for admin user
  group:
    name: "{{ admin }}"
    gid: 1001
  tags: [debian, user]

- name: Add admin user
  user:
    name: "{{ admin }}"
    uid: 1001
    group: "{{ admin }}"
    groups: "adm,sudo"
    shell: /bin/bash
    skeleton: /etc/skel
  tags: [debian, user]

- name: Allow sudo to admin user
  lineinfile:
    dest: /etc/sudoers.d/00-{{ admin }}
    regexp: '^{{ admin }}'
    line: '{{ admin }} ALL=(ALL) NOPASSWD: ALL'
    create: yes
    mode: 0440
    validate: 'visudo -cf %s'
  tags: [debian, user]

- name: Make .ssh dir for admin user
  file:
    path: /home/{{ admin }}/.ssh
    owner: "{{ admin }}"
    group: "{{ admin }}"
    state: directory
    mode: 0700
  tags: [debian, user]

- name: Copy id_rsa
  become_user: "{{ admin }}"
  copy:
    src: ~/.ssh/id_rsa
    dest: /home/{{ admin }}/.ssh/id_rsa
    mode: 0600
    follow: yes
  tags: [debian, user]

- name: Copy id_rsa.pub
  become_user: "{{ admin }}"
  copy:
    src: ~/.ssh/id_rsa.pub
    dest: /home/{{ admin }}/.ssh/id_rsa.pub
    follow: yes
  tags: [debian, user]