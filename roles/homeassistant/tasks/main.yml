---
- name: Install additional packages
  apt:
    name:
      - nfs-common
  tags: [homeassistant]

- name: Create a mount point
  file:
    path: /srv/homeassistant
    state: directory
  tags: [homeassistant]

- name: Config mount point
  ansible.posix.mount:
    src: "{{ nfs_server }}:/volume1/homeassistant"
    path: /srv/homeassistant
    opts: nfsvers=3,soft
    state: mounted
    fstype: nfs
  tags: [homeassistant]

- name: Add to docker-compose.yml
  blockinfile:
    path: /etc/docker-compose.yml
    block: |
      services:
        homeassistant:
          container_name: homeassistant
          image: homeassistant/raspberrypi3-homeassistant:stable
          volumes:
            - /srv/homeassistant:/config
            - /etc/localtime:/etc/localtime:ro
          restart: unless-stopped
          network_mode: host
  tags: [homeassistant]

- name: Copy groups.yaml
  copy:
    src: groups.yaml
    dest: /srv/homeassistant
  tags: [homeassistant]

- name: Config binary_sensor
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^automation:'
    regexp: '^binary_sensor:'
    line: "binary_sensor: !include binary_sensors.yaml"
  tags: [homeassistant]

- name: Copy binary_sensors.yaml
  copy:
    src: binary_sensors.yaml
    dest: /srv/homeassistant
  tags: [homeassistant]

- name: Config notify
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^binary_sensor:'
    regexp: '^notify:'
    line: "notify: !include notify.yaml"
  tags: [homeassistant]

- name: Copy notify.yaml
  copy:
    src: notify.yaml
    dest: /srv/homeassistant
  tags: [homeassistant]

- name: Copy scripts.yaml
  copy:
    src: scripts.yaml
    dest: /srv/homeassistant
  tags: [homeassistant]

- name: Config sensor
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^scene:'
    regexp: '^sensor:'
    line: "sensor: !include sensors.yaml"
  tags: [homeassistant]

- name: Copy sensors.yaml
  copy:
    src: sensors.yaml
    dest: /srv/homeassistant
  tags: [homeassistant]

- name: Config switch
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^sensor:'
    regexp: '^switch:'
    line: "switch: !include switches.yaml"
  tags: [homeassistant]

- name: Copy switches.yaml
  copy:
    src: switches.yaml
    dest: /srv/homeassistant
  tags: [homeassistant]

- name: Config zone
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^sensor:'
    regexp: '^zone:'
    line: "zone: !include zones.yaml"
  tags: [homeassistant]

- name: Copy zones.yaml
  template:
    src: zones.yaml.j2
    dest: /srv/homeassistant/zones.yaml
  tags: [homeassistant]

- name: Modify configuration.yaml
  blockinfile:
    path: /srv/homeassistant/configuration.yaml
    block: |
      fastdotcom:
      lovelace:
        mode: yaml
        dashboards: !include dashboards.yaml
      mqtt:
        broker: localhost
      speedtestdotnet:
        scan_interval:
          hours: 1
  tags: [homeassistant]

- name: Copy dashboards.yaml
  copy:
    src: dashboards.yaml
    dest: /srv/homeassistant
  tags: [homeassistant, homeassistant-ui]

- name: Copy ui-lovelace.yaml
  copy:
    src: ui-lovelace.yaml
    dest: /srv/homeassistant
  tags: [homeassistant, homeassistant-ui]

- name: Create a directory for UI
  file:
    path: /srv/homeassistant/ui
    state: directory
  tags: [homeassistant, homeassistant-ui]

- name: Copy home.yaml
  copy:
    src: home.yaml
    dest: /srv/homeassistant/ui
  tags: [homeassistant, homeassistant-ui]

- name: Copy network.yaml
  copy:
    src: network.yaml
    dest: /srv/homeassistant/ui
  tags: [homeassistant, homeassistant-ui]

- name: Start homeassistant container
  community.docker.docker_compose:
    project_src: /etc
  tags: [homeassistant]