---
- name: "package : Install packages"
  ansible.builtin.apt:
    name:
      - apparmor-utils
  tags:
    - homeassistant
    - install
    - homeassistant_package
    - homeassistant_package_install

- name: "certs : Create directory"
  ansible.builtin.file:
    path: /srv/homeassistant/config/certs
    state: directory
  tags:
    - homeassistant
    - init
    - certs
    - homeassistant_certs
    - homeassistant_certs_init

- name: "certs : Copy root certificate"
  ansible.builtin.copy:
    src: /etc/ssl/certs/ISRG_Root_X1.pem
    dest: /srv/homeassistant/config/certs
    remote_src: true
  tags:
    - homeassistant
    - config
    - certs
    - homeassistant_certs
    - homeassistant_certs_config

- name: "docker : Add compose service"
  ansible.builtin.blockinfile:
    path: /etc/compose.yml
    marker: "# {mark} ANSIBLE MANAGED BLOCK homeassistant"
    block: |2
        homeassistant:
          container_name: homeassistant
          image: ghcr.io/home-assistant/home-assistant:stable
          devices:
            - /dev/ttyUSB0:/dev/ttyUSB0
          volumes:
            - /dev/serial/by-id:/dev/serial/by-id
            - /etc/localtime:/etc/localtime:ro
            - /run/dbus:/run/dbus:ro
            - /srv/homeassistant/config:/config
          security_opt:
            - apparmor:unconfined
          network_mode: host
          privileged: true
          restart: unless-stopped
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - docker
    - homeassistant_docker
    - homeassistant_docker_config

- name: "docker : Pull latest Docker image"
  community.docker.docker_image_pull:
    name: ghcr.io/home-assistant/home-assistant
    tag: stable
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - update
    - docker
    - homeassistant_docker
    - homeassistant_docker_update

# Ref: https://github.com/home-assistant/core/issues/117768
- name: "apparmor : Download docker-default"
  ansible.builtin.get_url:
    url: https://github.com/home-assistant/core/files/9417617/docker-default.txt
    dest: /etc/apparmor.d/docker-default
  tags:
    - homeassistant
    - config
    - apparmor
    - homeassistant_apparmor
    - homeassistant_apparmor_config
    - homeassistant_apparmor_download

- name: "apparmor : Copy disable service"
  ansible.builtin.copy:
    src: aa-disable-homeassistant.service
    dest: /etc/systemd/system
  notify: "aa-disable-homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - apparmor
    - homeassistant_apparmor
    - homeassistant_apparmor_config

- name: "configuration : Copy default file"
  ansible.builtin.copy:
    src: configuration.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - homeassistant_configuration
    - homeassistant_configuration_config

- name: "automation : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    regexp: '^automation:'
    line: "automation: !include_dir_merge_list automations/"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - automation
    - homeassistant_automation
    - homeassistant_automation_config

- name: "automation : Create directory"
  ansible.builtin.file:
    path: /srv/homeassistant/config/automations
    state: directory
  tags:
    - homeassistant
    - init
    - automation
    - homeassistant_automation
    - homeassistant_automation_init

- name: "automation : Create blueprints directory"
  ansible.builtin.file:
    path: /srv/homeassistant/config/blueprints/automation
    state: directory
  tags:
    - homeassistant
    - init
    - automation
    - homeassistant_automation
    - homeassistant_automation_init

- name: "automation : Copy files"
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /srv/homeassistant/config/automations
  loop:
    - automations-alarm.yaml
    - automations-balcony.yaml
    - automations-bathroom-lights.yaml
    - automations-dads-room.yaml
    - automations-dads-room-climates.yaml
    - automations-dads-room-lights.yaml
    - automations-entrance.yaml
    - automations-info.yaml
    - automations-living-room.yaml
    - automations-living-room-climates.yaml
    - automations-living-room-lights.yaml
    - automations-moms-room.yaml
    - automations-moms-room-climates.yaml
    - automations-moms-room-lights.yaml
    - automations-modes.yaml
    - automations-others.yaml
    - automations-securities.yaml
  tags:
    - homeassistant
    - config
    - automation
    - homeassistant_automation
    - homeassistant_automation_config

- name: "secrets : Copy file"
  ansible.builtin.template:
    src: secrets.yaml.j2
    dest: /srv/homeassistant/config/secrets.yaml
    variable_start_string: "[%"
    variable_end_string: "%]"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - homeassistant_secrets
    - homeassistant_secrets_config

- name: "alarm : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^automation:'
    regexp: '^alarm_control_panel:'
    line: "alarm_control_panel: !include alarm_control_panels.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - alarm
    - homeassistant_alarm
    - homeassistant_alarm_config

- name: "alarm : Copy configuration"
  ansible.builtin.copy:
    src: alarm_control_panels.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - alarm
    - homeassistant_alarm
    - homeassistant_alarm_config

- name: "alexa : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^alarm_control_panel:'
    regexp: '^alexa:'
    line: "alexa: !include alexa.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - alexa
    - homeassistant_alexa
    - homeassistant_alexa_config

- name: "alexa : Copy configuration"
  ansible.builtin.copy:
    src: alexa.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - alexa
    - homeassistant_alexa
    - homeassistant_alexa_config

- name: "command-line : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^alexa:'
    regexp: '^command_line:'
    line: "command_line: !include command_lines.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - command-line
    - homeassistant_command-line
    - homeassistant_command-line_config

- name: "command-line : Copy configuration"
  ansible.builtin.copy:
    src: command_lines.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - command-line
    - homeassistant_command-line
    - homeassistant_command-line_config

- name: "homekit : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^command-line:'
    regexp: '^homekit:'
    line: "homekit: !include homekit.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - homekit
    - homeassistant_homekit
    - homeassistant_homekit_config

- name: "homekit : Copy configuration"
  ansible.builtin.copy:
    src: homekit.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - homekit
    - homeassistant_homekit
    - homeassistant_homekit_config

- name: "input-boolean : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^homekit:'
    regexp: '^input_boolean:'
    line: "input_boolean: !include input_booleans.yaml"
  tags:
    - homeassistant
    - config
    - input-boolean
    - homeassistant_input-boolean
    - homeassistant_input-boolean_config

- name: "input-boolean : Copy configuration"
  ansible.builtin.copy:
    src: input_booleans.yaml
    dest: /srv/homeassistant/config
  tags:
    - homeassistant
    - config
    - input-boolean
    - homeassistant_input-boolean
    - homeassistant_input-boolean_config

- name: "input-datetime : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^input_boolean:'
    regexp: '^input_datetime:'
    line: "input_datetime: !include input_datetimes.yaml"
  tags:
    - homeassistant
    - config
    - input-datetime
    - homeassistant_input-datetime
    - homeassistant_input-datetime_config

- name: "input-datetime : Copy configuration"
  ansible.builtin.copy:
    src: input_datetimes.yaml
    dest: /srv/homeassistant/config
  tags:
    - homeassistant
    - config
    - input-datetime
    - homeassistant_input-datetime
    - homeassistant_input-datetime_config

- name: "input-number : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^input_datetime:'
    regexp: '^input_number:'
    line: "input_number: !include input_numbers.yaml"
  tags:
    - homeassistant
    - config
    - input-number
    - homeassistant_input-number
    - homeassistant_input-number_config

- name: "input-number : Copy configuration"
  ansible.builtin.copy:
    src: input_numbers.yaml
    dest: /srv/homeassistant/config
  tags:
    - homeassistant
    - config
    - input-number
    - homeassistant_input-number
    - homeassistant_input-number_config

- name: "input-select : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^input_numbers:'
    regexp: '^input_select:'
    line: "input_select: !include input_selects.yaml"
  tags:
    - homeassistant
    - config
    - input-select
    - homeassistant_input-select
    - homeassistant_input-select_config

- name: "input-select : Copy configuration"
  ansible.builtin.copy:
    src: input_selects.yaml
    dest: /srv/homeassistant/config
  tags:
    - homeassistant
    - config
    - input-select
    - homeassistant_input-select
    - homeassistant_input-select_config

- name: "light : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^ios:'
    regexp: '^light:'
    line: "light: !include lights.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - light
    - homeassistant_light
    - homeassistant_light_config

- name: "light : Copy configuration"
  ansible.builtin.copy:
    src: lights.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - light
    - homeassistant_light
    - homeassistant_light_config

- name: "media-player : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^light:'
    regexp: '^media_player:'
    line: "media_player: !include media_players.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - media-player
    - homeassistant_media-player
    - homeassistant_media-player_config

- name: "media-player : Copy configuration"
  ansible.builtin.copy:
    src: media_players.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - media-player
    - homeassistant_media-player
    - homeassistant_media-player_config

- name: "mqtt : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^media_player:'
    regexp: '^mqtt:'
    line: "mqtt: !include mqtt.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - mqtt
    - homeassistant_mqtt
    - homeassistant_mqtt_config

- name: "mqtt : Copy configuration"
  ansible.builtin.copy:
    src: mqtt.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - mqtt
    - homeassistant_mqtt
    - homeassistant_mqtt_config

- name: "notify : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^mqtt:'
    regexp: '^notify:'
    line: "notify: !include notify.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - notify
    - homeassistant_notify
    - homeassistant_notify_config

- name: "notify : Copy configuration"
  ansible.builtin.copy:
    src: notify.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - notify
    - homeassistant_notify
    - homeassistant_notify_config

- name: "rest : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^notify:'
    regexp: '^rest:'
    line: "rest: !include rests.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - rest
    - homeassistant_rest
    - homeassistant_rest_config

- name: "rest : Copy configuration"
  ansible.builtin.copy:
    src: rests.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - rest
    - homeassistant_rest
    - homeassistant_rest_config

- name: "scene : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^rest:'
    regexp: '^scene:'
    line: "scene: !include scenes.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - scene
    - homeassistant_scene
    - homeassistant_scene_config

- name: "scene : Copy configuration"
  ansible.builtin.copy:
    src: scenes.yaml
    dest: /srv/homeassistant/config
  tags:
    - homeassistant
    - config
    - scene
    - homeassistant_scene
    - homeassistant_scene_config

- name: "script : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^scene:'
    regexp: '^script:'
    line: "script: !include scripts.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - script
    - homeassistant_script
    - homeassistant_script_config

- name: "script : Copy configuration"
  ansible.builtin.copy:
    src: scripts.yaml
    dest: /srv/homeassistant/config
  tags:
    - homeassistant
    - config
    - script
    - homeassistant_script
    - homeassistant_script_config

- name: "sensor : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^script:'
    regexp: '^sensor:'
    line: "sensor: !include sensors.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - sensor
    - homeassistant_sensor
    - homeassistant_sensor_config

- name: "sensor : Copy configuration"
  ansible.builtin.copy:
    src: sensors.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - sensor
    - homeassistant_sensor
    - homeassistant_sensor_config

- name: "shell-command : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^sensor:'
    regexp: '^shell_command:'
    line: "shell_command: !include shell_commands.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - shell-command
    - homeassistant_shell-command
    - homeassistant_shell-command_config

- name: "shell-command : Copy configuration"
  ansible.builtin.template:
    src: shell_commands.yaml.j2
    dest: /srv/homeassistant/config/shell_commands.yaml
    variable_start_string: "[%"
    variable_end_string: "%]"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - shell-command
    - homeassistant_shell-command
    - homeassistant_shell-command_config

- name: "switch : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^shell_command:'
    regexp: '^switch:'
    line: "switch: !include switches.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - switch
    - homeassistant_switch
    - homeassistant_switch_config

- name: "switch : Copy configuration"
  ansible.builtin.copy:
    src: switches.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - switch
    - homeassistant_switch
    - homeassistant_switch_config

- name: "template : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^switch:'
    regexp: '^template:'
    line: "template: !include templates.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - template
    - homeassistant_template
    - homeassistant_template_config

- name: "utility-meter : Copy configuration"
  ansible.builtin.copy:
    src: utility_meters.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - utility-meter
    - homeassistant_utility-meter
    - homeassistant_utility-meter_config

- name: "utility-meter : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^template:'
    regexp: '^utility_meter:'
    line: "utility_meter: !include utility_meters.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - utility-meter
    - homeassistant_utility-meter
    - homeassistant_utility-meter_config

- name: "template : Copy configuration"
  ansible.builtin.copy:
    src: templates.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - template
    - homeassistant_template
    - homeassistant_template_config

- name: "zone : Configure include"
  ansible.builtin.lineinfile:
    path: /srv/homeassistant/config/configuration.yaml
    insertafter: '^utility_meter:'
    regexp: '^zone:'
    line: "zone: !include zones.yaml"
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - zone
    - homeassistant_zone
    - homeassistant_zone_config

- name: "zone : Copy configuration"
  ansible.builtin.copy:
    src: zones.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - zone
    - homeassistant_zone
    - homeassistant_zone_config

- name: "customize : Copy configuration"
  ansible.builtin.copy:
    src: customize.yaml
    dest: /srv/homeassistant/config
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - homeassistant_customize
    - homeassistant_customize_config

- name: "custom : Create components directory"
  ansible.builtin.file:
    path: /srv/homeassistant/config/custom_components
    state: directory
  tags:
    - homeassistant
    - init
    - custom
    - homeassistant_custom
    - homeassistant_custom_init

- name: "frosted-glass : Download manager"
  ansible.builtin.unarchive:
    src: https://github.com/wessamlauf/frosted-glass-manager/archive/refs/tags/v{{ frosted_glass_manager_version }}.zip
    dest: /tmp
    remote_src: true
  tags:
    - homeassistant
    - install
    - custom
    - frosted-glass
    - homeassistant_frosted-glass
    - homeassistant_frosted-glass_install
    - homeassistant_frosted-glass_download

- name: "frosted-glass : Install manager"
  ansible.builtin.copy:
    src: /tmp/frosted-glass-manager-{{ frosted_glass_manager_version }}/custom_components/frosted_glass_manager
    dest: /srv/homeassistant/config/custom_components
    remote_src: true
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - custom
    - frosted-glass
    - homeassistant_frosted-glass
    - homeassistant_frosted-glass_config
    - homeassistant_frosted-glass_install

- name: "tuya : Download local integration"
  ansible.builtin.unarchive:
    src: https://github.com/make-all/tuya-local/archive/refs/tags/{{ tuya_local_version }}.zip
    dest: /tmp
    remote_src: true
  tags:
    - homeassistant
    - install
    - custom
    - tuya
    - homeassistant_tuya
    - homeassistant_tuya_install
    - homeassistant_tuya_download

- name: "tuya : Install local integration"
  ansible.builtin.copy:
    src: /tmp/tuya-local-{{ tuya_local_version }}/custom_components/tuya_local
    dest: /srv/homeassistant/config/custom_components
    remote_src: true
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - custom
    - tuya
    - homeassistant_tuya
    - homeassistant_tuya_config
    - homeassistant_tuya_install

- name: "theme : Create directory"
  ansible.builtin.file:
    path: /srv/homeassistant/config/themes
    state: directory
  tags:
    - homeassistant
    - init
    - theme
    - homeassistant_theme
    - homeassistant_theme_init

- name: "frosted-glass : Download themes"
  ansible.builtin.unarchive:
    src: https://github.com/wessamlauf/homeassistant-frosted-glass-themes/archive/refs/tags/v{{ frosted_glass_version }}.zip
    dest: /tmp
    remote_src: true
  tags:
    - homeassistant
    - install
    - theme
    - frosted-glass
    - homeassistant_frosted-glass
    - homeassistant_frosted-glass_install
    - homeassistant_frosted-glass_download

- name: "frosted-glass : Install themes"
  ansible.builtin.copy:
    src: /tmp/homeassistant-frosted-glass-themes-{{ frosted_glass_version }}/themes/{{ item }}
    dest: /srv/homeassistant/config/themes
    remote_src: true
  loop:
    - Frosted Glass.yaml
    - Frosted Glass Dark.yaml
    - Frosted Glass Light.yaml
  tags:
    - homeassistant
    - config
    - theme
    - frosted-glass
    - homeassistant_frosted-glass
    - homeassistant_frosted-glass_config
    - homeassistant_frosted-glass_install

- name: "lovelace : Create www directory"
  ansible.builtin.file:
    path: /srv/homeassistant/config/www
    state: directory
  tags:
    - homeassistant
    - init
    - lovelace
    - homeassistant_lovelace
    - homeassistant_lovelace_init

- name: "card-mod : Download"
  ansible.builtin.unarchive:
    src: https://github.com/thomasloven/lovelace-card-mod/archive/refs/tags/v{{ card_mod_version }}.tar.gz
    dest: /tmp
    remote_src: true
  tags:
    - homeassistant
    - install
    - lovelace
    - card-mod
    - homeassistant_card-mod
    - homeassistant_card-mod_install
    - homeassistant_card-mod_download

- name: "card-mod : Install"
  ansible.builtin.copy:
    src: /tmp/lovelace-card-mod-{{ card_mod_version }}/card-mod.js
    dest: /srv/homeassistant/config/www
    remote_src: true
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - lovelace
    - card-mod
    - homeassistant_card-mod
    - homeassistant_card-mod_config
    - homeassistant_card-mod_install

- name: "card-mod : Configure"
  ansible.builtin.blockinfile:
    path: /srv/homeassistant/config/configuration.yaml
    marker: "# {mark} ANSIBLE MANAGED BLOCK card-mod"
    insertafter: '^  themes:'
    block: |2
        extra_module_url:
          - /local/card-mod.js
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - lovelace
    - card-mod
    - homeassistant_card-mod
    - homeassistant_card-mod_config

- name: "mini-graph-card : Install"
  ansible.builtin.get_url:
    url: https://github.com/kalkih/mini-graph-card/releases/download/v{{ mini_graph_card_version }}/mini-graph-card-bundle.js
    dest: /srv/homeassistant/config/www
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - install
    - lovelace
    - mini-graph-card
    - homeassistant_mini-graph-card
    - homeassistant_mini-graph-card_install

- name: "mini-media-player : Install"
  ansible.builtin.get_url:
    url: https://github.com/kalkih/mini-media-player/releases/download/v{{ mini_media_player_version }}/mini-media-player-bundle.js
    dest: /srv/homeassistant/config/www
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - install
    - lovelace
    - mini-media-player
    - homeassistant_mini-media-player
    - homeassistant_mini-media-player_install

- name: "simple-weather-card : Install"
  ansible.builtin.get_url:
    url: https://github.com/kalkih/simple-weather-card/releases/download/v{{ simple_weather_card_version }}/simple-weather-card-bundle.js
    dest: /srv/homeassistant/config/www
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - install
    - lovelace
    - simple-weather-card
    - homeassistant_simple-weather-card
    - homeassistant_simple-weather-card_install

- name: "configuration : Configure main settings"
  ansible.builtin.blockinfile:
    path: /srv/homeassistant/config/configuration.yaml
    block: |
      homeassistant:
        name: "Home"
        latitude: !secret latlng_home_lat
        longitude: !secret latlng_home_lng
        elevation: 40
        unit_system: metric
        temperature_unit: C
        time_zone: "Asia/Tokyo"
        country: "JP"
        currency: "JPY"
        external_url: "https://hass.rewse.jp/"
        internal_url: "https://hass.rewse.jp/"
        customize: !include customize.yaml
      http:
        use_x_forwarded_for: true
        trusted_proxies:
          - "127.0.0.0/8"
          - "192.168.0.0/24"
          - "::1/128"
          - "fe80::/10"
          - "240f:78:31e9:1::/64"
      logger:
        default: warning
        logs:
          androidtv.adb_manager.adb_manager_async: error
          homeassistant.components.androidtv.media_player: error
          homeassistant.components.imap_email_content.sensor: warning
      lovelace:
        mode: storage
      recorder:
        db_url: !secret postgres_connstr
        purge_keep_days: 450
      zha:
        zigpy_config:
          ota:
            ikea_provider: true
  notify: "homeassistant: Restart"
  tags:
    - homeassistant
    - config
    - homeassistant_configuration
    - homeassistant_configuration_config

- name: "apache : Enable proxy modules"
  community.general.apache2_module:
    name: "{{ item }}"
  loop:
    - proxy
    - proxy_http
    - proxy_wstunnel
  notify: "apache: Restart"
  tags:
    - homeassistant
    - config
    - apache
    - homeassistant_apache
    - homeassistant_apache_config

- name: "apache : Copy vhost configuration"
  ansible.builtin.copy:
    src: hass.rewse.jp.conf
    dest: /etc/apache2/sites-available
  notify: "apache: Reload"
  tags:
    - homeassistant
    - config
    - apache
    - homeassistant_apache
    - homeassistant_apache_config

- name: "apache : Enable site"
  ansible.builtin.command: a2ensite hass.rewse.jp
  notify: "apache: Reload"
  tags:
    - homeassistant
    - config
    - apache
    - homeassistant_apache
    - homeassistant_apache_config
