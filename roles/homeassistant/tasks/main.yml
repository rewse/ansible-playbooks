---
- name: Install additional packages
  apt:
    name:
      - certbot
      - python3-certbot-apache
  tags: [homeassistant, package]

- name: Add to docker-compose.yml
  blockinfile:
    path: /etc/docker-compose.yml
    block: |
      services:
        homeassistant:
          container_name: homeassistant
          image: homeassistant/raspberrypi3-homeassistant:stable
          volumes:
            - /etc/homeassistant:/config
            - /etc/localtime:/etc/localtime:ro
          restart: unless-stopped
          network_mode: host
  tags: [homeassistant]

- name: Copy secrets.yaml
  template:
    src: secrets.yaml.j2
    dest: /etc/homeassistant/secrets.yaml
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy automations.yaml
  copy:
    src: automations.yaml
    dest: /etc/homeassistant
  tags: [homeassistant, homeassistant-automations]

- name: Config binary_sensor
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^automation:'
    regexp: '^binary_sensor:'
    line: "binary_sensor: !include binary_sensors.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy binary_sensors.yaml
  template:
    src: binary_sensors.yaml.j2
    dest: /etc/homeassistant/binary_sensors.yaml
    variable_start_string: "[%"
    variable_end_string: "%]"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config climate
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^binary_sensor:'
    regexp: '^climate:'
    line: "climate: !include climates.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy climates.yaml
  copy:
    src: climates.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config cover
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^climate:'
    regexp: '^cover:'
    line: "cover: !include covers.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy covers.yaml
  copy:
    src: covers.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config fan
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^cover:'
    regexp: '^fan:'
    line: "fan: !include fans.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy fans.yaml
  copy:
    src: fans.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config group
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^fan:'
    regexp: '^group:'
    line: "group: !include groups.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy groups.yaml
  copy:
    src: groups.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config input_boolean
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^group:'
    regexp: '^input_boolean:'
    line: "input_boolean: !include input_booleans.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy input_booleans.yaml
  copy:
    src: input_booleans.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config homekit
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^input_boolean:'
    regexp: '^homekit:'
    line: "homekit: !include homekit.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy homekit.yaml
  copy:
    src: homekit.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config input_datetime
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^homekit:'
    regexp: '^input_datetime:'
    line: "input_datetime: !include input_datetimes.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy input_datetimes.yaml
  copy:
    src: input_datetimes.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config input_number
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^input_datetime:'
    regexp: '^input_number:'
    line: "input_number: !include input_numbers.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy input_numbers.yaml
  copy:
    src: input_numbers.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config light
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^input_number:'
    regexp: '^light:'
    line: "light: !include lights.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy lights.yaml
  copy:
    src: lights.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config localtuya
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^light:'
    regexp: '^localtuya:'
    line: "localtuya: !include localtuyas.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy localtuyas.yaml
  copy:
    src: localtuyas.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config media_player
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^localtuya:'
    regexp: '^media_player:'
    line: "media_player: !include media_players.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy media_players.yaml
  copy:
    src: media_players.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config notify
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^media_player:'
    regexp: '^notify:'
    line: "notify: !include notify.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy notify.yaml
  copy:
    src: notify.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config rest_command
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^nofity:'
    regexp: '^rest_command:'
    line: "rest_command: !include rest_commands.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy rest_commands.yaml
  copy:
    src: rest_commands.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy scripts.yaml
  copy:
    src: scripts.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config sensor
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^scene:'
    regexp: '^sensor:'
    line: "sensor: !include sensors.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy sensors.yaml
  template:
    src: sensors.yaml.j2
    dest: /etc/homeassistant/sensors.yaml
    variable_start_string: "[%"
    variable_end_string: "%]"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config shell_command
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^switch:'
    regexp: '^shell_command:'
    line: "shell_command: !include shell_commands.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy shell_commands.yaml.j2
  template:
    src: shell_commands.yaml.j2
    dest: /etc/homeassistant/shell_commands.yaml
    variable_start_string: "[%"
    variable_end_string: "%]"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config switch
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^sensor:'
    regexp: '^switch:'
    line: "switch: !include switches.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy switches.yaml
  copy:
    src: switches.yaml
    dest: /etc/homeassistant
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Config zone
  lineinfile:
    path: /etc/homeassistant/configuration.yaml
    insertafter: '^switch:'
    regexp: '^zone:'
    line: "zone: !include zones.yaml"
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy zones.yaml
  template:
    src: zones.yaml.j2
    dest: /etc/homeassistant/zones.yaml
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Create certs dir
  file:
    path: /etc/homeassistant/certs
    state: directory
  tags: [homeassistant]

- name: Copy DST_Root_CA_X3.pem
  copy:
    src: /etc/ssl/certs/DST_Root_CA_X3.pem
    dest: /etc/homeassistant/certs
    remote_src: yes
  tags: [homeassistant]

- name: Create custom_components/nature_remo
  file:
    path: /etc/homeassistant/custom_components/nature_remo
    state: directory
  tags: [homeassistant]

- name: Clone hass-nature-remo.git
  git:
    repo: https://github.com/yutoyazaki/hass-nature-remo.git
    dest: /etc/homeassistant/custom_components/nature_remo
    force: yes
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Clone localtuya.git
  git:
    repo: https://github.com/rospogrigio/localtuya.git
    dest: /srv/git/localtuya
    force: yes
  tags: [homeassistant]

- name: Copy localtuya.git
  copy:
    src: /srv/git/localtuya/custom_components/localtuya
    dest: /etc/homeassistant/custom_components
    remote_src: yes
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Create www dir
  file:
    path: /etc/homeassistant/www
    state: directory
  tags: [homeassistant]

- name: Copy Lovelace Mini Graph Card
  get_url:
    url: https://github.com/kalkih/mini-graph-card/releases/download/v0.10.0/mini-graph-card-bundle.js
    dest: /etc/homeassistant/www
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy Lovelace Mini Media Player
  get_url:
    url: https://github.com/kalkih/mini-media-player/releases/download/v1.12.0/mini-media-player-bundle.js
    dest: /etc/homeassistant/www
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy Lovelace Simeple Weather Card
  get_url:
    url: https://github.com/kalkih/simple-weather-card/releases/download/v0.8.1/simple-weather-card-bundle.js
    dest: /etc/homeassistant/www
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy Lovelace Uptime Card
  get_url:
    url: https://github.com/dylandoamaral/uptime-card/releases/download/v0.0.4/uptime-card.js
    dest: /etc/homeassistant/www
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Download XiaomiGateway3
  unarchive:
    src: https://github.com/AlexxIT/XiaomiGateway3/archive/refs/tags/v1.0.1.zip
    dest: /tmp
    remote_src: yes
  tags: [homeassistant]

- name: Copy XiaomiGateway3
  copy:
    src: /tmp/XiaomiGateway3-1.0.1/custom_components/xiaomi_gateway3
    dest: /etc/homeassistant/custom_components
    remote_src: yes
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Modify configuration.yaml
  blockinfile:
    path: /etc/homeassistant/configuration.yaml
    block: |
      homeassistant:
        name: Home
        latitude: !secret latlng_home_lat
        longitude: !secret latlng_home_lng
        elevation: 40
        unit_system: metric
        temperature_unit: C
        time_zone: Asia/Tokyo
        external_url: https://hass.rewse.jp/
        internal_url: https://hass.rewse.jp/
      fastdotcom:
      http:
        use_x_forwarded_for: true
        trusted_proxies:
          - 127.0.0.0/8
          - 192.168.0.0/24
      ifttt:
        key: !secret ifttt_key
      lovelace:
        mode: yaml
        dashboards: !include dashboards.yaml
        resources:
          - url: /local/mini-graph-card-bundle.js?v=0.10.0
            type: module
          - url: /local/mini-media-player-bundle.js?v=1.12.0
            type: module
          - url: /local/simple-weather-card-bundle.js?v=0.8.1
            type: module
          - url: /local/uptime-card.js
            type: module
      mqtt:
        broker: hass.rewse.jp
        port: 8883
        username: sub_client
        password: !secret mosquitto_password
        certificate: /config/certs/DST_Root_CA_X3.pem
      nature_remo:
        access_token: !secret remo_token
      recorder:
        db_url: !secret postgres_connstr
        purge_keep_days: 450
      speedtestdotnet:
        scan_interval:
          hours: 1
      tplink:
        discovery: false
        switch:
          - host: kasaplug-liv.rewse.jp
          - host: kasaplug-ent.rewse.jp
  notify: Restart homeassistant
  tags: [homeassistant]

- name: Copy dashboards.yaml
  copy:
    src: dashboards.yaml
    dest: /etc/homeassistant
  tags: [homeassistant, homeassistant-ui]

- name: Copy ui-lovelace.yaml
  copy:
    src: ui-lovelace.yaml
    dest: /etc/homeassistant
  tags: [homeassistant, homeassistant-ui]

- name: Create a directory for UI
  file:
    path: /etc/homeassistant/ui
    state: directory
  tags: [homeassistant, homeassistant-ui]

- name: Copy home.yaml
  copy:
    src: home.yaml
    dest: /etc/homeassistant/ui
  tags: [homeassistant, homeassistant-ui]

- name: Copy livingroom.yaml
  copy:
    src: livingroom.yaml
    dest: /etc/homeassistant/ui
  tags: [homeassistant, homeassistant-ui]

- name: Copy bedroom.yaml
  copy:
    src: bedroom.yaml
    dest: /etc/homeassistant/ui
  tags: [homeassistant, homeassistant-ui]

- name: Copy bathroom.yaml
  copy:
    src: bathroom.yaml
    dest: /etc/homeassistant/ui
  tags: [homeassistant, homeassistant-ui]

- name: Copy machines.yaml
  copy:
    src: machines.yaml
    dest: /etc/homeassistant/ui
  tags: [homeassistant, homeassistant-ui]

- name: Start homeassistant container
  community.docker.docker_compose:
    project_src: /etc
  tags: [homeassistant]

- name: Enable proxy
  community.general.apache2_module:
    name: "{{ item }}"
  with_items:
    - proxy
    - proxy_http
    - proxy_wstunnel
  notify: Restart apache
  tags: [homeassistant, homeassistant-apache]

- name: Copy hass.rewse.jp.conf
  copy:
    src: hass.rewse.jp.conf
    dest: /etc/apache2/sites-available
  notify: Reload apache
  tags: [homeassistant, homeassistant-apache]

- name: Enable hass.rewse.jp
  command: a2ensite hass.rewse.jp
  notify: Reload apache
  tags: [homeassistant, homeassistant-apache]
  