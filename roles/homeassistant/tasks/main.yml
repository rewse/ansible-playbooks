---
- name: Install additional packages
  apt:
    name:
      - certbot
      - nfs-common
      - python3-certbot-apache
  tags: [homeassistant]

- name: Create a mount point
  file:
    path: /srv/homeassistant
    state: directory
  tags: [homeassistant]

- name: Config mount point
  ansible.posix.mount:
    src: "{{ nfs_server }}:/volume1/homeassistant"
    path: /srv/homeassistant
    opts: nfsvers=3,soft
    state: mounted
    fstype: nfs
  tags: [homeassistant]

- name: Add to docker-compose.yml
  blockinfile:
    path: /etc/docker-compose.yml
    block: |
      services:
        homeassistant:
          container_name: homeassistant
          image: homeassistant/raspberrypi3-homeassistant:stable
          volumes:
            - /srv/homeassistant:/config
            - /etc/localtime:/etc/localtime:ro
          restart: unless-stopped
          network_mode: host
  tags: [homeassistant]

- name: Config binary_sensor
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^automation:'
    regexp: '^binary_sensor:'
    line: "binary_sensor: !include binary_sensors.yaml"
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy binary_sensors.yaml
  copy:
    src: binary_sensors.yaml
    dest: /srv/homeassistant
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Config group
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^binary_sesnsor:'
    regexp: '^group:'
    line: "group: !include groups.yaml"
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy groups.yaml
  copy:
    src: groups.yaml
    dest: /srv/homeassistant
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Config input_datetime
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^group:'
    regexp: '^input_datetime'
    line: "input_datetime: !include input_datetimes.yaml"
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy input_datetimes.yaml
  copy:
    src: input_datetimes.yaml
    dest: /srv/homeassistant
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Config input_number
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^input_datetime:'
    regexp: '^input_number:'
    line: "input_number: !include input_numbers.yaml"
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy input_numbers.yaml
  copy:
    src: input_numbers.yaml
    dest: /srv/homeassistant
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Config media_player
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^input_number:'
    regexp: '^media_player:'
    line: "media_player: !include media_players.yaml"
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy media_players.yaml
  copy:
    src: media_players.yaml
    dest: /srv/homeassistant
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Config notify
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^media_player:'
    regexp: '^notify:'
    line: "notify: !include notify.yaml"
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy notify.yaml
  copy:
    src: notify.yaml
    dest: /srv/homeassistant
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy scripts.yaml
  copy:
    src: scripts.yaml
    dest: /srv/homeassistant
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Config sensor
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^scene:'
    regexp: '^sensor:'
    line: "sensor: !include sensors.yaml"
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy sensors.yaml
  copy:
    src: sensors.yaml
    dest: /srv/homeassistant
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Config switch
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^sensor:'
    regexp: '^switch:'
    line: "switch: !include switches.yaml"
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy switches.yaml
  template:
    src: switches.yaml.j2
    dest: /srv/homeassistant/switches.yaml
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Config zone
  lineinfile:
    path: /srv/homeassistant/configuration.yaml
    insertafter: '^sensor:'
    regexp: '^zone:'
    line: "zone: !include zones.yaml"
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy zones.yaml
  template:
    src: zones.yaml.j2
    dest: /srv/homeassistant/zones.yaml
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Create custom_components/nature_remo
  file:
    path: /srv/homeassistant/custom_components
    state: directory
  tags: [homeassistant]

- name: Clone hass-nature-remo.git
  git:
    repo: https://github.com/yutoyazaki/hass-nature-remo.git
    dest: /srv/homeassistant/custom_components/nature_remo
    force: yes
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Modify configuration.yaml
  blockinfile:
    path: /srv/homeassistant/configuration.yaml
    block: |
      fastdotcom:
      homekit:
        filter:
          include_domains:
            - media_player
          include_entities:
            - climate.nature_remo_living_room_ac
            - script.toggle_all_floor_heatings
            - sensor.living_room_humidity
            - sensor.living_room_temperature
            - sensor.bedroom_humidity
            - sensor.bedroom_temperature
            - sensor.storage_temperature
            - sensor.storage_humidity
            - sensor.balcony_humidity
            - sensor.balcony_temperature
            - switch.entrance_zulu_power
            - switch.living_room_ac_cleaner
            - switch.living_room_dimming_downlights
            - switch.living_room_downlights
            - switch.living_room_floor_heating
            - switch.living_room_footlight
            - switch.living_room_humidifier
            - switch.living_room_ceiling_fan
            - switch.study_floor_heating
      lovelace:
        mode: yaml
        dashboards: !include dashboards.yaml
      mqtt:
        broker: localhost
        username: sub_client
        password: {{ mosquitto_password }}
      nature_remo:
        access_token: "{{ remo_token }}"
      recorder:
        purge_keep_days: 450
      speedtestdotnet:
        scan_interval:
          hours: 1
      tplink:
  notify: Restart homeassistant container
  tags: [homeassistant]

- name: Copy dashboards.yaml
  copy:
    src: dashboards.yaml
    dest: /srv/homeassistant
  tags: [homeassistant, homeassistant-ui]

- name: Copy ui-lovelace.yaml
  copy:
    src: ui-lovelace.yaml
    dest: /srv/homeassistant
  tags: [homeassistant, homeassistant-ui]

- name: Create a directory for UI
  file:
    path: /srv/homeassistant/ui
    state: directory
  tags: [homeassistant, homeassistant-ui]

- name: Copy home.yaml
  copy:
    src: home.yaml
    dest: /srv/homeassistant/ui
  tags: [homeassistant, homeassistant-ui]

- name: Copy network.yaml
  copy:
    src: network.yaml
    dest: /srv/homeassistant/ui
  tags: [homeassistant, homeassistant-ui]

- name: Copy mediaplayer.yaml
  copy:
    src: mediaplayer.yaml
    dest: /srv/homeassistant/ui
  tags: [homeassistant, homeassistant-ui]

- name: Start homeassistant container
  community.docker.docker_compose:
    project_src: /etc
  tags: [homeassistant]

- name: Copy index.html
  copy:
    src: index.html
    dest: /srv/www/html
  tags: [homeassistant]

- name: Enable proxy
  community.general.apache2_module:
    name: "{{ item }}"
  with_items:
    - proxy
    - proxy_http
    - proxy_wstunnel
  notify: Restart apache
  tags: [apache]

- name: Copy hass.rewse.jp.conf
  copy:
    src: hass.rewse.jp.conf
    dest: /etc/apache2/sites-available
  notify: Reload apache
  tags: [homeassistant]

- name: Enable hass.rewse.jp
  command: a2ensite hass.rewse.jp
  notify: Reload apache
  tags: [apache]
  