---
- name: Set timezone
  community.general.timezone:
    name: Asia/Tokyo
  tags: [ubuntu, time]

- name: Add an apt key
  ansible.builtin.get_url:
    url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
    dest: /etc/apt/keyrings/githubcli-archive-keyring.gpg
  tags: [ubuntu, package]

- name: Add a repository for GitHub
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
    filename: github-cli
  when:
    ansible_architecture == "x86_64"
  tags: [ubuntu, package]

- name: Add a repository for GitHub
  ansible.builtin.apt_repository:
    repo: "deb [arch=arm64 signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
    filename: github-cli
  when:
    ansible_architecture == "aarch64"
  tags: [ubuntu, package]

- name: "1password : Download GPG key"
  ansible.builtin.get_url:
    url: https://downloads.1password.com/linux/keys/1password.asc
    dest: /tmp/1password.asc
  tags: [ubuntu, package, 1password]

- name: "1password : Dearmor GPG key for apt"
  ansible.builtin.shell: gpg --dearmor < /tmp/1password.asc > /usr/share/keyrings/1password-archive-keyring.gpg
  args:
    creates: /usr/share/keyrings/1password-archive-keyring.gpg
  tags: [ubuntu, package, 1password]

- name: "1password : Add apt repository"
  ansible.builtin.apt_repository:
    repo: "deb [arch={{ ansible_architecture | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }} signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/{{ ansible_architecture | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }} stable main"
    filename: 1password
  tags: [ubuntu, package, 1password]

- name: "1password : Create debsig policies directory"
  ansible.builtin.file:
    path: /etc/debsig/policies/AC2D62742012EA22
    state: directory
  tags: [ubuntu, package, 1password]

- name: "1password : Download debsig policy"
  ansible.builtin.get_url:
    url: https://downloads.1password.com/linux/debian/debsig/1password.pol
    dest: /etc/debsig/policies/AC2D62742012EA22/1password.pol
  tags: [ubuntu, package, 1password]

- name: "1password : Create debsig keyrings directory"
  ansible.builtin.file:
    path: /usr/share/debsig/keyrings/AC2D62742012EA22
    state: directory
  tags: [ubuntu, package, 1password]

- name: "1password : Dearmor GPG key for debsig"
  ansible.builtin.shell: gpg --dearmor < /tmp/1password.asc > /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
  args:
    creates: /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
  tags: [ubuntu, package, 1password]

- name: Update all packages
  ansible.builtin.apt:
    name: '*'
    state: latest
    update_cache: true
  tags: [ubuntu, package]

- name: Install additional packages
  ansible.builtin.apt:
    name:
      - 1password-cli
      - apt-file
      - at
      - bat
      - bc
      - curl
      - dphys-swapfile
      - dnsutils
      - etckeeper
      - gh
      - git
      - irqbalance
      - libsasl2-modules
      - libwww-perl
      - locales-all
      - logwatch
      - iw
      - mailutils
      - ncdu
      - net-tools
      - postfix
      - python3-pip
      - python3-venv
      - sysstat
      - tldr
      - tree
      - unattended-upgrades
      - unzip
      - update-notifier-common
      - vim
      - wireless-tools
      - zsh
      - zsh-vi-mode
  tags: [ubuntu, package]

- name: Stat awscliv2
  ansible.builtin.stat:
    path: /usr/local/bin/aws
  register: aws
  tags: [ubuntu, package, awscliv2]

- name: Unarchive awscliv2
  ansible.builtin.unarchive:
    src: https://awscli.amazonaws.com/awscli-exe-linux-{{ ansible_architecture }}.zip
    dest: /usr/local/src
    remote_src: true
  when: not aws.stat.exists
  tags: [ubuntu, package, awscliv2]

- name: Install awscliv2
  ansible.builtin.command: /usr/local/src/aws/install
  when: not aws.stat.exists
  tags: [ubuntu, package, awscliv2]

- name: Update awscliv2
  ansible.builtin.command: /usr/local/src/aws/install --update
  when: aws.stat.exists
  tags: [ubuntu, package, awscliv2]

- name: Install Kiro CLI
  become_user: "{{ admin }}"
  ansible.builtin.shell: curl -fsSL https://cli.kiro.dev/install | bash
  args:
    creates: /home/{{ admin }}/.local/bin/kiro-cli
  tags: [ubuntu, package, kiro-cli]

- name: Install uv
  become_user: "{{ admin }}"
  ansible.builtin.shell: curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: /home/{{ admin }}/.local/bin/uv
  tags: [ubuntu, package, uv]

- name: "etckeeper : Init /etc"
  ansible.builtin.command: etckeeper init
  args:
    creates: /etc/.git
  tags: [ubuntu, etckeeper]

- name: "etckeeper : Initial commit"
  ansible.builtin.command: etckeeper commit "Initial commit"
  args:
    chdir: /etc
    creates: /etc/.git/logs
  tags: [ubuntu, etckeeper]

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
  tags: [ubuntu, hostname]

- name: "cloud-init : Enable preserve_hostname"
  ansible.builtin.lineinfile:
    dest: /etc/cloud/cloud.cfg
    regexp: '^preserve_hostname'
    line: 'preserve_hostname: true'
  tags: [ubuntu, cloud-init]

- name: "input : Set editing-mode to vi"
  ansible.builtin.lineinfile:
    dest: /etc/inputrc
    regexp: 'set editing-mode '
    line: 'set editing-mode vi'
  tags: [ubuntu, input]

- name: Add a group for admin user
  ansible.builtin.group:
    name: "{{ admin }}"
    gid: 2000
  tags: [ubuntu, user]

- name: Add admin user
  ansible.builtin.user:
    name: "{{ admin }}"
    uid: 2000
    group: "{{ admin }}"
    groups: "adm,sudo"
    shell: /usr/bin/zsh
    skeleton: /etc/skel
  tags: [ubuntu, user]

- name: Allow sudo to admin user
  ansible.builtin.lineinfile:
    dest: /etc/sudoers.d/00-{{ admin }}
    regexp: '^{{ admin }}'
    line: '{{ admin }} ALL=(ALL) NOPASSWD: ALL'
    create: true
    mode: '0440'
    validate: 'visudo -cf %s'
  tags: [ubuntu, user]

- name: Make .ssh dir for admin user
  ansible.builtin.file:
    path: /home/{{ admin }}/.ssh
    owner: "{{ admin }}"
    group: "{{ admin }}"
    state: directory
    mode: '0700'
  tags: [ubuntu, user]

- name: Copy authentication.conf
  ansible.builtin.copy:
    src: authentication.conf
    dest: /etc/ssh/sshd_config.d
  notify: Restart ssh
  tags: [ubuntu, ssh]

- name: Copy authorized_keys
  ansible.builtin.copy:
    src: /home/ubuntu/.ssh/authorized_keys
    dest: /home/{{ admin }}/.ssh/authorized_keys
    remote_src: true
    owner: "{{ admin }}"
    group: "{{ admin }}"
    mode: '0600'
  tags: [ubuntu, user]

# Ref: https://ghostty.org/docs/help/terminfo
- name: Copy xterm-ghostty
  ansible.builtin.copy:
    src: xterm-ghostty
    dest: /usr/share/terminfo/x/xterm-ghostty
  tags: [ubuntu, ghostty]

- name: Create a link, ghostty
  ansible.builtin.file:
    src: ../x/xterm-ghostty
    dest: /usr/share/terminfo/g/ghostty
    state: link
  tags: [ubuntu, ghostty]
