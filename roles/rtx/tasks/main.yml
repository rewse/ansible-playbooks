---
# - name: Set up SSH
#   do_it_yourself_rtx_config:
#     lines:
#       - login user username password
#       - sshd host key generate
#       - sshd service on

- name: Set login
  rtx_config:
    lines:
      - login timer 3600
  tags: [rtx, rtx-login]

- name: Set security
  rtx_config:
    lines:
      - security class 2 on off off
  tags: [rtx, rtx-security]

- name: Set console
  rtx_config:
    lines:
      - console character ascii
      - console lines infinity
      - console prompt [{{ rtx.hostname }}]
  tags: [rtx, rtx-console]

- name: Set ip
  rtx_config:
    lines:
      - ip route default gateway {{ default_gateway.ip }}
      - ip keepalive 1 icmp-echo 10 5 {{ default_gateway.ip }}
      - ip lan1 address {{ lan1.ip }}/{{ lan1.netmask }}
      - ip lan1 proxyarp on
      - ip lan2 address {{ lan2.ip }}/{{ lan2.netmask }}
  tags: [rtx, rtx-ip]

- name: Set syslog
  rtx_config:
    lines:
      - syslog host {{ fox.ip }}
      - syslog execute command on
  tags: [rtx, rtx-syslog]

- name: Set telnet
  rtx_config:
    lines:
      - telnetd host lan1
  tags: [rtx, rtx-telnet]

- name: Set dhcpd
  rtx_config:
    lines:
      - dhcp service server
      # RTX1200 cannot set multiple DHCP scopes for the single network.
      # Ref: http://www.rtpro.yamaha.co.jp/RT/manual/rt-common/dhcp/dhcp_scope.html
      - dhcp scope 1 192.168.0.4-192.168.0.254/24 except 192.168.0.5-192.168.0.9 192.168.0.11 192.168.0.13-192.168.0.19 192.168.0.21-192.168.0.29 192.168.0.33-192.168.0.39 192.168.0.43-192.168.0.69 192.168.0.73-192.168.0.79 192.168.0.81 192.168.0.83 192.168.0.85 192.168.0.87 192.168.0.89-192.168.0.99 192.168.0.101 192.168.0.103 192.168.0.105 192.168.0.107 192.168.0.109 192.168.0.111-192.168.0.119 192.168.0.127-192.168.0.199 expire 0:05 maxexpire 0:05
      - dhcp scope bind 1 192.168.0.4 ethernet 9c:c9:eb:0a:ec:f9
      - dhcp scope bind 1 192.168.0.10 ethernet 9c:c9:eb:da:1d:0f
      - dhcp scope bind 1 192.168.0.12 ethernet 9c:c9:eb:d9:f2:cf
      - dhcp scope bind 1 192.168.0.20 ethernet 00:11:32:60:bf:d3
      - dhcp scope bind 1 192.168.0.30 ethernet ca:23:33:ee:19:83
      - dhcp scope bind 1 192.168.0.31 ethernet dc:a6:32:ec:3f:01
      - dhcp scope bind 1 192.168.0.32 ethernet dc:a6:32:ec:3f:02
      - dhcp scope bind 1 192.168.0.40 ethernet 7a:5e:b0:92:ee:35
      - dhcp scope bind 1 192.168.0.41 ethernet b8:27:eb:64:56:38
      - dhcp scope bind 1 192.168.0.42 ethernet b8:27:eb:31:03:6d
      - dhcp scope bind 1 192.168.0.70 ethernet 18:4f:32:c1:96:85
      - dhcp scope bind 1 192.168.0.71 ethernet 30:05:5c:b1:e7:d2
      - dhcp scope bind 1 192.168.0.72 ethernet b0:e8:92:90:31:34
      - dhcp scope bind 1 192.168.0.80 ethernet 00:a0:de:d3:02:98
      - dhcp scope bind 1 192.168.0.82 ethernet ec:21:e5:ec:73:a5
      - dhcp scope bind 1 192.168.0.84 ethernet 38:f7:3d:21:db:ae
      - dhcp scope bind 1 192.168.0.86 ethernet 44:e4:ee:8b:50:57
      - dhcp scope bind 1 192.168.0.88 ethernet 70:66:55:b5:ae:e4
      - dhcp scope bind 1 192.168.0.100 ethernet 84:f3:eb:a2:86:ad
      - dhcp scope bind 1 192.168.0.102 ethernet a4:cf:12:fd:d4:27
      - dhcp scope bind 1 192.168.0.104 ethernet 80:c5:f2:77:4e:a4
      - dhcp scope bind 1 192.168.0.106 ethernet 84:f3:eb:6b:ae:52
      - dhcp scope bind 1 192.168.0.108 ethernet 00:17:88:7e:e5:22
      - dhcp scope bind 1 192.168.0.110 ethernet 54:ef:44:24:3e:fb
      - dhcp scope bind 1 192.168.0.120 ethernet d8:07:b6:ac:04:01
      - dhcp scope bind 1 192.168.0.121 ethernet 24:68:80:06:ed:79
      - dhcp scope bind 1 192.168.0.122 ethernet 24:68:80:00:55:3c
      - dhcp scope bind 1 192.168.0.123 ethernet b0:be:76:2a:31:2b
      - dhcp scope bind 1 192.168.0.124 ethernet b0:be:76:2a:35:07
      - dhcp scope bind 1 192.168.0.125 ethernet f4:cf:a2:05:91:92
      - dhcp scope bind 1 192.168.0.126 ethernet 18:fe:34:96:8c:19
      - dhcp scope option 1 dns=192.168.0.30,192.168.0.40 domain=rewse.jp
  tags: [rtx, rtx-dhcpd]

- name: Set dns
  rtx_config:
    lines:
      - dns server {{ resolved1.ip }} {{ resolved2.ip }}
      - dns private address spoof on
  tags: [rtx, rtx-dns]

- name: Set schedule
  rtx_config:
    lines:
      - schedule at 100 */* 04:52:16 * ntpdate {{ ntpd.fqdn }} syslog
      - schedule at 101 */* 10:52:16 * ntpdate {{ ntpd.fqdn }} syslog
      - schedule at 102 */* 16:52:16 * ntpdate {{ ntpd.fqdn }} syslog
      - schedule at 103 */* 22:52:16 * ntpdate {{ ntpd.fqdn }} syslog
  tags: [rtx, rtx-schedule]

- name: Set httpd
  rtx_config:
    lines:
      - httpd host lan1
  tags: [rtx, rtx-httpd]

- name: Set sshd
  rtx_config:
    lines:
      - sshd host lan1
  tags: [rtx, rtx-sshd]

- name: Set sntpd
  rtx_config:
    lines:
      - sntpd service on
      - sntpd host lan1
  tags: [rtx, rtx-sntpd]

- name: Set ip interface secure filter
  rtx_config:
    lines:
      - ip lan1 secure filter in 100000 100001 100002 100003 100004 100005 100006 100007 100099
      - ip lan2 secure filter in 101 102 2001 2002 3001 3002 3003 3004 4001 4002 101003 101020 101021 101022 101023 101024 101025 101030 101032 101080 101081 101082 101083
      - ip lan2 secure filter out 101013 101020 101021 101022 101023 101024 101025 101026 101027 101099 dynamic 101080 101081 101082 101083 101084 101085 101098 101099
  tags: [rtx, rtx-port]

- name: Open ports
  rtx_config:
    lines:
      - ip lan2 nat descriptor 1
      - nat descriptor type 1 masquerade
      - nat descriptor address outer 1 primary
      # Synology DSM
      - nat descriptor masquerade static 1 2001 {{ guppy.ip }} tcp 5000,5010
      - ip filter 2001 pass * {{ guppy.ip }} tcp * 5000,5001
      # HTTP
      - nat descriptor masquerade static 1 2002 {{ guppy.ip }} tcp 80
      - ip filter 2002 pass * {{ guppy.ip }} tcp * 80
      # SSH
      - nat descriptor masquerade static 1 3001 {{ fox.ip }} tcp 22
      - ip filter 3001 pass * {{ fox.ip }} tcp * 22
      # Zabbix
      - nat descriptor masquerade static 1 3002 {{ fox.ip }} tcp 10050
      - ip filter 3002 pass * {{ fox.ip }} tcp * 10050
      # HTTPS
      - nat descriptor masquerade static 1 3003 {{ fox.ip }} tcp 443
      - ip filter 3003 pass * {{ fox.ip }} tcp * 443
      # Mosquitto over SSL
      - nat descriptor masquerade static 1 3004 {{ fox.ip }} tcp 8883
      - ip filter 3004 pass * {{ fox.ip }} tcp * 8883
      # SSH
      - nat descriptor masquerade static 1 4001 {{ hotel.ip }} tcp 55022
      - ip filter 4001 pass * {{ hotel.ip }} tcp * 55022
      # Zabbix
      - nat descriptor masquerade static 1 4002 {{ hotel.ip }} tcp 15050
      - ip filter 4002 pass * {{ hotel.ip }} tcp * 15050
  tags: [rtx, rtx-port]

# Ref: http://www.rtpro.yamaha.co.jp/RT/docs/l2tp_ipsec/
- name: Set L2TP/IPsec 1
  rtx_config:
    parents:
      - pp select anonymous
    lines:
      - pp bind tunnel1
      - pp auth request mschap-v2
      - pp auth username {{ ipsec.username }} {{ ipsec.password }}
      - ppp ipcp ipaddress on
      - ppp ipcp msext on
      - ip pp remote address pool dhcp
      - ip pp mtu 1258
      - pp enable anonymous
  tags: [rtx, rtx-l2tp]

- name: Set L2TP/IPsec 2
  rtx_config:
    parents:
      - tunnel select 1
    lines:
      - tunnel encapsulation l2tp
      - ip tunnel tcp mss limit auto
      - tunnel enable 1
      - ipsec tunnel 1
      - ipsec sa policy 1 1 esp aes-cbc sha-hmac
      - ipsec ike keepalive use 1 off
      - ipsec ike local address 1 {{ lan1.ip }}
      - ipsec ike nat-traversal 1 on
      - ipsec ike pre-shared-key 1 text {{ ipsec.pre_shared_key }}
      - ipsec ike remote address 1 any
      - l2tp tunnel disconnect time off
      - l2tp keepalive use on 10 3
      - l2tp keepalive log on
      - l2tp syslog on
  tags: [rtx, rtx-l2tp]

- name: Set L2TP/IPsec 3
  rtx_config:
    lines:
      - nat descriptor masquerade static 1 101 {{ lan1.ip }} esp
      - nat descriptor masquerade static 1 102 {{ lan1.ip }} udp 500,4500
      - ip filter 101 pass * {{ lan1.ip }} esp
      - ip filter 102 pass * {{ lan1.ip }} udp 500,1701,4500
      - ipsec transport 1 1 udp 1701
      - ipsec auto refresh on
      - l2tp service on
  tags: [rtx, rtx-l2tp]
