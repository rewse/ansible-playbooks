---
# - name: Set up SSH
#   do_it_yourself_rtx_config:
#     lines:
#       - login user username password
#       - sshd host key generate
#       - sshd service on

- name: Set login
  rtx_config:
    lines:
      - login timer 3600
  tags: [rtx, rtx-login]

- name: Set security
  rtx_config:
    lines:
      - security class 2 on off off
  tags: [rtx, rtx-security]

- name: Set console
  rtx_config:
    lines:
      - console character ascii
      - console lines infinity
      - console prompt [{{ rtx.hostname }}]
  tags: [rtx, rtx-console]

- name: Set ip
  rtx_config:
    lines:
      - ip route default gateway {{ default_gateway.ip }}
      - ip keepalive 1 icmp-echo 10 5 {{ default_gateway.ip }}
      - ip lan1 address {{ lan1.ip }}/{{ lan1.netmask }}
      - ip lan1 proxyarp on
      - ip lan2 address {{ lan2.ip }}/{{ lan2.netmask }}
  tags: [rtx, rtx-ip]

- name: Set syslog
  rtx_config:
    lines:
      - syslog host {{ fox.ip }}
      - syslog execute command on
  tags: [rtx, rtx-syslog]

- name: Set telnet
  rtx_config:
    lines:
      - telnetd host lan1
  tags: [rtx, rtx-telnet]

- name: Set dns
  rtx_config:
    lines:
      - dns server {{ resolved1.ip }} {{ resolved2.ip }}
      - dns server select 100 {{ resolved1.ip }} {{ resolved2.ip }} any .
  tags: [rtx, rtx-dns]

- name: Set schedule
  rtx_config:
    lines:
      - schedule at 100 */* 04:52:16 * ntpdate {{ ntpd.fqdn }} syslog
  tags: [rtx, rtx-schedule]

- name: Set httpd
  rtx_config:
    lines:
      - httpd host lan1
  tags: [rtx, rtx-httpd]

- name: Set sshd
  rtx_config:
    lines:
      - sshd host lan1
  tags: [rtx, rtx-sshd]

- name: Set ip interface secure filter
  rtx_config:
    lines:
      - ip lan1 secure filter in 100000 100001 100002 100003 100004 100005 100006 100007 100099
      - ip lan2 secure filter in 101 102 2001 2002 3001 3002 3003 3004 4001 4002 101003 101020 101021 101022 101023 101024 101025 101030 101032 101080 101081 101082 101083
      - ip lan2 secure filter out 101013 101020 101021 101022 101023 101024 101025 101026 101027 101099 dynamic 101080 101081 101082 101083 101084 101085 101098 101099
  tags: [rtx, rtx-port]

- name: Open ports
  rtx_config:
    lines:
      - ip lan2 nat descriptor 1
      - nat descriptor type 1 masquerade
      - nat descriptor address outer 1 primary
      # Synology DSM
      - nat descriptor masquerade static 1 2001 {{ guppy.ip }} tcp 5000,5010
      - ip filter 2001 pass * {{ guppy.ip }} tcp * 5000,5001
      # HTTP
      - nat descriptor masquerade static 1 2002 {{ guppy.ip }} tcp 80
      - ip filter 2002 pass * {{ guppy.ip }} tcp * 80
      # SSH
      - nat descriptor masquerade static 1 3001 {{ fox.ip }} tcp 22
      - ip filter 3001 pass * {{ fox.ip }} tcp * 22
      # Zabbix
      - nat descriptor masquerade static 1 3002 {{ fox.ip }} tcp 10050
      - ip filter 3002 pass * {{ fox.ip }} tcp * 10050
      # HTTPS
      - nat descriptor masquerade static 1 3003 {{ fox.ip }} tcp 443
      - ip filter 3003 pass * {{ fox.ip }} tcp * 443
      # Mosquitto over SSL
      - nat descriptor masquerade static 1 3004 {{ fox.ip }} tcp 8883
      - ip filter 3004 pass * {{ fox.ip }} tcp * 8883
      # SSH
      - nat descriptor masquerade static 1 4001 {{ hotel.ip }} tcp 55022
      - ip filter 4001 pass * {{ hotel.ip }} tcp * 55022
      # Zabbix
      - nat descriptor masquerade static 1 4002 {{ hotel.ip }} tcp 15050
      - ip filter 4002 pass * {{ hotel.ip }} tcp * 15050
  tags: [rtx, rtx-port]

# Ref: http://www.rtpro.yamaha.co.jp/RT/docs/l2tp_ipsec/
- name: Set L2TP/IPsec 1
  rtx_config:
    parents:
      - pp select anonymous
    lines:
      - pp bind tunnel1
      - pp auth request mschap-v2
      - pp auth username {{ ipsec.username }} {{ ipsec.password }}
      - ppp ipcp ipaddress on
      - ppp ipcp msext on
      - ip pp remote address pool {{ ipsec.ip }}
      - ip pp mtu 1258
      - pp enable anonymous
  tags: [rtx, rtx-l2tp]

- name: Set L2TP/IPsec 2
  rtx_config:
    parents:
      - tunnel select 1
    lines:
      - tunnel encapsulation l2tp
      - ip tunnel tcp mss limit auto
      - tunnel enable 1
      - ipsec tunnel 1
      - ipsec sa policy 1 1 esp aes-cbc sha-hmac
      - ipsec ike keepalive use 1 off
      - ipsec ike local address 1 {{ lan1.ip }}
      - ipsec ike nat-traversal 1 on
      - ipsec ike pre-shared-key 1 text {{ ipsec.pre_shared_key }}
      - ipsec ike remote address 1 any
      - l2tp tunnel disconnect time off
      - l2tp keepalive use on 10 3
      - l2tp keepalive log on
      - l2tp syslog on
  tags: [rtx, rtx-l2tp]

- name: Set L2TP/IPsec 3
  rtx_config:
    lines:
      - nat descriptor masquerade static 1 101 {{ lan1.ip }} esp
      - nat descriptor masquerade static 1 102 {{ lan1.ip }} udp 500,4500
      - ip filter 101 pass * {{ lan1.ip }} esp
      - ip filter 102 pass * {{ lan1.ip }} udp 500,1701,4500
      - ipsec transport 1 1 udp 1701
      - ipsec auto refresh on
      - l2tp service on
  tags: [rtx, rtx-l2tp]
