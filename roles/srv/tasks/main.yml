---
- name: create vgsrv
  lvg:
    vg: vgsrv
    pvs: /dev/xvdc
  ignore_errors: True
  tags: [srv, strorage, lvm]

- name: create vgsrv/www
  lvol:
    vg: vgsrv
    lv: www
    size: 6g
  ignore_errors: True
  tags: [srv, lvm, httpd]

- name: format vgsrv/www
  filesystem:
    fstype: xfs
    dev: /dev/vgsrv/www
  ignore_errors: True
  tags: [srv, lvm, httpd]

- name: mount to /srv/www
  mount:
    name: /srv/www
    src: /dev/vgsrv/www
    fstype: xfs
    state: "{{item}}"
  with_items:
    - present
    - mounted
  ignore_errors: True
  tags: [srv, lvm, httpd]

- name: create /var/www link
  file:
    src: /srv/www
    dest: /var/www
    state: link
  tags: [srv, httpd]

- name: create vgsrv/mailman
  lvol:
    vg: vgsrv
    lv: mailman
    size: 20m
  ignore_errors: True
  tags: [srv, lvm, mailman]

- name: format vgsrv/mailman
  filesystem:
    fstype: xfs
    dev: /dev/vgsrv/mailman
  ignore_errors: True
  tags: [srv, lvm, mailman]

- name: mount to /srv/mailman
  mount:
    name: /srv/mailman
    src: /dev/vgsrv/mailman
    fstype: xfs
    state: "{{item}}"
  with_items:
    - present
    - mounted
  ignore_errors: True
  tags: [srv, lvm, mailman]

- name: create /srv/mailman/etc dir
  file:
    path: /srv/mailman/etc
    state: directory
    owner: mailman
    group: mailman
    mode: 0775
  tags: [srv, mailman]

- name: create /etc/mailman link
  file:
    src: /srv/mailman/etc
    dest: /etc/mailman
    state: link
  tags: [srv, mailman]

- name: create /srv/mailman/var dir
  file:
    path: /srv/mailman/var
    state: directory
    owner: mailman
    group: mailman
    mode: 0775
  tags: [srv, mailman]

- name: create /var/lib/mailman link
  file:
    src: /srv/mailman/var
    dest: /var/lib/mailman
    state: link
  tags: [srv, mailman]

- name: create vgsrv/mail
  lvol:
    vg: vgsrv
    lv: mail
    size: 6g
  ignore_errors: True
  tags: [srv, lvm, postfix]

- name: format vgsrv/mail
  filesystem:
    fstype: xfs
    dev: /dev/vgsrv/mail
  ignore_errors: True
  tags: [srv, lvm, postfix]

- name: mount to /srv/mail
  mount:
    name: /srv/mail
    src: /dev/vgsrv/mail
    fstype: xfs
    state: "{{item}}"
  with_items:
    - present
    - mounted
  ignore_errors: True
  tags: [srv, lvm, postfix]

- name: create groups
  group:
    name: "{{item.key}}"
    gid: "{{item.value.gid}}"
  with_dict: "{{users}}"
  tags: [srv, postfix]

- name: create users
  user:
    name: "{{item.key}}"
    uid: "{{item.value.uid}}"
    group: "{{item.key}}"
    comment: "{{item.value.comment}}"
    shell: "{{item.value.shell}}"
  with_dict: "{{users}}"
  tags: [srv, postfix]

- name: make mail user dir
  file:
    path: /srv/mail/{{item.key}}
    state: directory
    owner: "{{item.key}}"
    group: "{{item.key}}"
    mode: 0700
  with_dict: "{{users}}"
  tags: [srv, postfix]

- name: make mail user link
  file:
    src: /srv/mail/{{item.key}}
    dest: /home/{{item.key}}/Maildir
    state: link
    owner: "{{item.key}}"
    group: "{{item.key}}"
  with_dict: "{{users}}"
  tags: [srv, postfix]