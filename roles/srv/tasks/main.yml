---
- name: create vgsrv
  lvg:
    vg: vgsrv
    pvs: /dev/xvdc
  tags: [srv, strorage, lvm]

- name: create vgsrv/www
  lvol:
    vg: vgsrv
    lv: www
    size: 4g
  tags: [srv, lvm, httpd]

- name: format vgsrv/www
  filesystem:
    fstype: xfs
    dev: /dev/vgsrv/www
  tags: [srv, lvm, httpd]

- name: mount to /srv/www
  mount:
    name: /srv/www
    src: /dev/vgsrv/www
    fstype: xfs
    state: "{{item}}"
  with_items:
    - present
    - mounted
  tags: [srv, lvm, httpd]

- name: create /var/www link
  file:
    src: /srv/www
    dest: /var/www
    state: link
  tags: [srv, httpd]

- name: create vgsrv/mailman
  lvol:
    vg: vgsrv
    lv: mailman
    size: 20m
  tags: [srv, lvm, mailman]

- name: format vgsrv/mailman
  filesystem:
    fstype: xfs
    dev: /dev/vgsrv/mailman
  tags: [srv, lvm, mailman]

- name: mount to /srv/mailman
  mount:
    name: /srv/mailman
    src: /dev/vgsrv/mailman
    fstype: xfs
    state: "{{item}}"
  with_items:
    - present
    - mounted
  tags: [srv, lvm, mailman]

- name: create /srv/mailman/etc dir
  file:
    path: /srv/mailman/etc
    state: directory
    owner: mailman
    group: mailman
    mode: 0775
  tags: [srv, mailman]

- name: create /etc/mailman link
  file:
    src: /srv/mailman/etc
    dest: /etc/mailman
    state: link
  tags: [srv, mailman]

- name: create /srv/mailman/var dir
  file:
    path: /srv/mailman/var
    state: directory
    owner: mailman
    group: mailman
    mode: 0775
  tags: [srv, mailman]

- name: create /var/lib/mailman link
  file:
    src: /srv/mailman/var
    dest: /var/lib/mailman
    state: link
  tags: [srv, mailman]

- name: create vgsrv/mail
  lvol:
    vg: vgsrv
    lv: mail
    size: 4g
  tags: [srv, lvm, postfix]

- name: format vgsrv/mail
  filesystem:
    fstype: xfs
    dev: /dev/vgsrv/mail
  tags: [srv, lvm, postfix]

- name: mount to /srv/mail
  mount:
    name: /srv/mail
    src: /dev/vgsrv/mail
    fstype: xfs
    state: "{{item}}"
  with_items:
    - present
    - mounted
  tags: [srv, lvm, postfix]

- name: create groups
  group:
    name: "{{item.key}}"
    gid: "{{item.value.gid}}"
  with_dict: "{{users}}"
  tags: [srv, postfix]

- name: create users
  user:
    name: "{{item.key}}"
    uid: "{{item.value.uid}}"
    group: "{{item.key}}"
    comment: "{{item.value.comment}}"
    shell: "{{item.value.shell}}"
  with_dict: "{{users}}"
  tags: [srv, postfix]

- name: make mail user dir
  file:
    path: /srv/mail/{{item.key}}
    state: directory
    owner: "{{item.key}}"
    group: "{{item.key}}"
    mode: 0700
  with_dict: "{{users}}"
  tags: [srv, postfix]

- name: make mail user link
  file:
    src: /srv/mail/{{item.key}}
    dest: /home/{{item.key}}/Maildir
    state: link
    owner: "{{item.key}}"
    group: "{{item.key}}"
  with_dict: "{{users}}"
  tags: [srv, postfix]

- name: install packages
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - lsyncd
  tags: [srv, lsyncd, package]

- name: copy rsyncd.conf
  template:
    src: rsyncd.conf.j2
    dest: /etc/rsyncd.conf
  notify: restart rsyncd
  tags: [srv, lsyncd]

- name: create rsyncd log
  file:
    path: /var/log/rsyncd.log
    state: touch
    mode: 0600
  tags: [srv, lsyncd]

- name: copy logrotate.d/rsyncd
  copy:
    src: rsyncd
    dest: /etc/logrotate.d
  tags: [srv, lsyncd]

- name: create /var/log/lsyncd
  file:
    path: /var/log/lsyncd
    state: directory
    mode: 0700
  tags: [srv, lsyncd]

- name: create lsyncd logs
  file:
    path: /var/log/lsyncd/{{item}}
    state: touch
    mode: 0600
  with_items:
    - lsyncd.log
    - lsyncd.status
  tags: [srv, lsyncd]

- name: copy lsyncd.conf
  template:
    src: lsyncd.conf.j2
    dest: /etc/lsyncd.conf
  notify: restart lsyncd
  tags: [srv, lsyncd]

- name: set fs.inotify.max_user_watches
  sysctl:
    name: fs.inotify.max_user_watches
    value: 100000
    sysctl_file: /etc/sysctl.d/lsyncd.conf
  tags: [srv, lsyncd]

- name: enable rsyncd
  service:
    name: rsyncd
    enabled: yes
    state: started
  tags: [srv, lsyncd]

- name: enable lsyncd
  service:
    name: lsyncd
    enabled: yes
    state: started
  tags: [srv, lsyncd]
