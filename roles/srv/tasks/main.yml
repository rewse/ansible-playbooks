---
- name: create vgsrv
  lvg:
    vg: vgsrv
    pvs: /dev/xvdc
  tags: [srv, strorage, lvm]

- name: create vgsrv/mail
  lvol:
    vg: vgsrv
    lv: mail
    size: 4g
  tags: [srv, lvm, postfix]

- name: format vgsrv/mail
  filesystem:
    fstype: xfs
    dev: /dev/vgsrv/mail
  tags: [srv, lvm, postfix]

- name: mount to /srv/mail
  mount:
    name: /srv/mail
    src: /dev/vgsrv/mail
    fstype: xfs
    state: "{{item}}"
  with_items:
    - present
    - mounted
  tags: [srv, lvm, postfix]

- name: create groups
  group:
    name: "{{item.key}}"
    gid: "{{item.value.gid}}"
  with_dict: "{{users}}"
  tags: [srv, lvm, postfix]

- name: create users
  user:
    name: "{{item.key}}"
    uid: "{{item.value.uid}}"
    group: "{{item.key}}"
    comment: "{{item.value.comment}}"
    shell: "{{item.value.shell}}"
  with_dict: "{{users}}"
  tags: [srv, lvm, postfix]

- name: make mail user dir
  file:
    path: /srv/mail/{{item.key}}
    state: directory
    owner: "{{item.key}}"
    group: "{{item.key}}"
    mode: 0700
  with_dict: "{{users}}"
  tags: [srv, lvm, postfix]

- name: make mail user link
  file:
    src: /srv/mail/{{item.key}}
    dest: /home/{{item.key}}/Maildir
    state: link
    owner: "{{item.key}}"
    group: "{{item.key}}"
  with_dict: "{{users}}"
  tags: [srv, lvm, postfix]

- name: install packages
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - lsyncd
  tags: [srv, lsyncd, package]

- name: copy rsyncd.conf
  template:
    src: rsyncd.conf.j2
    dest: /etc/rsyncd.conf
  notify: restart rsyncd
  tags: [srv, lsyncd]

- name: create rsyncd log
  file:
    path: /var/log/rsyncd.log
    state: touch
    mode: 0600
  tags: [srv, lsyncd]

- name: copy logrotate.d/rsyncd
  copy:
    src: rsyncd
    dest: /etc/logrotate.d
  tags: [srv, lsyncd]

- name: create /var/log/lsyncd
  file:
    path: /var/log/lsyncd
    state: directory
    mode: 0700
  tags: [srv, lsyncd]

- name: create lsyncd logs
  file:
    path: /var/log/lsyncd/{{item}}
    state: touch
    mode: 0600
  with_items:
    - lsyncd.log
    - lsyncd.status
  tags: [srv, lsyncd]

- name: copy lsyncd.conf
  template:
    src: lsyncd.conf.j2
    dest: /etc/lsyncd.conf
  notify: restart lsyncd
  tags: [srv, lsyncd]

- name: set fs.inotify.max_user_watches
  sysctl:
    name: fs.inotify.max_user_watches
    value: 100000
    sysctl_file: /etc/sysctl.d/lsyncd.conf
  tags: [srv, lsyncd]

- name: enable rsyncd
  service:
    name: rsyncd
    enabled: yes
    state: started
  tags: [srv, lsyncd]

- name: enable lsyncd
  service:
    name: lsyncd
    enabled: yes
    state: started
  tags: [srv, lsyncd]

- name: create .aws dir
  file:
    path: /root/.aws
    state: directory
  tags: [srv, snapshot]

- name: create .aws/config
  file:
    path: /root/.aws/config
    state: touch
    mode: 0600
  tags: [srv, snapshot]

- name: Set aws configure
  ini_file:
    dest: /root/.aws/config
    section: default
    option: region
    value: ap-northeast-1
  tags: [srv, snapshot]

- name: clone aws-ec2-smart-snapshot
  git:
    repo: git@github.com:rewse/aws-ec2-smart-snapshot.git
    dest: /srv/git/aws-ec2-smart-snapshot
    accept_hostkey: yes
    key_file: /home/{{admin}}/.ssh/id_rsa
  tags: [srv, snapshot]

- name: change mode of git/dotfiles
  file:
    path: /srv/git/aws-ec2-smart-snapshot
    owner: "{{admin}}"
    group: "{{admin}}"
    recurse: yes
  tags: [srv, snapshot]

- name: copy aws-ec2-smart-snapshot
  copy:
    src: /srv/git/aws-ec2-smart-snapshot{{item}}
    dest: "{{item}}"
    remote_src: yes
  with_items:
    - /usr/local/sbin/aws-ec2-smart-snapshot
    - /etc/cron.daily/00-aws-ec2-smart-snapshot.cron
    - /etc/logrotate.d/aws-ec2-smart-snapshot
  tags: [srv, snapshot]

- name: change perm of aws-ec2-smart-snapshot
  file:
    path: "{{item}}"
    mode: 0775
  with_items:
    - /usr/local/sbin/aws-ec2-smart-snapshot
    - /etc/cron.daily/00-aws-ec2-smart-snapshot.cron
  tags: [srv, snapshot]

- name: create log/aws-ec2-smart-snapshot.log
  file:
    path: /var/log/aws-ec2-smart-snapshot.log
    state: touch
    mode: 0600
  tags: [srv, snapshot]
