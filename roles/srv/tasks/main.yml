---
- name: create vgsrv
  lvg:
    vg: vgsrv
    pvs: /dev/xvdc
  tags: [srv, strorage, lvm]

- name: create vgsrv/mail
  lvol:
    vg: vgsrv
    lv: mail
    size: 4g
  tags: [srv, lvm, postfix]

- name: format vgsrv/mail
  filesystem:
    fstype: xfs
    dev: /dev/vgsrv/mail
  tags: [srv, lvm, postfix]

- name: mount to /srv/mail
  mount:
    name: /srv/mail
    src: /dev/vgsrv/mail
    fstype: xfs
    state: "{{item}}"
  with_items:
    - present
    - mounted
  tags: [srv, lvm, postfix]

- name: create groups
  group:
    name: "{{item.key}}"
    gid: "{{item.value.gid}}"
  with_dict: "{{users}}"
  tags: [srv, lvm, postfix]

- name: create users
  user:
    name: "{{item.key}}"
    uid: "{{item.value.uid}}"
    group: "{{item.key}}"
    comment: "{{item.value.comment}}"
    shell: "{{item.value.shell}}"
  with_dict: "{{users}}"
  tags: [srv, lvm, postfix]

- name: make mail user dir
  file:
    path: /srv/mail/{{item.key}}
    state: directory
    owner: "{{item.key}}"
    group: "{{item.key}}"
    mode: 0700
  with_dict: "{{users}}"
  tags: [srv, lvm, postfix]

- name: install packages
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - lsyncd
  tags: [srv, lsyncd, package]

- name: copy rsyncd.conf
  template:
    src: rsyncd.conf.j2
    dest: /etc/rsyncd.conf
  notify: restart rsyncd
  tags: [srv, lsyncd]

- name: create rsyncd log
  file:
    path: /var/log/rsyncd.log
    state: touch
    mode: 0600
  tags: [srv, lsyncd]

- name: copy logrotate.d/rsyncd
  copy:
    src: rsyncd
    dest: /etc/logrotate.d
  tags: [srv, lsyncd]

- name: create /var/log/lsyncd
  file:
    path: /var/log/lsyncd
    state: directory
    mode: 0700
  tags: [srv, lsyncd]

- name: create lsyncd logs
  file:
    path: /var/log/lsyncd/{{item}}
    state: touch
    mode: 0600
  with_items:
    - lsyncd.log
    - lsyncd.status
  tags: [srv, lsyncd]

- name: copy lsyncd.conf
  template:
    src: lsyncd.conf.j2
    dest: /etc/lsyncd.conf
  notify: restart lsyncd
  tags: [srv, lsyncd]

  # Do not use sysctl module because it adds to /etc/sysctl.conf diretly.
- name: set fs.inotify.max_user_watches
  lineinfile:
    dest: /etc/sysctl.d/lsyncd.conf
    regexp: 'fs.inotify.max_user_watches '
    line: 'fs.inotify.max_user_watches = 100000'
    create: yes
  register: set_fsinotify_out
  tags: [srv, lsyncd]

- name: reload sysctl
  command: sysctl -p
  when: set_fsinotify_out|changed
  tags: [srv, lsyncd]

- name: enable rsyncd
  service:
    name: rsyncd
    enabled: yes
    state: started
  tags: [srv, lsyncd]

- name: enable lsyncd
  service:
    name: lsyncd
    enabled: yes
    state: started
  tags: [srv, lsyncd]
