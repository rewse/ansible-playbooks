#!/usr/bin/env bash
#
# MHZ-19 CO2 sensor data publisher to MQTT
#

set -euo pipefail

readonly VENV_PATH="/opt/mhz19"
readonly MQTT_HOST="hass.rewse.jp"
readonly MQTT_PORT="1883"
readonly MQTT_USER="pub_client"
readonly MQTT_PASS="[% mosquitto_password %]"
readonly TOPIC_BASE="mhz19/[% location %]"

PATH="${VENV_PATH}/bin:${PATH}"

cleanup() {
  local exit_code=$?
  exit "${exit_code}"
}

trap cleanup EXIT
trap 'exit 1' INT TERM HUP

publish_mqtt() {
  local topic="$1"
  local message="$2"

  mosquitto_pub -r -t "${topic}" \
    -u "${MQTT_USER}" -P "${MQTT_PASS}" \
    -h "${MQTT_HOST}" -p "${MQTT_PORT}" \
    -m "${message}"
}

send_co2() {
  local co2
  local datetime

  co2=$(python3 -m mh_z19 --pwm | grep -oP "(?<='co2': )\d+")

  if [[ -z "${co2}" ]]; then
    publish_mqtt "${TOPIC_BASE}/state" "offline"
    return 1
  fi

  publish_mqtt "${TOPIC_BASE}/state" "online"

  datetime=$(date --iso-8601=seconds)

  publish_mqtt "${TOPIC_BASE}/co2" "{\"datetime\":\"${datetime}\",\"co2\":${co2}}"
}

main() {
  send_co2
}

main "$@"
