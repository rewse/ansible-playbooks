---
- name: set timezone
  timezone:
    name: Asia/Tokyo
  tags: [common, time]

- name: check swap status
  command: cat /proc/swaps
  register: swaps_out
  changed_when: False
  tags: [common, storage, swap]

- name: make swap
  command: mkswap /dev/{{swap_device_name}}
  when: swaps_out.stdout.find('{{swap_device_name}}') == -1
  tags: [common, storage, swap]

- name: enable swap
  command: swapon /dev/{{swap_device_name}}
  when: swaps_out.stdout.find('{{swap_device_name}}') == -1
  tags: [common, storage, swap]

- name: add swap into fstab
  mount:
    name: swap
    src: /dev/{{swap_device_name}}
    fstype: swap
    opts: default
    state: present
  tags: [common, storage, swap]

- name: install additional packages
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - at
    - bash-completion
    - bc
    - bind-utils
    - dstat
    - epel-release
    - git
    - logwatch
    - mlocate
    - net-tools
    - nfs-utils
    - patch
    - prelink
    - selinux-policy-devel
    - setroubleshoot-server
    - source-highlight
    - sysstat
    - telnet
    - tmux
    - tree
    - unzip
    - vim-enhanced
    - yum-cron
    - yum-plugin-priorities
  tags: [common, package]

- name: install additional packages from EPEL
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - etckeeper
  tags: [common, epel, package]

- name: install zabbix-release
  yum:
    name: "{{zabbix_release_url}}"
    state: installed
  tags: [common, package, zabbix]

- name: install zabbix clients
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - zabbix-agent
    - zabbix-sender
  tags: [common, package, zabbix]

- name: download get-pip.py
  get_url:
    url: https://bootstrap.pypa.io/get-pip.py
    dest: /tmp
  tags: [common, package, pip]

- name: run get-pip.py
  command: python /tmp/get-pip.py
  tags: [common, package, pip]

- name: install packages with pip
  pip:
    name: "{{item}}"
  with_items:
    - awscli
  tags: [common, package, pip]

- name: update all packages
  yum:
    name: '*'
    state: latest
  tags: [common, package]

- name: etckeeper; init /etc
  command: etckeeper init
  args:
      creates: /etc/.git
  tags: [common, etckeeper]

- name: etckeeper; Initial commit
  command: etckeeper commit "Initial commit"
  args:
    chdir: /etc
    creates: /etc/.git/logs
  tags: [common, etckeeper]

- name: add priority into /etc/yum.repos.d/CentOS-Base.repo
  ini_file:
    dest: /etc/yum.repos.d/CentOS-Base.repo
    section: "{{item}}"
    option: priority
    value: 10
    no_extra_spaces: True
  with_items:
    - base
    - updates
    - extras
  tags: [common, package]

- name: add priority into /etc/yum.repos.d/zabbix.repo
  ini_file:
    dest: /etc/yum.repos.d/zabbix.repo
    section: "{{item}}"
    option: priority
    value: 30
    no_extra_spaces: True
  with_items:
    - zabbix
    - zabbix-non-supported
  tags: [common, package, zabbix]

- name: add priority into /etc/yum.repos.d/epel.repo
  ini_file:
    dest: /etc/yum.repos.d/epel.repo
    section: epel
    option: priority
    value: 50
    no_extra_spaces: True
  tags: [common, epel, package]

- name: disable the unnecessary services
  service:
    name: "{{item}}"
    enabled: no
    state: stopped
  with_items:
    - firewalld
    - kdump
    - sysstat
  tags: [common, package]

- name: postfix; change myorigin
  lineinfile:
    dest: /etc/postfix/main.cf
    insertafter: '^#myorigin'
    regexp: '^myorigin'
    line: 'myorigin = rewse.jp'
  notify: reload postfix
  tags: [common, mail, postfix]

- name: postfix; change relayhost
  lineinfile:
    dest: /etc/postfix/main.cf
    insertafter: '^#relayhost'
    regexp: '^relayhost'
    line: 'relayhost = [{{relayhost.name}}]:{{relayhost.port}}'
  notify: reload postfix
  tags: [common, mail, postfix]

- name: postfix; support sasl
  blockinfile:
    dest: /etc/postfix/main.cf
    content: |
      smtp_sasl_auth_enable = yes
      smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
      smtp_sasl_security_options = noplaintext, noanonymous
  notify: reload postfix
  tags: [common, mail, postfix]

- name: postfix; create sasl_passwd
  lineinfile:
    dest: /etc/postfix/sasl_passwd
    regexp: '^\[{{relayhost.name}}\]:{{relayhost.port}}'
    line: '[{{relayhost.name}}]:{{relayhost.port}} {{so_net.username}}:{{so_net.password}}'
    create: yes
    mode: 0600
  register: postfix_sasl_password_res
  tags: [common, mail, postfix]

- name: postfix; create sasl_passwd.db
  file:
    path: /etc/postfix/sasl_passwd.db
    state: file
    mode: 0600
  tags: [common, mail, postfix]

- name: postfix; hash sasl_passwd
  command: postmap hash:/etc/postfix/sasl_passwd
  when: postfix_sasl_password_res|changed
  notify: reload postfix
  tags: [common, mail, postfix]

- name: install sasl packages
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - cyrus-sasl-md5
    - cyrus-sasl-plain
  notify: restart postfix
  tags: [common, mail, postfix]

- name: anacron; change start_hours_range
  lineinfile:
    dest: /etc/anacrontab
    insertafter: '^#START_HOURS_RANGE'
    regexp: '^START_HOURS_RANGE'
    line: 'START_HOURS_RANGE=3-7'
  tags: [common, anacron]

- name: cloud-init; add preserve_hostname
  lineinfile:
    dest: /etc/cloud/cloud.cfg
    insertbefore: '^# vim:syntax'
    regexp: '^preserve_hostname'
    line: 'preserve_hostname: true'
  tags: [common, cloud-init]

- name: create journal dir
  file:
    path: /var/log/journal
    state: directory
    group: systemd-journal
    mode: 02755
  tags: [common, journal]

- name: logwatch; disable all services
  lineinfile:
    dest: /usr/share/logwatch/default.conf/logwatch.conf
    insertbefore: '^# You can also disable'
    regexp: '^#? ?Service = All'
    line: '# Service = All'
  tags: [common, logwatch]

- name: logwatch; enable yum
  lineinfile:
    dest: /usr/share/logwatch/default.conf/logwatch.conf
    insertafter: '^#Service = pam'
    regexp: '^Service = yum'
    line: 'Service = yum'
  tags: [common, logwatch]

- name: rsyslog; add a template
  template:
    src: rsyslog.conf.j2
    dest: /etc/rsyslog.d/00-template.conf
  notify: restart rsyslog
  tags: [common, rsyslog]

- name: remove selinux samples
  file:
    path: /usr/share/selinux/devel/{{item}}
    state: absent
  with_items:
    - example.fc
    - example.if
    - example.te
  tags: [common, selinux]

- name: setroubleshoot; set email
  lineinfile:
    dest: /var/lib/setroubleshoot/email_alert_recipients
    regexp: "{{email.secondary}}"
    line: "{{email.secondary}}"
    create: yes
  notify: restart dbus
  tags: [common, setroubleshoot]

- name: setroubleshoot; change sender email
  ini_file:
    dest: /etc/setroubleshoot/setroubleshoot.conf
    section: email
    option: from_address
    value: SELinux_Troubleshoot@rewse.jp
  notify: restart dbus
  tags: [common, setroubleshoot]

- name: ssh; change ClientAliveInterval
  lineinfile:
    dest: /etc/ssh/sshd_config
    insertafter: '^#ClientAliveInterval'
    regexp: '^ClientAliveInterval'
    line: 'ClientAliveInterval 59'
  notify: restart sshd
  tags: [common, ssh]

- name: ssh; change ServerAliveInterval
  lineinfile:
    dest: /etc/ssh/ssh_config
    regexp: '^.*ServerAliveInterval'
    line: '  ServerAliveInterval 59'
  tags: [common, ssh]

- name: add NTP servers
  blockinfile:
    dest: /etc/chrony.conf
    insertafter: '^# Please consider joining the pool'
    content: |
      server ntp.nict.jp iburst
      server ntp.jst.mfeed.ad.jp iburst
      server ats1.e-timing.ne.jp iburst
  notify: restart chronyd
  tags: [common, time, chrony]

- name: yum-cron; enable auto-update
  ini_file:
    dest: /etc/yum/yum-cron.conf
    section: commands
    option: apply_updates
    value: yes
  notify: restart yum-cron
  tags: [common, yum-cron]

- name: yum-cron; enable yum-cron
  service:
    name: yum-cron
    enabled: yes
  notify: restart yum-cron
  tags: [common, yum-cron]

- name: zabbix; set zabbix server
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.conf
    regexp: 'Server='
    line: 'Server={{zabbix_server_name}}'
  notify: restart zabbix-agent
  tags: [common, zabbix-agent]

- name: zabbix; set zabbix server active
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.conf
    regexp: 'ServerActive='
    line: 'ServerActive={{zabbix_server_name}}'
  notify: restart zabbix-agent
  tags: [common, zabbix-agent]

- name: zabbix; set hostname
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.conf
    regexp: 'Hostname='
    line: 'Hostname={{ansible_nodename}}'
  notify: restart zabbix-agent
  tags: [common, zabbix-agent]

- name: zabbix; add centos7.conf
  blockinfile:
    dest: /etc/zabbix/zabbix_agentd.d/centos7.conf
    content: |
      UserParameter=vfs.dev.util[*],iostat -xk 5 2 | grep $1 | tail -1 | awk '{print $$14}'
      UserParameter=proc.top[*],top c -b -n 1 -w 512 | sed 's/ *$//' | sed -n '7,17p'
      UserParameter=postfix.queue.num,echo "(`mailq | wc -l` - 2) / 3" | bc
      UserParameter=journal[*],journalctl -p $1 -n 10 | tac
    create: yes
  tags: [common, zabbix-agent]

- name: zabbix; rm userparameter_mysql.conf
  file:
    path: /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf
    state: absent
  notify: restart zabbix-agent
  tags: [common, zabbix-agent]

- name: change permission of /var/log/messages
  file:
    path: /var/log/messages
    group: zabbix
    mode: 0640
  tags: [common, zabbix-agent]

- name: allow sudo to zabbix
  lineinfile:
    dest: /etc/sudoers.d/zabbix
    regexp: '^zabbix'
    line: 'zabbix ALL=(ALL) NOPASSWD: /usr/bin/journalctl'
    create: yes
    mode: 0440
    validate: 'visudo -cf %s'
  tags: [common, zabbix-agent]

- name: add zabbix to systemd-journal group
  user:
    name: zabbix
    groups: 'zabbix,systemd-journal'
  notify: restart zabbix-agent
  tags: [common, zabbix-agent]

- name: copy zabbix-agent.te
  copy:
    src: my-zabbix-agent.te
    dest: /usr/share/selinux/devel
  tags: [common, selinux, zabbix-agent]

- name: rebuild selinux-policy
  command: make
  args:
    chdir: /usr/share/selinux/devel
  tags: [common, selinux, zabbix-agent]

- name: install my-zabbix-agent selinux module
  command: semodule -i /usr/share/selinux/devel/my-zabbix-agent.pp
  tags: [common, selinux, zabbix-agent]

- name: selinux alllows daemons enable coluster mode
  seboolean:
    name: daemons_enable_cluster_mode
    state: yes
    persistent: yes
  tags: [zabbix-server, selinux, zabbix-agent]

- name: zabbix; enable zabbix-agent
  service:
    name: zabbix-agent
    enabled: yes
  notify: restart zabbix-agent
  tags: [common, zabbix-agent]

- name: add a group for admin user
  group:
    name: "{{admin}}"
    gid: 1001
  tags: [common, user]

- name: add admin user
  user:
    name: "{{admin}}"
    uid: 1001
    group: "{{admin}}"
    groups: 'adm,wheel,systemd-journal'
    skeleton: /etc/skel
  tags: [common, user]

- name: allow sudo to admin user
  lineinfile:
    dest: /etc/sudoers.d/00-{{admin}}
    regexp: '^{{admin}}'
    line: '{{admin}} ALL=(ALL) NOPASSWD: ALL'
    create: yes
    mode: 0440
    validate: 'visudo -cf %s'
  tags: [common, user]

- name: make .ssh dir for admin user
  file:
    path: /home/{{admin}}/.ssh
    owner: "{{admin}}"
    group: "{{admin}}"
    state: directory
    mode: 0700
  tags: [common, user]

- name: copy authorized_keys
  copy:
    src: /home/centos/.ssh/authorized_keys
    dest: /home/{{admin}}/.ssh/authorized_keys
    remote_src: True
    owner: "{{admin}}"
    group: "{{admin}}"
    mode: 0600
  tags: [common, user]

- name: copy id_rsa
  become_user: "{{admin}}"
  copy:
    src: ~/.ssh/id_rsa
    dest: /home/{{admin}}/.ssh/id_rsa
    mode: 0600
    follow: yes
  tags: [common, user]

- name: copy id_rsa.pub
  become_user: "{{admin}}"
  copy:
    src: ~/.ssh/id_rsa.pub
    dest: /home/{{admin}}/.ssh/id_rsa.pub
    follow: yes
  tags: [common, user]

- name: create .ssh/config
  blockinfile:
    dest: /home/{{admin}}/.ssh/config
    content: |
      Host rewse.jp
        User {{ssh.rewse_jp.username}}
        Port {{ssh.rewse_jp.port}}
    create: yes
    owner: "{{admin}}"
    group: "{{admin}}"
  tags: [common, user]

- name: clone dotfiles.git
  git:
    repo: git@github.com:rewse/dotfiles.git
    dest: /srv/git/dotfiles
    accept_hostkey: yes
    key_file: /home/{{admin}}/.ssh/id_rsa
  tags: [common, dotfiles]

- name: change mode of git/dotfiles
  file:
    path: /srv/git/dotfiles
    owner: "{{admin}}"
    group: "{{admin}}"
    recurse: yes
  tags: [common, dotfiles]

- name: copy bash_profile
  copy:
    src: /srv/git/dotfiles/bash_profile
    dest: /etc/profile.d/bash_profile.sh
    remote_src: True
  tags: [common, dotfiles, bash]

- name: copy bashrc
  copy:
    src: /srv/git/dotfiles/bashrc
    dest: /etc/profile.d/bashrc.sh
    remote_src: True
  tags: [common, dotfiles, bash]

- name: copy gitconfig
  become_user: "{{admin}}"
  copy:
    src: /srv/git/dotfiles/gitconfig
    dest: /home/{{admin}}/.gitconfig
    remote_src: True
  tags: [common, dotfiles, git]

- name: git; set user email
  become_user: "{{admin}}"
  ini_file:
    dest: /home/{{admin}}/.gitconfig
    section: user
    option: email
    value: "{{email}}"
  tags: [common, dotfiles, git]

- name: copy inputrc
  become_user: "{{admin}}"
  copy:
    src: /srv/git/dotfiles/inputrc
    dest: /home/{{admin}}/.inputrc
    remote_src: True
  tags: [common, dotfiles, inputrc]

- name: tmux; copy tmux.conf
  copy:
    src: /srv/git/dotfiles/tmux.conf
    dest: /etc/tmux.conf
    remote_src: True
  tags: [common, dotfiles, tmux]

- name: vim; copy vimfiles
  copy:
    src: /srv/git/dotfiles/vim/{{item}}
    dest: /usr/share/vim/vimfiles/{{item}}
    remote_src: True
  with_items:
    - colors/base16-tomorrow.vim
    - ftplugin/python_match.vim
    - plugin/matrix.vim
    - plugin/NERD_commenter.vim
    - vimrc
  tags: [common, dotifiles, vim]

- name: vim; add to import vimrc
  lineinfile:
    dest: /etc/vimrc
    line: 'source /usr/share/vim/vimfiles/vimrc'
  tags: [common, dotifiles, vim]
