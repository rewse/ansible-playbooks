---
- name: set timezone
  timezone:
    name: Asia/Tokyo
  tags: [time]

- name: check swap status
  command: cat /proc/swaps
  register: swaps_out
  changed_when: False
  tags: [storage, swap]

- name: make swap
  command: mkswap /dev/{{swap_device_name}}
  when: swaps_out.stdout.find('{{swap_device_name}}') == -1
  tags: [storage, swap]

- name: enable swap
  command: swapon /dev/{{swap_device_name}}
  when: swaps_out.stdout.find('{{swap_device_name}}') == -1
  tags: [storage, swap]

- name: add swap into fstab
  mount:
    name: swap
    src: /dev/{{swap_device_name}}
    fstype: swap
    opts: default
    state: present
  tags: [storage, swap]

- name: install additional packages
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - at
    - bash-completion
    - bc
    - bind-utils
    - dstat
    - epel-release
    - git
    - logwatch
    - mlocate
    - net-tools
    - nfs-utils
    - patch
    - prelink
    - selinux-policy-devel
    - setroubleshoot-server
    - source-highlight
    - sysstat
    - telnet
    - tmux
    - tree
    - unzip
    - vim-enhanced
    - yum-cron
    - yum-plugin-priorities
  tags: [package]

- name: install additional packages from EPEL
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - etckeeper
  tags: [package]

- name: install zabbix-release
  yum:
    name: "{{zabbix_release_url}}"
    state: installed
  tags: [package, zabbix]

- name: install zabbix clients
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - zabbix-agent
    - zabbix-sender
  tags: [package, zabbix]

- name: update all packages
  yum:
    name: '*'
    state: latest
  tags: [package]

- name: etckeeper; init /etc
  command: etckeeper init
  args:
      creates: /etc/.git
  tags: [package]

- name: etckeeper; Initial commit
  command: etckeeper commit "Initial commit"
  args:
    chdir: /etc
    creates: /etc/.git/logs
  tags: [package]

- name: add priority into /etc/yum.repos.d/CentOS-Base.repo
  ini_file:
    dest: /etc/yum.repos.d/CentOS-Base.repo
    section: "{{item}}"
    option: priority
    value: 10
    no_extra_spaces: True
  with_items:
    - base
    - updates
    - extras
  tags: [package]

- name: add priority into /etc/yum.repos.d/zabbix.repo
  ini_file:
    dest: /etc/yum.repos.d/zabbix.repo
    section: "{{item}}"
    option: priority
    value: 30
    no_extra_spaces: True
  with_items:
    - zabbix
    - zabbix-non-supported
  tags: [package, zabbix]

- name: add priority into /etc/yum.repos.d/epel.repo
  ini_file:
    dest: /etc/yum.repos.d/epel.repo
    section: epel
    option: priority
    value: 50
    no_extra_spaces: True
  tags: [package]

- name: disable the unnecessary services
  service:
    name: "{{item}}"
    enabled: no
    state: stopped
  with_items:
    - kdump
    - sysstat
  tags: [package]

- name: postfix; change myorigin
  lineinfile:
    dest: /etc/postfix/main.cf
    insertafter: '^#myorigin'
    regexp: '^myorigin'
    line: 'myorigin = rewse.jp'
  notify: reload postfix
  tags: [mail]

- name: postfix; change relayhost
  lineinfile:
    dest: /etc/postfix/main.cf
    insertafter: '^#relayhost'
    regexp: '^relayhost'
    line: 'relayhost = [{{relayhost.name}}]:{{relayhost.port}}'
  notify: reload postfix
  tags: [mail]

- name: postfix; support sasl
  blockinfile:
    dest: /etc/postfix/main.cf
    content: |
      smtp_sasl_auth_enable = yes
      smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
      smtp_sasl_security_options = noplaintext, noanonymous
  notify: reload postfix
  tags: [mail]

- name: postfix; create sasl_passwd
  lineinfile:
    dest: /etc/postfix/sasl_passwd
    regexp: '^\[{{relayhost.name}}\]:{{relayhost.port}}'
    line: '[{{relayhost.name}}]:{{relayhost.port}} {{so_net.username}}:{{so_net.password}}'
    create: yes
    mode: 0600
  register: postfix_sasl_password_res
  tags: [mail]

- name: postfix; create sasl_passwd.db
  file:
    path: /etc/postfix/sasl_passwd.db
    state: touch
    mode: 0600
  tags: [mail]

- name: postfix; hash sasl_passwd
  command: postmap /etc/postfix/sasl_passwd
  when: postfix_sasl_password_res|changed
  notify: reload postfix
  tags: [mail]

- name: install sasl packages
  yum:
    name: "{{item}}"
    state: installed
  with_items:
    - cyrus-sasl-md5
    - cyrus-sasl-plain
  notify: restart postfix
  tags: [mail]

- name: anacron; change start_hours_range
  lineinfile:
    dest: /etc/anacrontab
    insertafter: '^#START_HOURS_RANGE'
    regexp: '^START_HOURS_RANGE'
    line: 'START_HOURS_RANGE=3-7'
  tags: [anacron]

- name: cloud-init; add preserve_hostname
  lineinfile:
    dest: /etc/cloud/cloud.cfg
    insertbefore: '^# vim:syntax'
    regexp: '^preserve_hostname'
    line: 'preserve_hostname: true'
  tags: [cloudinit]

- name: logwatch; disable all services
  lineinfile:
    dest: /usr/share/logwatch/default.conf/logwatch.conf
    insertbefore: '^# You can also disable'
    regexp: '^#? ?Service = All'
    line: '# Service = All'
  tags: [logwatch]

- name: logwatch; enable yum
  lineinfile:
    dest: /usr/share/logwatch/default.conf/logwatch.conf
    insertafter: '^#Service = pam'
    regexp: '^Service = yum'
    line: 'Service = yum'
  tags: [logwatch]

- name: rsyslog; add a template
  template:
    src: rsyslog.conf.j2
    dest: /etc/rsyslog.d/00-template.conf
  notify: restart rsyslog
  tags: [rsyslog]

- name: ssh; change ClientAliveInterval
  lineinfile:
    dest: /etc/ssh/sshd_config
    insertafter: '^#ClientAliveInterval'
    regexp: '^ClientAliveInterval'
    line: 'ClientAliveInterval 59'
  notify: restart sshd
  tags: [ssh]

- name: ssh; change ServerAliveInterval
  lineinfile:
    dest: /etc/ssh/ssh_config
    regexp: '^.*ServerAliveInterval'
    line: '  ServerAliveInterval 59'
  tags: [ssh]

- name: add NTP servers
  blockinfile:
    dest: /etc/chrony.conf
    insertafter: '^# Please consider joining the pool'
    content: |
      server ntp.nict.jp iburst
      server ntp.jst.mfeed.ad.jp iburst
      server ats1.e-timing.ne.jp iburst
  notify: restart chronyd
  tags: [time, chrony]

- name: yum-cron; enable auto-update
  ini_file:
    dest: /etc/yum/yum-cron.conf
    section: commands
    option: apply_updates
    value: yes
  notify: restart yum-cron
  tags: [yum-cron]

- name: yum-cron; enable yum-cron
  service:
    name: yum-cron
    enabled: yes
  notify: restart yum-cron
  tags: [yum-cron]

- name: zabbix; set zabbix server
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.d/common.conf
    regexp: '^Server='
    line: 'Server={{zabbix_server_name}}'
    create: yes
  notify: restart zabbix-agent
  tags: [zabbix]

- name: zabbix; set zabbix server active
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.d/common.conf
    regexp: '^ServerActive='
    line: 'ServerActive={{zabbix_server_name}}'
    create: yes
  notify: restart zabbix-agent
  tags: [zabbix]

- name: zabbix; set hostname
  lineinfile:
    dest: /etc/zabbix/zabbix_agentd.d/common.conf
    regexp: '^Hostname='
    line: 'Hostname={{ansible_fqdn}}'
    create: yes
  notify: restart zabbix-agent
  tags: [zabbix]

- name: zabbix; rm userparameter_mysql.conf
  file:
    path: /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf
    state: absent
  notify: restart zabbix-agent
  tags: [zabbix]

- name: zabbix; enable zabbix-agent
  service:
    name: zabbix-agent
    enabled: yes
  notify: restart zabbix-agent
  tags: [zabbix]

- name: add a group for admin user
  group:
    name: "{{admin}}"
    gid: 1001
  tags: [user]

- name: add admin user
  user:
    name: "{{admin}}"
    uid: 1001
    group: "{{admin}}"
    groups: 'adm,wheel,systemd-journal'
    skeleton: /etc/skel
  tags: [user]

- name: allow sudo to admin user
  lineinfile:
    dest: /etc/sudoers.d/00-{{admin}}
    regexp: '^{{admin}}'
    line: '{{admin}} ALL=(ALL) NOPASSWD:ALL'
    create: yes
    mode: 0440
    validate: 'visudo -cf %s'
  tags: [user]

- name: make .ssh dir for admin user
  file:
    path: /home/{{admin}}/.ssh
    owner: "{{admin}}"
    group: "{{admin}}"
    state: directory
    mode: 0700
  tags: [user]

- name: copy authorized_keys
  copy:
    src: /home/centos/.ssh/authorized_keys
    dest: /home/{{admin}}/.ssh/authorized_keys
    remote_src: True
    owner: "{{admin}}"
    group: "{{admin}}"
    mode: 0600
  tags: [user]

- name: copy id_rsa
  copy:
    src: ~/.ssh/id_rsa
    dest: /home/{{admin}}/.ssh/id_rsa
    owner: "{{admin}}"
    group: "{{admin}}"
    mode: 0600
    follow: yes
  tags: [user]

- name: copy id_rsa.pub
  copy:
    src: ~/.ssh/id_rsa.pub
    dest: /home/{{admin}}/.ssh/id_rsa.pub
    owner: "{{admin}}"
    group: "{{admin}}"
    follow: yes
  tags: [user]

- name: create .ssh/config
  blockinfile:
    dest: /home/{{admin}}/.ssh/config
    content: |
      rewse.jp
        User {{ssh.rewse_jp.username}}
        Port {{ssh.rewse_jp.port}}
    create: yes
    owner: "{{admin}}"
    group: "{{admin}}"
  tags: [user]

- name: clone dotfiles.git
  git:
    repo: git@github.com:rewse/dotfiles.git
    dest: /srv/git/dotfiles
    accept_hostkey: yes
    key_file: /home/{{admin}}/.ssh/id_rsa
  tags: [dotfiles]

- name: change mode of git/dotfiles
  file:
    path: /srv/git/dotfiles
    owner: "{{admin}}"
    group: "{{admin}}"
    recurse: yes
  tags: [dotfiles]

- name: copy bash_profile
  copy:
    src: /srv/git/dotfiles/bash_profile
    dest: /etc/profile.d/bash_profile.sh
    remote_src: True
  tags: [dotfiles, bash]

- name: copy bashrc
  copy:
    src: /srv/git/dotfiles/bashrc
    dest: /etc/profile.d/bashrc.sh
    remote_src: True
  tags: [dotfiles, bash]

- name: copy gitconfig
  copy:
    src: /srv/git/dotfiles/gitconfig
    dest: /home/{{admin}}/.gitconfig
    remote_src: True
    owner: "{{admin}}"
    group: "{{admin}}"
  tags: [dotfiles, git]

- name: git; set user email
  ini_file:
    dest: /home/{{admin}}/.gitconfig
    section: user
    option: email
    value: "{{email}}"
  tags: [dotfiles, git]

- name: copy inputrc
  copy:
    src: /srv/git/dotfiles/inputrc
    dest: /home/{{admin}}/.inputrc
    remote_src: True
    owner: "{{admin}}"
    group: "{{admin}}"
  tags: [dotfiles, inputrc]

- name: tmux; copy tmux.conf
  copy:
    src: /srv/git/dotfiles/tmux.conf
    dest: /etc/tmux.conf
    remote_src: True
  tags: [dotfiles, tmux]

- name: vim; copy vimfiles
  copy:
    src: /srv/git/dotfiles/vim/{{item}}
    dest: /usr/share/vim/vimfiles/{{item}}
    remote_src: True
  with_items:
    - colors/base16-tomorrow.vim
    - ftplugin/python_match.vim
    - plugin/matrix.vim
    - plugin/NERD_commenter.vim
    - vimrc
  tags: [dotifiles, vim]

- name: vim; add to import vimrc
  lineinfile:
    dest: /etc/vimrc
    line: 'source /usr/share/vim/vimfiles/vimrc'
  tags: [dotifiles, vim]
