---
- name: "package : Install packages by homebrew"
  community.general.homebrew:
    name: 
      - 1password-cli
      - ansible
      - awscli
      - bat
      - coreutils
      - direnv
      - fping
      - gh
      - gnu-sed
      - git-cliff
      - jq
      - mas
      - node
      - osv-scanner
      - pandoc
      - php
      - podman
      - pv
      - pwgen
      - python3
      - pyright
      - switchaudio-osx
      - svn
      - telnet
      - tree
      - typescript-language-server
      - uv
      - watch
      - zsh-vi-mode
    update_homebrew: true
  tags:
    - darwin
    - install
    - package
    - darwin_package
    - darwin_package_install

- name: "package : Install packages by homebrew_cask"
  community.general.homebrew_cask:
    name: 
      - 1password
      - adobe-creative-cloud
      - alfred
      - amazon-chime
      - appcleaner
      - arc
      - atok
      - calibre
      - calibrite-profiler
      - corretto
      - cyberduck
      - firefox
      - fantastical
      - font-hackgen
      - font-new-york
      - font-sf-compact
      - font-sf-mono
      - font-sf-mono-for-powerline
      - font-sf-pro
      - font-source-sans-3
      - font-source-serif-4
      - geekbench
      - ghostty
      - gnucash
      - google-chrome
      - grandperspective
      - handbrake
      - hhkb
      - istat-menus
      - jordanbaird-ice
      - karabiner-elements
      - keka
      - kekaexternalhelper
      - keyboard-maestro
      - keycastr
      - lm-studio
      - messenger
      - obsidian
      - popclip
      - prowritingaid
      - rectangle-pro
      - slack
      - steermouse
      - sf-symbols
      - visual-studio-code
      - vlc
      - zoom
    update_homebrew: true
  tags:
    - darwin
    - install
    - package
    - darwin_package
    - darwin_package_install

- name: "package: Install Claude Code"
  ansible.builtin.shell: curl -fsSL https://claude.ai/install.sh | bash
  args:
    creates: ~/.local/bin/claude
  tags:
    - darwin
    - install
    - package
    - darwin_package
    - darwin_package_install
  
- name: "package: Install global npm packages"
  ansible.builtin.command: npm install -g {{ item }}
  loop:
    - agent-browser
    - "@playwright/mcp@latest"
  tags:
    - darwin
    - install
    - package
    - darwin_package
    - darwin_package_install

- name: "package: Fix agent-browser binary permissions"
  ansible.builtin.file:
    path: /opt/homebrew/lib/node_modules/agent-browser/bin/agent-browser-darwin-arm64
    mode: '0755'
  tags:
    - darwin
    - install
    - package
    - darwin_package
    - darwin_package_install

- name: "package: Install Chrome for agent-browser"
  ansible.builtin.command: agent-browser install
  tags:
    - darwin
    - install
    - package
    - darwin_package
    - darwin_package_install

- name: "package : Install package by uv"
  ansible.builtin.command: uv tool install {{ item }}
  loop:
    - docling
    - homeassistant-cli
  tags:
    - darwin
    - install
    - package
    - darwin_package
    - darwin_package_install

# Note: If this task fails with "sudo: a terminal is required to read the password" error,
# some casks require sudo password for upgrade. In such cases, run `brew upgrade` manually
# in the terminal.
- name: "package : Upgrade all homebrew packages"
  community.general.homebrew:
    upgrade_all: true
  tags:
    - darwin
    - upgrade
    - package
    - darwin_package
    - darwin_package_upgrade

- name: "package : Remove invalid npm global package-lock file"
  ansible.builtin.file:
    path: /opt/homebrew/lib/node_modules/.package-lock.json
    state: absent
  ignore_errors: true
  tags:
    - darwin
    - upgrade
    - package
    - darwin_package
    - darwin_package_upgrade

- name: "package : Update global npm packages"
  ansible.builtin.command: npm update -g
  tags:
    - darwin
    - upgrade
    - package
    - darwin_package
    - darwin_package_upgrade

- name: "package : Upgrade all uv tools"
  ansible.builtin.command: uv tool upgrade --all
  tags:
    - darwin
    - upgrade
    - package
    - darwin_package
    - darwin_package_upgrade

- name: "package : Install packages by mas"
  ansible.builtin.command: mas install {{ item }}
  loop:
    - 302584613   # Amazon Kindle
    - 545519333   # Amazon Prime Video
    - 1168254295  # AmorphousDiskMark
    - 425264550   # Blackmagic Disk Speed Test
    - 1044629456  # GFXBench Metal
    - 1099568401  # Home Assistant
    - 539883307   # LINE
    - 981430153   # Online
    - 1436994560  # Portal
    - 1187772509  # stts
    - 899247664   # TestFlight
    - 494803304   # WiFi Explorer
    - 1295203466  # Windows App
    - 1451685025  # WireGuard
    - 497799835   # Xcode
    - 1380563956  # 辞書 by 物書堂
  ignore_errors: true
  tags:
    - darwin
    - install
    - package
    - darwin_package
    - darwin_package_install

- name: "font : Create directory"
  ansible.builtin.file:
    path: /Library/Fonts/Adobe
    state: directory
  tags:
    - darwin
    - init
    - font
    - darwin_font
    - darwin_font_init

- name: "font : Download source-han-mono"
  ansible.builtin.get_url:
    url: https://github.com/adobe-fonts/source-han-mono/releases/download/{{ source_han_mono_version }}/SourceHanMono.ttc
    dest: /Library/Fonts/Adobe
  tags:
    - darwin
    - install
    - font
    - darwin_font
    - darwin_font_install
    - darwin_font_download

- name: "font : Download source-han-sans"
  ansible.builtin.unarchive:
    src: https://github.com/adobe-fonts/source-han-sans/releases/download/{{ source_han_sans_version }}/SourceHanSans.ttc.zip
    dest: /Library/Fonts/Adobe
    remote_src: true
  tags:
    - darwin
    - install
    - font
    - darwin_font
    - darwin_font_install
    - darwin_font_download

- name: "font : Download source-han-serif"
  ansible.builtin.unarchive:
    src: https://github.com/adobe-fonts/source-han-serif/releases/download/{{ source_han_serif_version }}/01_SourceHanSerif.ttc.zip
    dest: /Library/Fonts/Adobe
    remote_src: true
  tags:
    - darwin
    - install
    - font
    - darwin_font
    - darwin_font_install
    - darwin_font_download

- name: "security : Install Aikido Safe Chain"
  ansible.builtin.shell: |
    curl -fsSL https://raw.githubusercontent.com/AikidoSec/safe-chain/main/install-scripts/install-safe-chain.sh | sh -s -- --include-python
  tags:
    - darwin
    - install
    - security
    - darwin_security
    - darwin_security_install

# Note: This task requires sudo password. Run the playbook with -K or --ask-become-pass option.
# Example: ansible-playbook darwin-personal.yml --ask-become-pass
- name: "path : Copy path configurations"
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /etc/paths.d/{{ item }}
    mode: '0644'
  become: true
  loop:
    - homebrew
    - local
  tags:
    - darwin
    - config
    - path
    - darwin_path
    - darwin_path_config

# - name: "package : Install rest of the apps"
#   install_yourself:
#     - https://www.blackmagicdesign.com/jp/products/davinciresolve/  # DaVinci Resolve
#     - https://www.insta360.com/download/insta360-link2c             # Insta360 Link Controller
#     - https://www.ireasoning.com/mibbrowser.shtml                   # MIB Browser
#     - https://prowritingaid.com/everywhere-download-mac             # ProWritingAid Everywhere
#     - https://github.com/SAP/power-monitoring-tool-for-macos        # SAP Power Monitor
#     - https://www.xencelabs.com/support/download-drivers/           # Xencelabs Driver
