---
- hosts: centos
  become: yes
  remote_user: centos
  vars:
    swap_device: xvdb
    zabbix_servername: zabbix.rewse.jp
  vars_files:
    - vault.yml
  tasks:
    - name: set timezone
      timezone:
        name: Asia/Tokyo
      tags: [time]

    - name: check swap status
      command: cat /proc/swaps
      register: swaps_out
      changed_when: False
      tags: [storage, swap]

    - name: make swap
      command: mkswap /dev/{{swap_device}}
      when: swaps_out.stdout.find('{{swap_device}}') == -1
      tags: [storage, swap]

    - name: enable swap
      command: swapon /dev/{{swap_device}}
      when: swaps_out.stdout.find('{{swap_device}}') == -1
      tags: [storage, swap]

    - name: add swap into fstab
      mount:
        name: swap
        src: /dev/{{swap_device}}
        fstype: swap
        opts: default
        state: present
      tags: [storage, swap]

    - name: install additional packages
      yum:
        name: "{{item}}"
        state: installed
      with_items:
        - at
        - bash-completion
        - bc
        - bind-utils
        - dstat
        - epel-release
        - git
        - logwatch
        - mlocate
        - net-tools
        - nfs-utils
        - patch
        - prelink
        - selinux-policy-devel
        - setroubleshoot-server
        - source-highlight
        - sysstat
        - telnet
        - tmux
        - tree
        - unzip
        - vim-enhanced
        - yum-cron
        - yum-plugin-priorities
      tags: [package]

    - name: install additional packages from EPEL
      yum:
        name: "{{item}}"
        state: installed
      with_items:
        - etckeeper
      tags: [package]

    - name: install zabbix-release
      yum:
        name: http://repo.zabbix.com/zabbix/3.2/rhel/7/x86_64/zabbix-release-3.2-1.el7.noarch.rpm
        state: present
      tags: [package, zabbix]

    - name: install zabbix clients
      yum:
        name: "{{item}}"
        state: installed
      with_items:
        - zabbix-agent
        - zabbix-sender
      tags: [package, zabbix]

    - name: update all packages
      yum:
        name: '*'
        state: latest
      tags: [package]

    - name: etckeeper; init /etc
      command: etckeeper init
      args:
          creates: /etc/.git
      tags: [package]

    - name: etckeeper; Initial commit
      command: etckeeper commit "Initial commit"
      args:
        chdir: /etc
        creates: /etc/.git/logs
      tags: [package]

    - name: add priority into /etc/yum.repos.d/CentOS-Base.repo
      ini_file:
        dest: /etc/yum.repos.d/CentOS-Base.repo
        section: "{{item}}"
        option: priority
        value: 10
        no_extra_spaces: True
      with_items:
        - base
        - updates
        - extras
      tags: [package]

    - name: add priority into /etc/yum.repos.d/zabbix.repo
      ini_file:
        dest: /etc/yum.repos.d/zabbix.repo
        section: "{{item}}"
        option: priority
        value: 30
        no_extra_spaces: True
      with_items:
        - zabbix
        - zabbix-non-supported
      tags: [package, zabbix]

    - name: add priority into /etc/yum.repos.d/epel.repo
      ini_file:
        dest: /etc/yum.repos.d/epel.repo
        section: epel
        option: priority
        value: 50
        no_extra_spaces: True
      tags: [package]

    - name: disable the unnecessary services
      service:
        name: "{{item}}"
        enabled: no
        state: stopped
      with_items:
        - kdump
        - sysstat
      tags: [package]

    - name: postfix; change myorigin
      lineinfile:
        dest: /etc/postfix/main.cf
        insertafter: '^#myorigin'
        regexp: '^myorigin'
        line: 'myorigin = rewse.jp'
      notify: reload postfix
      tags: [mail]

    - name: postfix; change relayhost
      lineinfile:
        dest: /etc/postfix/main.cf
        insertafter: '^#relayhost'
        regexp: '^relayhost'
        line: 'relayhost = [mail.so-net.ne.jp]:587'
      notify: reload postfix
      tags: [mail]

    - name: postfix; support sasl
      blockinfile:
        dest: /etc/postfix/main.cf
        content: |
          smtp_sasl_auth_enable = yes
          smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
          smtp_sasl_security_options = noplaintext, noanonymous
      notify: reload postfix
      tags: [mail]

    - name: postfix; create sasl_passwd
      lineinfile:
        dest: /etc/postfix/sasl_passwd
        regexp: '^\[mail.so-net.ne.jp\]:587'
        line: '[mail.so-net.ne.jp]:587 {{sonet_username}}:{{sonet_password}}'
        create: yes
      register: postfix_sasl_password_res
      tags: [mail]

    - name: postfix; hash sasl_passwd
      command: postmap /etc/postfix/sasl_passwd
      when: postfix_sasl_password_res|changed
      notify: reload postfix
      tags: [mail]

    - name: install sasl packages
      yum:
        name: "{{item}}"
        state: installed
      with_items:
        - cyrus-sasl-md5
        - cyrus-sasl-plain
      tags: [mail]

    - name: anacron; change start_hours_range
      lineinfile:
        dest: /etc/anacrontab
        insertafter: '^#START_HOURS_RANGE'
        regexp: '^START_HOURS_RANGE'
        line: 'START_HOURS_RANGE=3-7'
      tags: [anacron]

    - name: zabbix; set zabbix server
      lineinfile:
        dest: /etc/zabbix/zabbix_agentd.d/common.conf
        regexp: '^Server='
        line: 'Server={{zabbix_servername}}'
        create: yes
      notify: restart zabbix-agent
      tags: [zabbix]

    - name: zabbix; set zabbix server active
      lineinfile:
        dest: /etc/zabbix/zabbix_agentd.d/common.conf
        regexp: '^ServerActive='
        line: 'ServerActive={{zabbix_servername}}'
        create: yes
      notify: restart zabbix-agent
      tags: [zabbix]

    - name: zabbix; set hostname
      lineinfile:
        dest: /etc/zabbix/zabbix_agentd.d/common.conf
        regexp: '^Hostname='
        line: 'Hostname={{ansible_fqdn}}'
        create: yes
      notify: restart zabbix-agent
      tags: [zabbix]

    - name: zabbix; rm userparameter_mysql.conf
      file:
        path: /etc/zabbix/zabbix_agentd.d/userparameter_mysql.conf
        state: absent
      notify: restart zabbix-agent
      tags: [zabbix]

    - name: zabbix; enable zabbix-agent
      service:
        name: zabbix-agent
        enabled: yes
      notify: restart zabbix-agent
      tags: [zabbix]

    - name: rsyslog; add a template
      blockinfile:
        dest: /etc/rsyslog.d/00-template.conf
        content: |
          $template VerboseTraditionalFileFormat,"%timestamp% <%syslogfacility-text%.%syslogseverity-text%> %hostname% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n"
          $ActionFileDefaultTemplate VerboseTraditionalFileFormat
        create: yes
      notify: restart rsyslog
      tags: [rsyslog]

  handlers:
    - name: reload postfix
      service:
        name: postfix
        state: reloaded

    - name: restart rsyslog
      service:
        name: rsyslog
        state: restarted

    - name: restart zabbix-agent
      service:
        name: zabbix-agent
        state: restarted
